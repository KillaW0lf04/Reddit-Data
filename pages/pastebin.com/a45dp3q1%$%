<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>[PHP] 4chan source - Pastebin.com</title>
		<link rel="shortcut icon" href="/favicon.ico" />
<link href="/cache/css/php.css" rel="stylesheet" type="text/css" />		<link href="/i/main_test.css" rel="stylesheet" type="text/css" />
				
		<script type="text/javascript" src="/js/jquery.js"></script>
		<script type="text/javascript" src="/js/main_v1.js"></script>
		<meta property="fb:app_id" content="231493360234820" />
		<meta property="og:title" content="[PHP] 4chan source - Pastebin.com" />
		<meta property="og:type" content="article" />
	    <meta property="og:url" content="http://pastebin.com/a45dp3q1" />
	    <meta property="og:image" content="http://pastebin.com/i/fb2.jpg" />
	    <meta property="og:site_name" content="Pastebin" />
		<meta name="google-site-verification" content="jkUAIOE8owUXu8UXIhRLB9oHJsWBfOgJbZzncqHoF4A" />
		<link rel="canonical" href="http://pastebin.com/a45dp3q1" />
				<!--[if SafMob]>
			<style>body{-webkit-text-size-adjust:none;}</style>
		<![endif]-->
		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-58643-34']);
		  _gaq.push(['_trackPageview']);
			setTimeout("_gaq.push(['_trackEvent', '15_seconds', 'read'])", 15000);
		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
	</head>
	<body>
	<div id="super_frame">
		<div id="logo" onclick="location.href='/'" title="Create New Paste"></div>
		<div id="header">
			<div id="header_top">
				<span class="span_left more">PASTEBIN</span><span class="span_left less"> &nbsp;|&nbsp; #1 paste tool since 2002</span><span class="min_max_span narrow_it" title="Change layout width"></span><span class="min_max_span wide_it" style="display:none" title="Change layout width"></span>				<ul class="top_menu">
					<li class="no_border_li"><a href="/" accesskey="n">create new paste</a></li><li><a href="/tools">tools</a></li><li><a href="/api">api</a></li><li><a href="/archive">archive</a></li><li><a href="/faq">faq</a></li>
				</ul>
			</div>
			<div id="header_middle">
				<span class="span_left big"><a href="/">PASTEBIN</a></span> 
				<a href="http://twitter.com/pastebin" target="_blank"><img src="/i/t.gif" alt="" class="i_tf" width="122" height="20" border="0" /></a>	<iframe src="//www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.facebook.com%2Fpastebin&amp;send=false&amp;layout=button_count&amp;width=100&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font=segoe+ui&amp;height=21&amp;appId=231493360234820" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:21px;margin:13px 0 0 10px;vertical-align:top" allowTransparency="true"></iframe>
				<div id="header_middle_search">
					<form class="search_form" name="search_form" method="get" action="/search" id="cse-search-box">
					    <input type="hidden" name="cx" value="013305635491195529773:0ufpuq-fpt0" />
					    <input type="hidden" name="cof" value="FORID:10" />
					    <input type="hidden" name="ie" value="UTF-8" />
						<input class="search_input" type="text" name="q" size="5" value="" placeholder="search..." x-webkit-speech/><input name="sa" class="search_button" src="/i/t.gif" alt="Search..." type="image" value="Search" />
					</form>
				</div>					
			</div>
			<div id="header_bottom">
				<div class="div_top_menu">
					<img src="/i/t.gif" class="i_n" width="16" height="16" alt="" border="0" /> <a href="/">create new paste</a> 
					&nbsp;&nbsp;&nbsp; <img src="/i/t.gif" class="i_t" width="16" height="16" alt="" border="0" /> <a href="/trends">trending pastes</a>
				</div>
				<ul class="top_menu">
					<li class="no_border_li"><a href="/signup">sign up</a></li><li><a href="/login">login</a></li><li><a href="/alerts">my alerts</a></li><li><a href="/settings">my settings</a></li><li><a href="/profile">my profile</a></li>				</ul>		
			</div>			
		</div>

			<div class="frame_spacer"><!-- --></div>
			<div style="height:35px;line-height:35px;font-size:0.85em;"><img src="/i/tip.png" width="16" height="16" style="vertical-align:middle;margin:-6px 0 0 2px" alt="" /> Pastebin launched a little side project called <a href="http://veryviral.com/" target="_blank">VERYVIRAL.com</a>, check it out ;-) <span style="float:right;text-align:right;">Want more features on Pastebin? <a href="/signup"><b>Sign Up</b></a>, it's FREE!</span></div>
		<div class="frame_spacer"><!-- --></div>
		<div id="monster_frame">
			<div id="content_frame">
				<div id="content_right">
															<div class="content_right_menu">
									<div class="content_right_title"><a href="/archive">Public Pastes</a></div>	
									<div id="menu_2">
										<ul class="right_menu"><li><a href="/SHSdxmvf">Untitled</a><span>10 sec ago</span></li><li><a href="/dk2ZJJfH">Untitled</a><span>3 sec ago</span></li><li><a href="/Cf7yrxd9">Untitled</a><span>3 sec ago</span></li><li><a href="/aij6TNH8">Untitled</a><span>BrainFuck | 10 sec ago</span></li><li><a href="/6cH7Qcrm">Untitled</a><span>BrainFuck | 11 sec ago</span></li><li><a href="/nHTH6VL9">Untitled</a><span>14 sec ago</span></li><li><a href="/m6gQYWBA">Untitled</a><span>15 sec ago</span></li><li><a href="/NwSU7SY8">Untitled</a><span>27 sec ago</span></li></ul></div></div>					
				<div style="padding: 0; width:160px;margin: 10px 0;clear:left;">
					<script type="text/javascript"><!--
						e9 = new Object();
					    e9.size = "160x600,120x600";
					//--></script>
					<script type="text/javascript" src="http://tags.expo9.exponential.com/tags/Pastebincom/Unsure/tags.js"></script>
				</div>					<div id="steadfast" title="Pastebin is proudly hosted by Steadfast.net" onclick="location.href='http://steadfast.net/?utm_source=pastebin.com&utm_medium=referral&utm_content=hosting_by_banner&utm_campaign=referral_20140118_x_x_pastebin_partner&source=referral_20140118_x_x_pastebin_partner'"></div>
				</div>
				<div id="content_left">

	<div class="paste_box_frame">
		<div class="tweet">


			<div onclick="facebookpopup('/a45dp3q1'); return false;" id="b_facebook2"><span id="b_facebook"></span></div>
			<div onclick="twitpopup('/a45dp3q1'); return false;" id="b_twitter2"><span id="b_twitter"></span></div>

		</div>
		<div class="paste_box_icon">
			<a href="/u/Oloty"><img src="/cache/a/567045.jpg" class="i_gb" width="50" height="50" alt="" border="0" /></a>	
		</div>
		<div class="paste_box_info">
			<div class="paste_box_line1" title="4chan source"><img src="/i/t.gif"  class="i_p0" width="16" height="16" title="Public paste, everybody can see this paste." alt=""  border="0" /><h1>4chan source</h1> </div>
			<div class="paste_box_line2">By: <a href="/u/Oloty">Oloty</a>  on <span title="Friday 17th of January 2014 12:57:29 AM CDT" style="cursor:help;border-bottom: 1px dotted;">Jan 17th, 2014</span> &nbsp;|&nbsp; syntax: <a href="/archive/php">PHP</a> &nbsp;|&nbsp; size: 94.86 KB &nbsp;|&nbsp; views: <span title="Number of unique visitors to this paste" style="cursor:help;border-bottom: 1px dotted;">96,619</span> &nbsp;|&nbsp; expires: Never</div>
			<div class="paste_box_line3"><a href="/download.php?i=a45dp3Q1" rel="nofollow">download</a> &nbsp;|&nbsp; <a href="/raw.php?i=a45dp3Q1" target="_blank" rel="nofollow">raw</a> &nbsp;|&nbsp; <a href="/embed.php?i=a45dp3Q1" rel="nofollow">embed</a> &nbsp;|&nbsp; <a href="/report.php?i=a45dp3Q1" rel="nofollow">report abuse</a> &nbsp;|&nbsp; <a href="/print.php?i=a45dp3Q1" rel="nofollow">print</a></div>
		</div>
	</div>
	
				<div class="banner_728">
					<script type="text/javascript"><!--
						e9 = new Object();
					    e9.size = "728x90";
					//--></script>
					<script type="text/javascript" src="http://tags.expo9.exponential.com/tags/Pastebincom/Unsure/tags.js"></script>
				</div>
				<div class="layout_clear"></div><div id="code_frame2">
	<div id="code_frame">
		<div id="code_buttons">
		
		<a href="javascript:togglev();" title="Show/Hide line numbers"><img src="/i/t.gif" border="0" alt="" class="i16 line" /></a> 
		<a href="javascript:togglew('php');" title="Toggle text wrapping"><img src="/i/t.gif" border="0" alt="" class="i16 wrap" /></a> 
		<a href="#" class="copyme" onclick="selectText('selectable');showdiv('copied');" title="Copy text to clipboard"><img src="/i/t.gif" border="0" alt="" class="i16 clipboard" /></a> <span id="copied">Text below is selected. Please press Ctrl+C to copy to your clipboard. (&#8984;+C on Mac)</span>

		</div>
		<div id="selectable">		
		<div class="php"><ol><li class="li1"><div class="de1"><span class="sy1">&lt;?</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="st_h">'/www/global/lockdown'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_auser'</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_apass'</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span><span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'mode'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="st_h">'usrdel'</span><span class="sy0">||</span><span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'mode'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="st_h">'latest'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ok</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw3">die</span><span class="br0">&#40;</span><span class="st_h">'Posting temporarily disabled. Come back later!&lt;br/&gt;&amp;mdash;Team 4chan (uptime? what\'s that?)'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">include_once</span> <span class="st0">&quot;./yotsuba_config.php&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">include</span><span class="br0">&#40;</span><span class="st0">&quot;./postfilter.php&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">include</span><span class="br0">&#40;</span><span class="st0">&quot;./ads.php&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw3">define</span><span class="br0">&#40;</span><span class="st_h">'SQLLOGBAN'</span><span class="sy0">,</span> <span class="st_h">'banned_users'</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//Table (NOT DATABASE) used for holding banned users</span></div></li>
<li class="li2"><div class="de2"><span class="kw3">define</span><span class="br0">&#40;</span><span class="st_h">'SQLLOGMOD'</span><span class="sy0">,</span> <span class="st_h">'mod_users'</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//Table (NOT DATABASE) used for holding mod users</span></div></li>
<li class="li1"><div class="de1"><span class="kw3">define</span><span class="br0">&#40;</span><span class="st_h">'SQLLOGDEL'</span><span class="sy0">,</span> <span class="st_h">'del_log'</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//Table (NOT DATABASE) used for holding deletion log</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>BOARD_DIR <span class="sy0">==</span> <span class="st_h">'test'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'display_errors'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw3">extract</span><span class="br0">&#40;</span><span class="re0">$_POST</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw3">extract</span><span class="br0">&#40;</span><span class="re0">$_GET</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw3">extract</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="re0">$id</span> <span class="sy0">=</span> <span class="kw3">intval</span><span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">array_key_exists</span><span class="br0">&#40;</span><span class="st_h">'upfile'</span><span class="sy0">,</span><span class="re0">$_FILES</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$upfile_name</span><span class="sy0">=</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;name&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="re0">$upfile</span><span class="sy0">=</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;tmp_name&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$upfile_name</span><span class="sy0">=</span><span class="re0">$upfile</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="re0">$path</span> <span class="sy0">=</span> <span class="kw3">realpath</span><span class="br0">&#40;</span><span class="st0">&quot;./&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">'/'</span><span class="sy0">.</span>IMG_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw3">ignore_user_abort</span><span class="br0">&#40;</span><span class="kw4">TRUE</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>WORD_FILT<span class="sy0">&amp;&amp;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="st0">&quot;wf.php&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">include_once</span><span class="br0">&#40;</span><span class="st0">&quot;wf.php&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">include_once</span> <span class="st_h">'/www/global/plugins/broomcloset.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">//mysql_board_connect();</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">// truncate $str to $max_lines lines and return $str and $abbr</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// where $abbr = whether or not $str was actually truncated</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> abbreviate<span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span><span class="re0">$max_lines</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'MAX_LINES_SHOWN'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'BR_CHECK'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">define</span><span class="br0">&#40;</span><span class="st_h">'MAX_LINES_SHOWN'</span><span class="sy0">,</span> BR_CHECK<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">define</span><span class="br0">&#40;</span><span class="st_h">'MAX_LINES_SHOWN'</span><span class="sy0">,</span> <span class="nu0">20</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$max_lines</span> <span class="sy0">=</span> MAX_LINES_SHOWN<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lines</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;br /&gt;&quot;</span><span class="sy0">,</span> <span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$lines</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="re0">$max_lines</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$abbr</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lines</span> <span class="sy0">=</span> <span class="kw3">array_slice</span><span class="br0">&#40;</span><span class="re0">$lines</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$max_lines</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">=</span> <span class="kw3">implode</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;br /&gt;&quot;</span><span class="sy0">,</span> <span class="re0">$lines</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$abbr</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//close spans after abbreviating</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//XXX will not work with more html - use abbreviate_html from shiichan</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/span&gt;&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&lt;span&quot;</span><span class="br0">&#41;</span> <span class="sy0">-</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&lt;/span&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="re0">$abbr</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">// print $contents to $filename by using a temporary file and renaming it </span></div></li>
<li class="li2"><div class="de2"><span class="co1">// (makes *.html and *.gz if USE_GZIP is on)</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> print_page<span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span><span class="re0">$contents</span><span class="sy0">,</span><span class="re0">$force_nogzip</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$gzip</span> <span class="sy0">=</span> <span class="br0">&#40;</span>USE_GZIP <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$force_nogzip</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tempfile</span> <span class="sy0">=</span> <span class="kw3">tempnam</span><span class="br0">&#40;</span><span class="kw3">realpath</span><span class="br0">&#40;</span>RES_DIR<span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;tmp&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//note: THIS actually creates the file</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">file_put_contents</span><span class="br0">&#40;</span><span class="re0">$tempfile</span><span class="sy0">,</span> <span class="re0">$contents</span><span class="sy0">,</span> FILE_APPEND<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="re0">$tempfile</span><span class="sy0">,</span> <span class="re0">$filename</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">chmod</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span> <span class="nu8">0664</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//it was created 0600</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$gzip</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tempgz</span> <span class="sy0">=</span> <span class="kw3">tempnam</span><span class="br0">&#40;</span><span class="kw3">realpath</span><span class="br0">&#40;</span>RES_DIR<span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;tmp&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//note: THIS actually creates the file</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$gzfp</span> <span class="sy0">=</span> <span class="kw3">gzopen</span><span class="br0">&#40;</span><span class="re0">$tempgz</span><span class="sy0">,</span> <span class="st0">&quot;w&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">gzwrite</span><span class="br0">&#40;</span><span class="re0">$gzfp</span><span class="sy0">,</span> <span class="re0">$contents</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">gzclose</span><span class="br0">&#40;</span><span class="re0">$gzfp</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="re0">$tempgz</span><span class="sy0">,</span> <span class="re0">$filename</span> <span class="sy0">.</span> <span class="st_h">'.gz'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">chmod</span><span class="br0">&#40;</span><span class="re0">$filename</span> <span class="sy0">.</span> <span class="st_h">'.gz'</span><span class="sy0">,</span> <span class="nu8">0664</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//it was created 0600</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> file_get_contents_cached<span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; static <span class="re0">$cache</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$cache</span><span class="br0">&#91;</span><span class="re0">$filename</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$cache</span><span class="br0">&#91;</span><span class="re0">$filename</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$cache[$filename] = file_get_contents($filename);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$cache</span><span class="br0">&#91;</span><span class="re0">$filename</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> blotter_contents<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; static <span class="re0">$cache</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$cache</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$cache</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$topN</span> <span class="sy0">=</span> <span class="nu0">4</span><span class="sy0">;</span> <span class="co1">//how many lines to print</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bl_lines</span> <span class="sy0">=</span> <span class="kw3">file</span><span class="br0">&#40;</span> BLOTTER_PATH <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bl_top</span> <span class="sy0">=</span> <span class="kw3">array_slice</span><span class="br0">&#40;</span><span class="re0">$bl_lines</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$topN</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$date</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$bl_top</span> <span class="kw1">as</span> <span class="re0">$line</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$date</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lineparts</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">' - '</span><span class="sy0">,</span> <span class="re0">$line</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$lineparts</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span><span class="st_h">'&lt;font'</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dateparts</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">'&gt;'</span><span class="sy0">,</span> <span class="re0">$lineparts</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$date</span> <span class="sy0">=</span> <span class="re0">$dateparts</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$date</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;li&gt;&lt;font color=<span class="es1">\&quot;</span>red<span class="es1">\&quot;</span>&gt;Blotter updated: <span class="es4">$date</span>&lt;/font&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$date</span> <span class="sy0">=</span> <span class="re0">$lineparts</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$date</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;li&gt;Blotter updated: <span class="es4">$date</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$line</span> <span class="sy0">=</span> <span class="kw3">trim</span><span class="br0">&#40;</span><span class="re0">$line</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$line</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es1">\\</span>&quot;</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es1">\\</span><span class="es1">\\</span>&quot;</span><span class="sy0">,</span> <span class="re0">$line</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$line</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;'&quot;</span><span class="sy0">,</span> <span class="st0">&quot;\'&quot;</span><span class="sy0">,</span> <span class="re0">$line</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="st0">&quot;'&lt;li&gt;<span class="es4">$line</span>'+<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="st0">&quot;''&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$cache</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$date</span><span class="sy0">,</span><span class="re0">$ret</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$date</span><span class="sy0">,</span><span class="re0">$ret</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">// insert into the rapidsearch queue</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> rapidsearch_insert<span class="br0">&#40;</span><span class="re0">$board</span><span class="sy0">,</span> <span class="re0">$no</span><span class="sy0">,</span> <span class="re0">$body</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$board</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$no</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$no</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$body</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$body</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO rs.rsqueue (`board`,`no`,`ts`,`com`) VALUES ('<span class="es4">$board</span>',<span class="es4">$no</span>,NOW(),'<span class="es4">$body</span>')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> find_match_and_prefix<span class="br0">&#40;</span><span class="re0">$regex</span><span class="sy0">,</span> <span class="re0">$str</span><span class="sy0">,</span> <span class="re0">$off</span><span class="sy0">,</span> <span class="sy0">&amp;</span><span class="re0">$match</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="re0">$regex</span><span class="sy0">,</span> <span class="re0">$str</span><span class="sy0">,</span> <span class="re0">$m</span><span class="sy0">,</span> PREG_OFFSET_CAPTURE<span class="sy0">,</span> <span class="re0">$off</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">FALSE</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$moff</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$match</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="re0">$off</span><span class="sy0">,</span> <span class="re0">$moff</span><span class="sy0">-</span><span class="re0">$off</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">TRUE</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> spoiler_parse<span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>find_match_and_prefix<span class="br0">&#40;</span><span class="st0">&quot;/\[spoiler\]/&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$m</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$com</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bl</span> <span class="sy0">=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="st0">&quot;[spoiler]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="re0">$el</span> <span class="sy0">=</span> <span class="re0">$bl</span><span class="sy0">+</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$st</span> <span class="sy0">=</span> <span class="st_h">'&lt;span class=&quot;spoiler&quot; onmouseover=&quot;this.style.color=\'#FFF\';&quot; onmouseout=&quot;this.style.color=this.style.backgroundColor=\'#000\'&quot; style=&quot;color:#000;background:#000&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$et</span> <span class="sy0">=</span> <span class="st_h">'&lt;/span&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="re0">$st</span><span class="sy0">;</span> <span class="re0">$lev</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$off</span> <span class="sy0">=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="re0">$bl</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>find_match_and_prefix<span class="br0">&#40;</span><span class="st0">&quot;@\[/?spoiler\]@&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="sy0">,</span> <span class="re0">$off</span><span class="sy0">,</span> <span class="re0">$m</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$txt</span><span class="sy0">,</span> <span class="re0">$tag</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="re0">$txt</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$off</span> <span class="sy0">+=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$txt</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$tag</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$tag</span> <span class="sy0">==</span> <span class="st0">&quot;[spoiler]&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="re0">$st</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lev</span><span class="sy0">++;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$lev</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="re0">$et</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lev</span><span class="sy0">--;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="re0">$off</span><span class="sy0">,</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="re0">$off</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ret</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="re0">$et</span><span class="sy0">,</span> <span class="re0">$lev</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$ret</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">//rebuild the bans in array $boards</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> rebuild_bans<span class="br0">&#40;</span><span class="re0">$boards</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$cmd</span> <span class="sy0">=</span> <span class="st0">&quot;nohup /usr/local/bin/suid_run_global bin/rebuildbans <span class="es4">$boards</span> &gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">exec</span><span class="br0">&#40;</span><span class="re0">$cmd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> append_ban<span class="br0">&#40;</span><span class="re0">$board</span><span class="sy0">,</span> <span class="re0">$ip</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$cmd</span> <span class="sy0">=</span> <span class="st0">&quot;nohup /usr/local/bin/suid_run_global bin/appendban <span class="es4">$board</span> <span class="es4">$ip</span> &gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">exec</span><span class="br0">&#40;</span><span class="re0">$cmd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">// check whether the current user can perform $action (on $no, for some actions)</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// board-level access is cached in $valid_cache.</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> valid<span class="br0">&#40;</span><span class="re0">$action</span><span class="sy0">=</span><span class="st_h">'moderator'</span><span class="sy0">,</span> <span class="re0">$no</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; static <span class="re0">$valid_cache</span><span class="sy0">;</span> <span class="co1">// the access level of the user</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$access_level</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'none'</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="st_h">'janitor'</span> <span class="sy0">=&gt;</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="st_h">'janitor_this_board'</span> <span class="sy0">=&gt;</span> <span class="nu0">2</span><span class="sy0">,</span> <span class="st_h">'moderator'</span> <span class="sy0">=&gt;</span> <span class="nu0">5</span><span class="sy0">,</span> <span class="st_h">'manager'</span> <span class="sy0">=&gt;</span> <span class="nu0">10</span><span class="sy0">,</span> <span class="st_h">'admin'</span> <span class="sy0">=&gt;</span> <span class="nu0">20</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$valid_cache</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'none'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_auser'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_apass'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$user</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_auser'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$pass</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_apass'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$user</span><span class="sy0">&amp;&amp;</span><span class="re0">$pass</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_global_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT allow,deny FROM &quot;</span><span class="sy0">.</span>SQLLOGMOD<span class="sy0">.</span><span class="st0">&quot; WHERE username='<span class="es4">$user</span>' and password='<span class="es4">$pass</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$allow</span><span class="sy0">,</span><span class="re0">$deny</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$allow</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$allows</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">','</span><span class="sy0">,</span> <span class="re0">$allow</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$seen_janitor_token</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// each token can increase the access level,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// except that we only know that they're a moderator or a janitor for another board</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// AFTER we read all the tokens</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$allows</span> <span class="kw1">as</span> <span class="re0">$token</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$token</span> <span class="sy0">==</span> <span class="st_h">'janitor'</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$seen_janitor_token</span> <span class="sy0">=</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$token</span> <span class="sy0">==</span> <span class="st_h">'manager'</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$valid_cache</span> <span class="sy0">&lt;</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'manager'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'manager'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$token</span> <span class="sy0">==</span> <span class="st_h">'admin'</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$valid_cache</span> <span class="sy0">&lt;</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'admin'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'admin'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$token</span> <span class="sy0">==</span> BOARD_DIR <span class="sy0">||</span> <span class="re0">$token</span> <span class="sy0">==</span> <span class="st_h">'all'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$valid_cache</span> <span class="sy0">&lt;</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor_this_board'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor_this_board'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="co1">// or could be moderator, will be increased in next step</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// now we can set moderator or janitor status </span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$seen_janitor_token</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$valid_cache</span> <span class="sy0">&lt;</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'moderator'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'moderator'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$valid_cache</span> <span class="sy0">&lt;</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$deny</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$denies</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">','</span><span class="sy0">,</span> <span class="re0">$deny</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">in_array</span><span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span><span class="re0">$denies</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$valid_cache</span> <span class="sy0">=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'none'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">switch</span><span class="br0">&#40;</span><span class="re0">$action</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'moderator'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'moderator'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'textonly'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'moderator'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'janitor_board'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'delete'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor_this_board'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if they're a janitor on another board, check for illegal post unlock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span>mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;SELECT COUNT(*) from reports WHERE board='&quot;</span><span class="sy0">.</span>BOARD_DIR<span class="sy0">.</span><span class="st0">&quot;' AND no=<span class="es4">$no</span> AND cat=2&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$illegal_count</span> <span class="sy0">=</span> <span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$illegal_count</span> <span class="sy0">&gt;=</span> <span class="nu0">3</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'reportflood'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'janitor'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="st_h">'floodbypass'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$valid_cache</span> <span class="sy0">&gt;=</span> <span class="re0">$access_level</span><span class="br0">&#91;</span><span class="st_h">'moderator'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">default</span><span class="sy0">:</span> <span class="co1">// unsupported action</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> sticky_post<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span> <span class="re0">$position</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">;</span> log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$post_sticknum</span><span class="sy0">=</span><span class="st0">&quot;202701010000&quot;</span><span class="sy0">.</span><span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es6">%02d</span>&quot;</span><span class="sy0">,</span><span class="re0">$position</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'root'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$post_sticknum</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'sticky'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'1'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st_h">'UPDATE '</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; SET sticky='1'&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;, root='&quot;</span><span class="sy0">.</span><span class="re0">$post_sticknum</span><span class="sy0">.</span><span class="st0">&quot;'&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot; WHERE no='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> permasage_post<span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">;</span> log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'permasage'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'1'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st_h">'UPDATE '</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; SET permasage='1'&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot; WHERE no='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> rebuildqueue_create_table<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sql</span> <span class="sy0">=</span> <span class="co3">&lt;&lt;&lt;EOSQL</span></div></li>
<li class="li2"><div class="de2"><span class="co3">CREATE TABLE `rebuildqueue` (</span></div></li>
<li class="li1"><div class="de1"><span class="co3">&nbsp; `board` char(4) NOT NULL,</span></div></li>
<li class="li2"><div class="de2"><span class="co3">&nbsp; `no` int(11) NOT NULL,</span></div></li>
<li class="li1"><div class="de1"><span class="co3">&nbsp; `ownedby` int(11) NOT NULL default '0',</span></div></li>
<li class="li2"><div class="de2"><span class="co3">&nbsp; `ts` timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,</span></div></li>
<li class="li1"><div class="de1"><span class="co3">&nbsp; PRIMARY KEY &nbsp;(`board`,`no`,`ownedby`)</span></div></li>
<li class="li2"><div class="de2"><span class="co3">)</span></div></li>
<li class="li1"><div class="de1"><span class="co3">EOSQL</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="re0">$sql</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> rebuildqueue_add<span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$no</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$no</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">&lt;</span><span class="nu0">2</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;INSERT IGNORE INTO rebuildqueue (board,no) VALUES ('<span class="es4">$board</span>','<span class="es4">$no</span>')&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rebuildqueue_create_table<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> rebuildqueue_remove<span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$no</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$no</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">&lt;</span><span class="nu0">2</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;DELETE FROM rebuildqueue WHERE board='<span class="es4">$board</span>' AND no='<span class="es4">$no</span>'&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rebuildqueue_create_table<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> rebuildqueue_take_all<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$uid</span> <span class="sy0">=</span> <span class="kw3">mt_rand</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="sy0">,</span> <span class="kw3">mt_getrandmax</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">&lt;</span><span class="nu0">2</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;UPDATE rebuildqueue SET ownedby=<span class="es4">$uid</span>,ts=ts WHERE board='<span class="es4">$board</span>' AND ownedby=0&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rebuildqueue_create_table<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$q</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT no FROM rebuildqueue WHERE board='<span class="es4">$board</span>' AND ownedby=<span class="es4">$uid</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$posts</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$post</span><span class="sy0">=</span><span class="kw3">mysql_fetch_assoc</span><span class="br0">&#40;</span><span class="re0">$q</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$posts</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$post</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$posts</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> iplog_add<span class="br0">&#40;</span><span class="re0">$board</span><span class="sy0">,</span> <span class="re0">$no</span><span class="sy0">,</span> <span class="re0">$ip</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$board</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$no</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$no</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ip</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$ip</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO iplog (board,no,ip) VALUES ('<span class="es4">$board</span>',<span class="es4">$no</span>,'<span class="es4">$ip</span>')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// build a structure out of all the posts in the database.</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// this lets us replace a LOT of queries with a simple array access.</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// it only builds the first time it was called.</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// rather than calling log_cache(1) to rebuild everything,</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// you should just manipulate the structure directly.</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> log_cache<span class="br0">&#40;</span><span class="re0">$invalidate</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">,</span> <span class="re0">$ipcount</span><span class="sy0">,</span> <span class="re0">$mysql_unbuffered_reads</span><span class="sy0">,</span> <span class="re0">$lastno</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ips</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$threads</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// no's</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$invalidate</span><span class="sy0">==</span><span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// no -&gt; [ data ]</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//mysql_board_call(&quot;SET read_buffer_size=1048576&quot;);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$mysql_unbuffered_reads</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$query = mysql_board_call(&quot;SELECT * FROM &quot;.SQLLOG);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$offset</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lastno</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//while($row = mysql_fetch_assoc($query)) {</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span> <span class="sy0">&gt;</span> <span class="re0">$lastno</span><span class="br0">&#41;</span> <span class="re0">$lastno</span> <span class="sy0">=</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ips</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'host'</span><span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// initialize log row if necessary</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$row</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="co1">// otherwise merge it with $row</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$row</span> <span class="kw1">as</span> <span class="re0">$key</span><span class="sy0">=&gt;</span><span class="re0">$val</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$val</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if this is a reply</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// initialize whatever we need to</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//&nbsp; &nbsp; &nbsp; $log[$row['resto']] = array();</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// add this post to list of children</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'fsize'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'imgreplycount'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'imgreplycount'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'imgreplycount'</span><span class="br0">&#93;</span><span class="sy0">++;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="coMULTI">/*else {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $threads[] = $row['no'];</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }*/</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$query = mysql_board_call(&quot;SELECT no FROM &quot;.SQLLOG.&quot; WHERE root&gt;0 order by root desc&quot;);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_assoc</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$threads</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="st_h">'THREADS'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$threads</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$mysql_unbuffered_reads</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// calculate old-status for PAGE_MAX mode</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>EXPIRE_NEGLECTED <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rsort</span><span class="br0">&#40;</span><span class="re0">$threads</span><span class="sy0">,</span> SORT_NUMERIC<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$threadcount</span> <span class="sy0">=</span> <span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$threads</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>PAGE_MAX <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="co1">// the lowest 5% of maximum threads get marked old</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="kw3">floor</span><span class="br0">&#40;</span><span class="nu19">0.95</span><span class="sy0">*</span>PAGE_MAX<span class="sy0">*</span>PAGE_DEF<span class="br0">&#41;</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$threadcount</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$threads</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'sticky'</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> EXPIRE_NEGLECTED <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$threads</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'old'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="co1">// threads w/numbers below 5% of LOG_MAX get marked old</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$threads</span> <span class="kw1">as</span> <span class="re0">$thread</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$lastno</span><span class="sy0">-</span>LOG_MAX<span class="sy0">*</span><span class="nu19">0.95</span><span class="sy0">&gt;</span><span class="re0">$thread</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$thread</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'sticky'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$thread</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'old'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ipcount</span> <span class="sy0">=</span> <span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$ips</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="co1">//}</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">// deletes a post from the database</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// imgonly: whether to just delete the file or to delete from the database as well</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// automatic: always delete regardless of password/admin (for self-pruning)</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// children: whether to delete just the parent post of a thread or also delete the children</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// die: whether to die on error</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// careful, setting children to 0 could leave orphaned posts.</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> delete_post<span class="br0">&#40;</span><span class="re0">$resno</span><span class="sy0">,</span> <span class="re0">$pwd</span><span class="sy0">,</span> <span class="re0">$imgonly</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$automatic</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$children</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">,</span> <span class="re0">$die</span><span class="sy0">=</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">,</span> <span class="re0">$path</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resno</span> <span class="sy0">=</span> <span class="kw3">intval</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// get post info</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$die</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span><span class="st0">&quot;Can't find the post <span class="es4">$resno</span>.&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="sy0">=</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// check password- if not ok, check admin status (and set $admindel if allowed)</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$delete_ok</span> <span class="sy0">=</span> <span class="br0">&#40;</span> <span class="re0">$automatic</span> <span class="sy0">||</span> <span class="br0">&#40;</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="kw3">md5</span><span class="br0">&#40;</span><span class="re0">$pwd</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">2</span><span class="sy0">,</span><span class="nu0">8</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'pwd'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'host'</span><span class="br0">&#93;</span> <span class="sy0">==</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REMOTE_ADDR'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="br0">&#40;</span><span class="re0">$pwd</span><span class="sy0">==</span>ADMIN_PASS <span class="sy0">||</span> <span class="re0">$pwd</span><span class="sy0">==</span>ADMIN_PASS2<span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$delete_ok</span> <span class="sy0">=</span> <span class="re0">$admindel</span> <span class="sy0">=</span> valid<span class="br0">&#40;</span><span class="st_h">'delete'</span><span class="sy0">,</span> <span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$delete_ok</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_BADDELPASS<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// check ghost bumping</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$admindel</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="re0">$admindel</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>BOARD_DIR <span class="sy0">==</span> <span class="st_h">'a'</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'time'</span><span class="br0">&#93;</span> <span class="sy0">&gt;</span> <span class="br0">&#40;</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">-</span> <span class="nu0">25</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="st_h">'sage'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ghostdump</span> <span class="sy0">=</span> <span class="kw3">var_export</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'server'</span><span class="sy0">=&gt;</span><span class="re0">$_SERVER</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'post'</span><span class="sy0">=&gt;</span><span class="re0">$_POST</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'cookie'</span><span class="sy0">=&gt;</span><span class="re0">$_COOKIE</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'row'</span><span class="sy0">=&gt;</span><span class="re0">$row</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//file_put_contents('ghostbump.'.time(),$ghostdump);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$admindel</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$admindel</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// extra actions for admin user</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$auser</span> <span class="sy0">=</span> <span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_auser'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$adfsize</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'fsize'</span><span class="br0">&#93;</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span>?<span class="nu0">1</span><span class="sy0">:</span><span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$adname</span><span class="sy0">=</span><span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!'</span><span class="sy0">,</span><span class="st_h">'#'</span><span class="sy0">,</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'name'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$imgonly</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$imgonly</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$imgonly</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'sub'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'sub'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'com'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'com'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'filename'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'filename'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO &quot;</span><span class="sy0">.</span>SQLLOGDEL<span class="sy0">.</span><span class="st0">&quot; (imgonly,postno,board,name,sub,com,img,filename,admin) values('<span class="es4">$imgonly</span>','<span class="es4">$resno</span>','&quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot;','<span class="es4">$adname</span>','<span class="es4">{$row['sub']}</span>','<span class="es4">{$row['com']}</span>','<span class="es4">$adfsize</span>','<span class="es4">{$row['filename']}</span>','<span class="es4">$auser</span>')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$children</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$imgonly</span><span class="br0">&#41;</span> <span class="co1">// select thread and children</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select no,resto,tim,ext from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=<span class="es4">$resno</span> or resto=<span class="es4">$resno</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="co1">// just select the post</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select no,resto,tim,ext from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=<span class="es4">$resno</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$delrow</span><span class="sy0">=</span><span class="kw3">mysql_fetch_array</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// delete</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$delfile</span> <span class="sy0">=</span> <span class="re0">$path</span><span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'tim'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'ext'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="co1">//path to delete</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$delthumb</span> <span class="sy0">=</span> THUMB_DIR<span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'tim'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$delfile</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$delfile</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// delete image</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$delthumb</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$delthumb</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// delete thumb</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'tim'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">'.pch'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'tim'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">'.pch'</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// delete oe animation</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$imgonly</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="co1">// delete thread page &amp; log_cache row</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unset</span><span class="br0">&#40;</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unset</span><span class="br0">&#40;</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$log</span><span class="br0">&#91;</span><span class="st_h">'THREADS'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">array_diff</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="st_h">'THREADS'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// remove from THREADS</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;DELETE FROM reports WHERE no=&quot;</span><span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// clear reports</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>USE_GZIP <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span>RES_DIR<span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">.</span>PHP_EXT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span>RES_DIR<span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st_h">'.gz'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span>RES_DIR<span class="sy0">.</span><span class="re0">$delrow</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">.</span>PHP_EXT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//delete from DB</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$children</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$imgonly</span><span class="br0">&#41;</span> <span class="co1">// delete thread and children</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;delete from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=<span class="es4">$resno</span> or resto=<span class="es4">$resno</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$imgonly</span><span class="br0">&#41;</span> <span class="co1">// just delete the post</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;delete from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=<span class="es4">$resno</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="co1">// so the caller can know what pages need to be rebuilt</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">// purge old posts</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// should be called whenever a new post is added.</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> trim_db<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxposts</span> <span class="sy0">=</span> LOG_MAX<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// max threads = max pages times threads-per-page</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxthreads</span> <span class="sy0">=</span> <span class="br0">&#40;</span>PAGE_MAX <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>?<span class="br0">&#40;</span>PAGE_MAX <span class="sy0">*</span> PAGE_DEF<span class="br0">&#41;</span><span class="sy0">:</span><span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// New max-page method</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$maxthreads</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exp_order</span> <span class="sy0">=</span> <span class="st_h">'no'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>EXPIRE_NEGLECTED <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="re0">$exp_order</span> <span class="sy0">=</span> <span class="st_h">'root'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st_h">'trim_db before select threads'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT no FROM &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; WHERE sticky=0 AND resto=0 ORDER BY <span class="es4">$exp_order</span> ASC&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st_h">'trim_db after select threads'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$threadcount</span> <span class="sy0">=</span> <span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="sy0">=</span><span class="kw3">mysql_fetch_array</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span> and <span class="re0">$threadcount</span> <span class="sy0">&gt;=</span> <span class="re0">$maxthreads</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delete_post<span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st_h">'trim'</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// imgonly=0, automatic=1, children=1</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$threadcount</span><span class="sy0">--;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Original max-posts method (note: cleans orphaned posts later than parent posts)</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// make list of stickies</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$stickies</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// keys are stickied thread numbers</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT no from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where sticky=1 and resto=0&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="sy0">=</span><span class="kw3">mysql_fetch_array</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$stickies</span><span class="br0">&#91;</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT no,resto,sticky FROM &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; ORDER BY no ASC&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$postcount</span> <span class="sy0">=</span> <span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="sy0">=</span><span class="kw3">mysql_fetch_array</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span> and <span class="re0">$postcount</span> <span class="sy0">&gt;=</span> <span class="re0">$maxposts</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// don't delete if this is a sticky thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'sticky'</span><span class="br0">&#93;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="kw1">continue</span><span class="sy0">;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// don't delete if this is a REPLY to a sticky</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$stickies</span><span class="br0">&#91;</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="kw1">continue</span><span class="sy0">;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delete_post<span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st_h">'trim'</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// imgonly=0, automatic=1, children=0</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$postcount</span><span class="sy0">--;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">//resno - thread page to update (no of thread OP)</span></div></li>
<li class="li1"><div class="de1"><span class="co1">//rebuild - don't rebuild page indexes</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> updatelog<span class="br0">&#40;</span><span class="re0">$resno</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span><span class="re0">$rebuild</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">,</span><span class="re0">$path</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">set_time_limit</span><span class="br0">&#40;</span><span class="nu0">60</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REQUEST_METHOD'</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="st_h">'GET'</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>valid<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st_h">''</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// anti ddos</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgdir</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>USE_SRC_CGI<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span>?<span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st_h">'src'</span><span class="sy0">,</span><span class="st_h">'src.cgi'</span><span class="sy0">,</span>IMG_DIR2<span class="br0">&#41;</span><span class="sy0">:</span>IMG_DIR2<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'INTERSTITIAL_LINK'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$imgdir</span> <span class="sy0">.=</span> INTERSTITIAL_LINK<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$thumbdir</span> <span class="sy0">=</span> THUMB_DIR2<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgurl</span> <span class="sy0">=</span> DATA_SERVER<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$resno</span><span class="sy0">=</span><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$resno</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="nu0">0</span><span class="sy0">,</span><span class="re0">$rebuild</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// the post didn't exist, just rebuild the indexes</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">,</span><span class="re0">$rebuild</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// $resno is a reply, try rebuilding the parent</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$treeline</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span> logtime<span class="br0">&#40;</span><span class="st0">&quot;Formatting thread page&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">//if(!$treeline=mysql_board_call(&quot;select * from &quot;.SQLLOG.&quot; where root&gt;0 and no=&quot;.$resno.&quot; order by root desc&quot;)){echo S_SQLFAIL;}</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$treeline</span> <span class="sy0">=</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="st_h">'THREADS'</span><span class="br0">&#93;</span><span class="sy0">;</span> logtime<span class="br0">&#40;</span><span class="st0">&quot;Formatting index page&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">//if(!$treeline=mysql_board_call(&quot;select * from &quot;.SQLLOG.&quot; where root&gt;0 order by root desc&quot;)){echo S_SQLFAIL;}</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$counttree</span><span class="sy0">=</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$treeline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//$counttree=mysql_num_rows($treeline);</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$counttree</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$logfilename</span><span class="sy0">=</span>PHP_SELF2<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; head<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; form<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; print_page<span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="sy0">,</span> <span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>UPDATE_THROTTLING <span class="sy0">&gt;=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$update_start</span> <span class="sy0">=</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">touch</span><span class="br0">&#40;</span><span class="st0">&quot;updatelog.stamp&quot;</span><span class="sy0">,</span> <span class="re0">$update_start</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$low_priority</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span>PHP_SELF<span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="re0">$update_start</span><span class="sy0">-</span>UPDATE_THROTTLING<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$low_priority</span> <span class="sy0">=</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//touch($update_start . &quot;.lowprio&quot;);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">touch</span><span class="br0">&#40;</span>PHP_SELF<span class="sy0">,</span><span class="re0">$update_start</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// &nbsp; &nbsp; $mt = @filemtime(PHP_SELF);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp;&nbsp; &nbsp; touch($update_start . &quot;.$mt.highprio&quot;);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if we're using CACHE_TTL method</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>CACHE_TTL <span class="sy0">&gt;=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$logfilename</span> <span class="sy0">=</span> RES_DIR<span class="sy0">.</span><span class="re0">$resno</span><span class="sy0">.</span>PHP_EXT<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$logfilename</span> <span class="sy0">=</span> PHP_SELF2<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//if(USE_GZIP == 1) $logfilename .= '.html';</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if the file has been made and it's younger than CACHE_TTL seconds ago</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">filemtime</span><span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="br0">&#40;</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">-</span> CACHE_TTL<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// save the post to be rebuilt later</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rebuildqueue_add<span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if it's a thread, try again on the indexes</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$rebuild</span><span class="br0">&#41;</span> updatelog<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// and we don't do any more rebuilding on this request</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// we're gonna update it now, so take it out of the queue</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rebuildqueue_remove<span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// and make sure nobody else starts trying to update it because it's too old</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">touch</span><span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$page</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="re0">$page</span><span class="sy0">&lt;</span><span class="re0">$counttree</span><span class="sy0">;</span><span class="re0">$page</span><span class="sy0">+=</span>PAGE_DEF<span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; head<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; form<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$st</span> <span class="sy0">=</span> <span class="re0">$page</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;form name=&quot;delform&quot; action=&quot;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span>PHP_SELF_ABS<span class="sy0">.</span><span class="st_h">'&quot; method=POST&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="re0">$st</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$st</span><span class="sy0">+</span>PAGE_DEF<span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>UPDATE_THROTTLING <span class="sy0">&gt;=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$low_priority</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span><span class="st0">&quot;updatelog.stamp&quot;</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="re0">$update_start</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//touch($update_start . &quot;.throttled&quot;);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">rand</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">15</span><span class="br0">&#41;</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$_unused</span><span class="sy0">,</span><span class="re0">$no</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">each</span><span class="br0">&#40;</span><span class="re0">$treeline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">//list($no,$sticky,$permasage,$closed,$now,$name,$email,$sub,$com,$host,$pwd,$filename,$ext,$w,$h,$tn_w,$tn_h,$tim,$time,$md5,$fsize,$root,$resto)=mysql_fetch_row($treeline);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">break</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">extract</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">//if(!$resno&amp;&amp;!file_exists(RES_DIR.$no.PHP_EXT)) { updatelog($no); break; } // uhh</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//POST FILTERING</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> broomcloset_capcode<span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span> <span class="re0">$name</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>mailto:<span class="es4">$email</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>linkmail<span class="es1">\&quot;</span>&gt;<span class="es4">$name</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="st0">&quot;SPOILER&lt;&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">===</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sub</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="st0">&quot;SPOILER&lt;&gt;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//trim out SPOILER&lt;&gt;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$spoiler</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="re0">$spoiler</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> auto_link<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$abbreviated</span><span class="br0">&#41;</span> <span class="sy0">=</span> abbreviate<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> MAX_LINES_SHOWN<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$abbreviated</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$abbreviated</span><span class="br0">&#41;</span> <span class="re0">$com</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;br /&gt;&lt;span class=<span class="es1">\&quot;</span>abbr<span class="es1">\&quot;</span>&gt;Comment too long. Click &lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$resto</span>?<span class="re0">$resto</span><span class="sy0">:</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#<span class="es4">$no</span><span class="es1">\&quot;</span>&gt;here&lt;/a&gt; to view the full text.&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">// Picture file name</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$img</span> <span class="sy0">=</span> <span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$displaysrc</span> <span class="sy0">=</span> <span class="re0">$imgdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$linksrc</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>USE_SRC_CGI<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span>?<span class="br0">&#40;</span><span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;.cgi&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$imgdir</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="sy0">:</span><span class="re0">$displaysrc</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'INTERSTITIAL_LINK'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$linksrc</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span>INTERSTITIAL_LINK<span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$linksrc</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$src</span> <span class="sy0">=</span> IMG_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$longname</span> <span class="sy0">=</span> <span class="re0">$filename</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span><span class="sy0">&gt;</span><span class="nu0">40</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortname</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">40</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;(...)&quot;</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortname</span> <span class="sy0">=</span> <span class="re0">$longname</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">// img tag creation</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// turn the 32-byte ascii md5 into a 24-byte base64 md5</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortmd5</span> <span class="sy0">=</span> <span class="kw3">base64_encode</span><span class="br0">&#40;</span><span class="kw3">pack</span><span class="br0">&#40;</span><span class="st0">&quot;H*&quot;</span><span class="sy0">,</span> <span class="re0">$md5</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$fsize</span> <span class="sy0">&gt;=</span> <span class="nu0">1048576</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">round</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$fsize</span><span class="sy0">/</span><span class="nu0">1048576</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; M&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$fsize</span> <span class="sy0">&gt;=</span> <span class="nu0">1024</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">round</span><span class="br0">&#40;</span><span class="re0">$fsize</span><span class="sy0">/</span><span class="nu0">1024</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; K&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="re0">$fsize</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$tn_w</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$tn_h</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$ext</span><span class="sy0">==</span><span class="st0">&quot;.gif&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tn_w</span><span class="sy0">=</span><span class="re0">$w</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tn_h</span><span class="sy0">=</span><span class="re0">$h</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$spoiler</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$size</span><span class="sy0">=</span> <span class="st0">&quot;Spoiler Image, <span class="es4">$size</span>&quot;</span><span class="sy0">;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>SPOILER_THUMB<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> border=0 align=left hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="re0">$tn_w</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$tn_h</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="co1">//when there is size...</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">is_file</span><span class="br0">&#40;</span>THUMB_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=&quot;</span><span class="sy0">.</span><span class="re0">$thumbdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">.</span><span class="st0">&quot; border=0 align=left width=<span class="es4">$tn_w</span> height=<span class="es4">$tn_h</span> hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;span class=<span class="es1">\&quot;</span>tn_thread<span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span>&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">is_file</span><span class="br0">&#40;</span>THUMB_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=&quot;</span><span class="sy0">.</span><span class="re0">$thumbdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">.</span><span class="st0">&quot; border=0 align=left hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;span class=<span class="es1">\&quot;</span>tn_thread<span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span>&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$src</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;img src=&quot;'</span><span class="sy0">.</span><span class="re0">$imgurl</span><span class="sy0">.</span><span class="st_h">'filedeleted.gif&quot; alt=&quot;File deleted.&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dimensions</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$ext</span><span class="sy0">==</span><span class="st_h">'.pdf'</span><span class="br0">&#41;</span>?<span class="st_h">'PDF'</span><span class="sy0">:</span><span class="st0">&quot;<span class="es4">{$w}</span>x<span class="es4">{$h}</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>filesize<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_PICNAME<span class="sy0">.</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$linksrc</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;<span class="es4">$time</span><span class="es4">$ext</span>&lt;/a&gt;-(&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B, &quot;</span><span class="sy0">.</span><span class="re0">$dimensions</span><span class="sy0">.</span><span class="st0">&quot;, &lt;span title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$longname</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="re0">$shortname</span><span class="sy0">.</span><span class="st0">&quot;&lt;/span&gt;)&lt;/span&gt;&quot;</span><span class="sy0">.</span><span class="re0">$imgsrc</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>filesize<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_PICNAME<span class="sy0">.</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$linksrc</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;<span class="es4">$time</span><span class="es4">$ext</span>&lt;/a&gt;-(&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B, &quot;</span><span class="sy0">.</span><span class="re0">$dimensions</span><span class="sy0">.</span><span class="st0">&quot;)&lt;/span&gt;&quot;</span><span class="sy0">.</span><span class="re0">$imgsrc</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">// &nbsp;Main creation</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a name=<span class="es1">\&quot;</span><span class="es4">$resno</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;<span class="es1">\n</span>&lt;input type=checkbox name=<span class="es1">\&quot;</span><span class="es4">$no</span><span class="es1">\&quot;</span> value=delete&gt;&lt;span class=<span class="es1">\&quot;</span>filetitle<span class="es1">\&quot;</span>&gt;<span class="es4">$sub</span>&lt;/span&gt; <span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>postername<span class="es1">\&quot;</span>&gt;<span class="es4">$name</span>&lt;/span&gt; <span class="es4">$now</span> &lt;span id=<span class="es1">\&quot;</span>nothread<span class="es4">$no</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$sticky</span><span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$stickyicon</span><span class="sy0">=</span><span class="st_h">' &lt;img src=&quot;'</span><span class="sy0">.</span><span class="re0">$imgurl</span><span class="sy0">.</span><span class="st_h">'sticky.gif&quot; alt=&quot;sticky&quot;&gt; '</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$stickyicon</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$closed</span><span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$stickyicon</span> <span class="sy0">.=</span> <span class="st_h">' &lt;img src=&quot;'</span><span class="sy0">.</span><span class="re0">$imgurl</span><span class="sy0">.</span><span class="st_h">'closed.gif&quot; alt=&quot;closed&quot;&gt; '</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>PARTY<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;img src='http://img.4chan.org/xmashat.gif' style='position:absolute;margin-top:-100px;left:0px;'&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;No.&lt;/a&gt;&lt;a href=<span class="es1">\&quot;</span>javascript:quote('<span class="es4">$no</span>')<span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;<span class="es4">$no</span>&lt;/a&gt; <span class="es4">$stickyicon</span> &amp;nbsp; &quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#&quot;</span><span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;No.&lt;/a&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#q&quot;</span><span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;<span class="es4">$no</span>&lt;/a&gt; <span class="es4">$stickyicon</span> &amp;nbsp; [&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_REPLY<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;]&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/span&gt;<span class="es1">\n</span>&lt;blockquote&gt;<span class="es4">$com</span>&lt;/blockquote&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="co1">// Deletion pending</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'old'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>oldpost<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_OLD<span class="sy0">.</span><span class="st0">&quot;&lt;/span&gt;&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$resline</span> <span class="sy0">=</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw3">ksort</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$countres</span><span class="sy0">=</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'children'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$t</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$sticky</span><span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$disam</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'REPLIES_SHOWN'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$disam</span><span class="sy0">=</span>REPLIES_SHOWN<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$disam</span><span class="sy0">=</span><span class="nu0">5</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$s</span><span class="sy0">=</span><span class="re0">$countres</span> <span class="sy0">-</span> <span class="re0">$disam</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$cur</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$s</span> <span class="sy0">&gt;=</span> <span class="re0">$cur</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">each</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$row</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;fsize&quot;</span><span class="br0">&#93;</span><span class="sy0">!=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$t</span><span class="sy0">++;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$cur</span><span class="sy0">++;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$countres</span><span class="sy0">!=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw3">reset</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">&lt;</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$posts</span><span class="sy0">=</span><span class="st0">&quot; post&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$posts</span><span class="sy0">=</span><span class="st0">&quot; posts&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$t</span><span class="sy0">&lt;</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$replies</span><span class="sy0">=</span><span class="st0">&quot;reply&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$replies</span><span class="sy0">=</span><span class="st0">&quot;replies&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="br0">&#40;</span><span class="re0">$t</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>omittedposts<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="re0">$s</span><span class="sy0">.</span><span class="re0">$posts</span><span class="sy0">.</span><span class="st0">&quot; omitted. Click Reply to view.&lt;/span&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span> <span class="kw1">elseif</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="br0">&#40;</span><span class="re0">$t</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>omittedposts<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="re0">$s</span><span class="sy0">.</span><span class="re0">$posts</span><span class="sy0">.</span><span class="st0">&quot; and &quot;</span><span class="sy0">.</span><span class="re0">$t</span><span class="sy0">.</span><span class="st0">&quot; image &quot;</span><span class="sy0">.</span><span class="re0">$replies</span><span class="sy0">.</span><span class="st0">&quot; omitted. Click Reply to view.&lt;/span&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$s</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$resrow</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">each</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$s</span><span class="sy0">--;</span><span class="kw1">continue</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="co1">//list($no,$sticky,$permasage,$closed,$now,$name,$email,$sub,$com,$host,$pwd,$filename,$ext,$w,$h,$tn_w,$tn_h,$tim,$time,$md5,$fsize,$root,$resto)=$resrow;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw3">extract</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resrow</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">break</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//POST FILTERING</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> broomcloset_capcode<span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span> <span class="re0">$name</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>mailto:<span class="es4">$email</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>linkmail<span class="es1">\&quot;</span>&gt;<span class="es4">$name</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="st0">&quot;SPOILER&lt;&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">===</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sub</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="st0">&quot;SPOILER&lt;&gt;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//trim out SPOILER&lt;&gt;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$spoiler</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="re0">$spoiler</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> auto_link<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$abbreviated</span><span class="br0">&#41;</span> <span class="sy0">=</span> abbreviate<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> MAX_LINES_SHOWN<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$abbreviated</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="re0">$abbreviated</span><span class="br0">&#41;</span> <span class="re0">$com</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;br /&gt;&lt;span class=<span class="es1">\&quot;</span>abbr<span class="es1">\&quot;</span>&gt;Comment too long. Click &lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$resto</span>?<span class="re0">$resto</span><span class="sy0">:</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#<span class="es4">$no</span><span class="es1">\&quot;</span>&gt;here&lt;/a&gt; to view the full text.&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Picture file name</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_img</span> <span class="sy0">=</span> <span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_displaysrc</span> <span class="sy0">=</span> <span class="re0">$imgdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_linksrc</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>USE_SRC_CGI<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span>?<span class="br0">&#40;</span><span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;.cgi&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$imgdir</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="sy0">:</span><span class="re0">$r_displaysrc</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'INTERSTITIAL_LINK'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$r_linksrc</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span>INTERSTITIAL_LINK<span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$r_linksrc</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_src</span> <span class="sy0">=</span> IMG_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$longname</span> <span class="sy0">=</span> <span class="re0">$filename</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span><span class="sy0">&gt;</span><span class="nu0">30</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortname</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">30</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;(...)&quot;</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortname</span> <span class="sy0">=</span> <span class="re0">$longname</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// img tag creation</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// turn the 32-byte ascii md5 into a 24-byte base64 md5</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$shortmd5</span> <span class="sy0">=</span> <span class="kw3">base64_encode</span><span class="br0">&#40;</span><span class="kw3">pack</span><span class="br0">&#40;</span><span class="st0">&quot;H*&quot;</span><span class="sy0">,</span> <span class="re0">$md5</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$fsize</span> <span class="sy0">&gt;=</span> <span class="nu0">1048576</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">round</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$fsize</span><span class="sy0">/</span><span class="nu0">1048576</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; M&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$fsize</span> <span class="sy0">&gt;=</span> <span class="nu0">1024</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">round</span><span class="br0">&#40;</span><span class="re0">$fsize</span><span class="sy0">/</span><span class="nu0">1024</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; K&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$size</span> <span class="sy0">=</span> <span class="re0">$fsize</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$tn_w</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$tn_h</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$ext</span><span class="sy0">==</span><span class="st0">&quot;.gif&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tn_w</span><span class="sy0">=</span><span class="re0">$w</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tn_h</span><span class="sy0">=</span><span class="re0">$h</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$spoiler</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$size</span><span class="sy0">=</span> <span class="st0">&quot;Spoiler Image, <span class="es4">$size</span>&quot;</span><span class="sy0">;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$r_displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>SPOILER_THUMB<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> border=0 align=left hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="re0">$tn_w</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$tn_h</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="co1">//when there is size...</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">is_file</span><span class="br0">&#40;</span>THUMB_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$r_displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=&quot;</span><span class="sy0">.</span><span class="re0">$thumbdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">.</span><span class="st0">&quot; border=0 align=left width=<span class="es4">$tn_w</span> height=<span class="es4">$tn_h</span> hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$r_displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;span class=<span class="es1">\&quot;</span>tn_reply<span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span>&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">is_file</span><span class="br0">&#40;</span>THUMB_DIR<span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;br&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$r_displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;img src=&quot;</span><span class="sy0">.</span><span class="re0">$thumbdir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">.</span><span class="st0">&quot; border=0 align=left hspace=20 alt=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span> md5=<span class="es1">\&quot;</span><span class="es4">$shortmd5</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgsrc</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$r_displaysrc</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> target=_blank&gt;&lt;span class=<span class="es1">\&quot;</span>tn_reply<span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B<span class="es1">\&quot;</span>&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$r_src</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgreply</span><span class="sy0">=</span><span class="st_h">'&lt;br&gt;&lt;img src=&quot;'</span><span class="sy0">.</span><span class="re0">$imgurl</span><span class="sy0">.</span><span class="st_h">'filedeleted-res.gif&quot; alt=&quot;File deleted.&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dimensions</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$ext</span><span class="sy0">==</span><span class="st_h">'.pdf'</span><span class="br0">&#41;</span>?<span class="st_h">'PDF'</span><span class="sy0">:</span><span class="st0">&quot;<span class="es4">{$w}</span>x<span class="es4">{$h}</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgreply</span><span class="sy0">=</span><span class="st0">&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span class=<span class="es1">\&quot;</span>filesize<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_PICNAME<span class="sy0">.</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$r_linksrc</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;<span class="es4">$time</span><span class="es4">$ext</span>&lt;/a&gt;-(&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B, &quot;</span><span class="sy0">.</span><span class="re0">$dimensions</span><span class="sy0">.</span><span class="st0">&quot;, &lt;span title=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$longname</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="re0">$shortname</span><span class="sy0">.</span><span class="st0">&quot;&lt;/span&gt;)&lt;/span&gt;&quot;</span><span class="sy0">.</span><span class="re0">$r_imgsrc</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$r_imgreply</span><span class="sy0">=</span><span class="st0">&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span class=<span class="es1">\&quot;</span>filesize<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_PICNAME<span class="sy0">.</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$r_linksrc</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;<span class="es4">$time</span><span class="es4">$ext</span>&lt;/a&gt;-(&quot;</span><span class="sy0">.</span><span class="re0">$size</span><span class="sy0">.</span><span class="st0">&quot;B, &quot;</span><span class="sy0">.</span><span class="re0">$dimensions</span><span class="sy0">.</span><span class="st0">&quot;)&lt;/span&gt;&quot;</span><span class="sy0">.</span><span class="re0">$r_imgsrc</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="co1">// Main Reply creation</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a name=<span class="es1">\&quot;</span><span class="es4">$no</span><span class="es1">\&quot;</span>&gt;&lt;/a&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;table&gt;&lt;tr&gt;&lt;td nowrap class=<span class="es1">\&quot;</span>doubledash<span class="es1">\&quot;</span>&gt;&amp;gt;&amp;gt;&lt;/td&gt;&lt;td id=<span class="es1">\&quot;</span><span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>reply<span class="es1">\&quot;</span>&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// &nbsp; &nbsp; &nbsp;if (($t&gt;3)&amp;&amp;($fsize!=0)) {</span></div></li>
<li class="li2"><div class="de2"><span class="co1">// &nbsp; &nbsp; &nbsp;$dat.=&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;b&gt;Image hidden&lt;/b&gt;&amp;nbsp;&amp;nbsp; $now No.$no \n&quot;;</span></div></li>
<li class="li1"><div class="de1"><span class="co1">//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;input type=checkbox name=<span class="es1">\&quot;</span><span class="es4">$no</span><span class="es1">\&quot;</span> value=delete&gt;&lt;span class=<span class="es1">\&quot;</span>replytitle<span class="es1">\&quot;</span>&gt;<span class="es4">$sub</span>&lt;/span&gt; <span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;span class=<span class="es1">\&quot;</span>commentpostername<span class="es1">\&quot;</span>&gt;<span class="es4">$name</span>&lt;/span&gt; <span class="es4">$now</span> &lt;span id=<span class="es1">\&quot;</span>norep<span class="es4">$no</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;No.&lt;/a&gt;&lt;a href=<span class="es1">\&quot;</span>javascript:quote('<span class="es4">$no</span>')<span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;<span class="es4">$no</span>&lt;/a&gt;&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="re0">$resto</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;No.&lt;/a&gt;&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>RES_DIR<span class="sy0">.</span><span class="re0">$resto</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;#q<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotejs<span class="es1">\&quot;</span>&gt;<span class="es4">$no</span>&lt;/a&gt;&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$r_imgreply</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$dat</span><span class="sy0">.=</span><span class="re0">$r_imgreply</span><span class="sy0">;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;blockquote&gt;<span class="es4">$com</span>&lt;/blockquote&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// &nbsp; &nbsp; &nbsp;}</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unset</span><span class="br0">&#40;</span><span class="re0">$r_imgreply</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;br clear=left&gt;&lt;hr&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//clear stat cache of a file</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">//mysql_free_result($resline);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$p</span><span class="sy0">++;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">break</span><span class="sy0">;</span><span class="br0">&#125;</span> <span class="co1">//only one tree line at time of res</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// bottom of a page</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>BOTTOM_AD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bottomad</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st0">&quot;BOTTOM_TXT&quot;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> BOTTOM_TXT<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bottomad</span> <span class="sy0">.=</span> ad_text_for<span class="br0">&#40;</span>BOTTOM_TXT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st0">&quot;BOTTOM_TABLE&quot;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> BOTTOM_TABLE<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$bottomimg</span><span class="sy0">,</span><span class="re0">$bottomlink</span><span class="br0">&#41;</span> <span class="sy0">=</span> rid<span class="br0">&#40;</span>BOTTOM_TABLE<span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bottomad</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;center&gt;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$bottomlink</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;&lt;img style=<span class="es1">\&quot;</span>border:1px solid black;<span class="es1">\&quot;</span> src=<span class="es1">\&quot;</span><span class="es4">$bottomimg</span><span class="es1">\&quot;</span> width=728 height=90 border=0 /&gt;&lt;/a&gt;&lt;/center&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$bottomad</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;<span class="es4">$bottomad</span>&lt;hr&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;table align=right&gt;&lt;tr&gt;&lt;td nowrap align=center class=deletebuttons&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;input type=hidden name=mode value=usrdel&gt;'</span><span class="sy0">.</span>S_REPDEL<span class="sy0">.</span><span class="st_h">' [&lt;input class=checkbox type=checkbox name=onlyimgdel value=on&gt;'</span><span class="sy0">.</span>S_DELPICONLY<span class="sy0">.</span><span class="st_h">']&lt;br&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">'</span><span class="sy0">.</span>S_DELKEY<span class="sy0">.</span><span class="st_h">' &lt;input class=inputtext type=password name=&quot;pwd&quot; size=8 maxlength=8 value=&quot;&quot;&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;input type=submit value=&quot;'</span><span class="sy0">.</span>S_DELETE<span class="sy0">.</span><span class="st_h">'&quot;&gt;&lt;input type=&quot;button&quot; value=&quot;Report&quot; onclick=&quot;var o=document.getElementsByTagName(\'INPUT\');for(var i=0;i&lt;o.length;i++)if(o[i].type==\'checkbox\' &amp;&amp; o[i].checked &amp;&amp; o[i].value==\'delete\') return reppop(\''</span><span class="sy0">.</span>PHP_SELF_ABS<span class="sy0">.</span><span class="st_h">'?mode=report&amp;no=\'+o[i].name+\'\');&quot;&gt;&lt;/form&gt;&lt;script&gt;document.delform.pwd.value=get_pass(&quot;4chan_pass&quot;);&lt;/script&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'SERVER_NAME'</span><span class="br0">&#93;</span><span class="sy0">,</span><span class="st0">&quot;.4chan.org&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td align=&quot;right&quot;&gt;Style ['</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Yotsuba\'); return false;&quot;&gt;Yotsuba&lt;/a&gt; | '</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Yotsuba B\'); return false;&quot;&gt;Yotsuba B&lt;/a&gt; | '</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Futaba\'); return false;&quot;&gt;Futaba&lt;/a&gt; | '</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Burichan\'); return false;&quot;&gt;Burichan&lt;/a&gt;]&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/table&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="co1">// if not in res display mode</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$prev</span> <span class="sy0">=</span> <span class="re0">$st</span> <span class="sy0">-</span> PAGE_DEF<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$next</span> <span class="sy0">=</span> <span class="re0">$st</span> <span class="sy0">+</span> PAGE_DEF<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">// Page navigation</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;table class=pages align=left border=1&gt;&lt;tr&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$prev</span> <span class="sy0">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="co1">//ok to make prev button</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$prev</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;form action=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> onsubmit='location=this.action;return false;' method=get&gt;&lt;td&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;form action=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$prev</span><span class="sy0">/</span>PAGE_DEF<span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> onsubmit='location=this.action;return false;' method=get&gt;&lt;td&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;input type=submit value=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>S_PREV<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> accesskey=<span class="es1">\&quot;</span>z<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/td&gt;&lt;/form&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;td&gt;&quot;</span><span class="sy0">.</span>S_FIRSTPG<span class="sy0">.</span><span class="st0">&quot;&lt;/td&gt;&quot;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// page listing</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;td&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$counttree</span> <span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">+=</span>PAGE_DEF<span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="br0">&#40;</span>PAGE_MAX <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">&amp;&amp;!</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">%</span><span class="br0">&#40;</span>PAGE_DEF<span class="sy0">*</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;br&gt;&quot;</span><span class="sy0">;</span><span class="br0">&#125;</span> <span class="co1">// linebreak every 10 pages</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$st</span><span class="sy0">==</span><span class="re0">$i</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;[&lt;b&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">/</span>PAGE_DEF<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;&lt;/b&gt;] &quot;</span><span class="sy0">;</span><span class="br0">&#125;</span> <span class="co1">// don't link current page</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;0&lt;/a&gt;] &quot;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">/</span>PAGE_DEF<span class="br0">&#41;</span><span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">/</span>PAGE_DEF<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;] &quot;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="co1">// continue printing up to PAGE_MAX if we're using that mode... this should rarely happen</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="sy0">;</span> <span class="br0">&#40;</span>PAGE_MAX <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> PAGE_MAX<span class="sy0">*</span>PAGE_DEF<span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">+=</span>PAGE_DEF<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;[&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">/</span>PAGE_DEF<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;] &quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/td&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$p</span> <span class="sy0">&gt;=</span> PAGE_DEF <span class="sy0">&amp;&amp;</span> <span class="re0">$counttree</span> <span class="sy0">&gt;</span> <span class="re0">$next</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="co1">// ok to make next button</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;form action=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span><span class="re0">$next</span><span class="sy0">/</span>PAGE_DEF<span class="sy0">.</span>PHP_EXT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> onsubmit='location=this.action;return false' method=get&gt;&lt;td&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;input type=submit value=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>S_NEXT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> accesskey=<span class="es1">\&quot;</span>x<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/td&gt;&lt;/form&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;td&gt;&quot;</span><span class="sy0">.</span>S_LASTPG<span class="sy0">.</span><span class="st0">&quot;&lt;/td&gt;&quot;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/tr&gt;&lt;/table&gt;&lt;br clear=all&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; foot<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">//if($resno){echo $dat;break;}</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Printing thread <span class="es4">$resno</span> page&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$logfilename</span><span class="sy0">=</span>RES_DIR<span class="sy0">.</span><span class="re0">$resno</span><span class="sy0">.</span>PHP_EXT<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print_page<span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="sy0">,</span> <span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$rebuild</span><span class="br0">&#41;</span> <span class="re0">$deferred</span> <span class="sy0">=</span> updatelog<span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Printing index page&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$page</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$logfilename</span><span class="sy0">=</span>PHP_SELF2<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$logfilename</span><span class="sy0">=</span><span class="re0">$page</span><span class="sy0">/</span>PAGE_DEF<span class="sy0">.</span>PHP_EXT<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; print_page<span class="br0">&#40;</span><span class="re0">$logfilename</span><span class="sy0">,</span> <span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$page</span><span class="sy0">==</span><span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> USE_RSS<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">include_once</span> <span class="st_h">'/www/global/rss.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; rss_dump<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>UPDATE_THROTTLING <span class="sy0">&gt;=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span><span class="st0">&quot;updatelog.stamp&quot;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="re0">$update_start</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="st0">&quot;updatelog.stamp&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="co1">//chmod($logfilename,0666);</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//mysql_free_result($treeline);</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$deferred</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$deferred</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* head */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> head<span class="br0">&#40;</span><span class="sy0">&amp;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$res</span><span class="sy0">,</span><span class="re0">$error</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$titlepart</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> broomcloset_head<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>SHOWTITLEIMG <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$titleimg = rid('title_banners');</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$titleimg</span> <span class="sy0">=</span> rid_in_directory<span class="br0">&#40;</span><span class="st0">&quot;/dontblockthis/title/&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$titlepart</span><span class="sy0">.=</span> <span class="st_h">'&lt;img width=300 height=100 src=&quot;'</span><span class="sy0">.</span><span class="re0">$titleimg</span><span class="sy0">.</span><span class="st_h">'&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>SHOWTITLEIMG <span class="sy0">==</span> <span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$titlepart</span><span class="sy0">.=</span> <span class="st_h">'&lt;img width=300 height=100 src=&quot;'</span><span class="sy0">.</span>TITLEIMG<span class="sy0">.</span><span class="st_h">'&quot; onclick=&quot;this.src=this.src;&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$include1</span><span class="sy0">=</span>file_get_contents_cached<span class="br0">&#40;</span>NAV_TXT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$cookiejs</span><span class="sy0">=</span><span class="st0">&quot;function get_cookie(name){with(document.cookie){var index=indexOf(name+<span class="es1">\&quot;</span>=<span class="es1">\&quot;</span>);if(index==-1) return '';index=indexOf(<span class="es1">\&quot;</span>=<span class="es1">\&quot;</span>,index)+1;var endstr=indexOf(<span class="es1">\&quot;</span>;<span class="es1">\&quot;</span>,index);if(endstr==-1) endstr=length;return decodeURIComponent(substring(index,endstr));}};<span class="es1">\n</span>function get_pass(name){var pass=get_cookie(name);if(pass) return pass;var chars=<span class="es1">\&quot;</span>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<span class="es1">\&quot;</span>;var pass='';for(var i=0;i&lt;8;i++){var rnd=Math.floor(Math.random()*chars.length);pass+=chars.substring(rnd,rnd+1);}return(pass);}<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$cookiejs</span> <span class="sy0">.=</span> <span class="st_h">'function toggle(name){var a=document.getElementById(name); a.style.display = ((a.style.display!=&quot;block&quot;)?&quot;block&quot;:&quot;none&quot;);}'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$scriptjs</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">// set styleswitcher script configuration variables</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>DEFAULT_BURICHAN<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$scriptjs</span> <span class="sy0">.=</span> <span class="st_h">'&lt;script type=&quot;text/javascript&quot;&gt;var style_group=&quot;ws_style&quot;;&lt;/script&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$scriptjs</span> <span class="sy0">.=</span> <span class="st_h">'&lt;script type=&quot;text/javascript&quot;&gt;var style_group=&quot;nws_style&quot;;&lt;/script&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$scriptjs</span> <span class="sy0">.=</span><span class="st_h">'&lt;script type=&quot;text/javascript&quot; src=&quot;'</span><span class="sy0">.</span>DATA_SERVER<span class="sy0">.</span><span class="st_h">'script.js&quot;&gt;&lt;/script&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;html&gt;&lt;head&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;META HTTP-EQUIV=&quot;content-type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;meta name=&quot;robots&quot; content=&quot;'</span><span class="sy0">.</span>META_ROBOTS<span class="sy0">.</span><span class="st_h">'&quot;/&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;meta name=&quot;description&quot; content=&quot;'</span><span class="sy0">.</span>META_DESCRIPTION<span class="sy0">.</span><span class="st_h">'&quot;/&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;meta name=&quot;keywords&quot; content=&quot;'</span><span class="sy0">.</span>META_KEYWORDS<span class="sy0">.</span><span class="st_h">'&quot;/&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>RTA<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;<span class="es1">\n</span>&lt;meta name=<span class="es1">\&quot;</span>RATING<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>RTA-5042-1996-1400-1577-RTA<span class="es1">\&quot;</span> /&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$styles</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'Yotsuba'</span> <span class="sy0">=&gt;</span> <span class="st_h">'yotsuba.8.css'</span><span class="sy0">,</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'Yotsuba B'</span> <span class="sy0">=&gt;</span> <span class="st_h">'yotsublue.8.css'</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'Futaba'</span> <span class="sy0">=&gt;</span> <span class="st_h">'futaba.8.css'</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'Burichan'</span> <span class="sy0">=&gt;</span> <span class="st_h">'burichan.8.css'</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>DEFAULT_BURICHAN<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$styles</span> <span class="kw1">as</span> <span class="re0">$style</span><span class="sy0">=&gt;</span><span class="re0">$stylecss</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$rel</span> <span class="sy0">=</span> <span class="br0">&#40;</span> <span class="br0">&#40;</span><span class="re0">$style</span> <span class="sy0">==</span> <span class="st_h">'Yotsuba B'</span><span class="br0">&#41;</span> ? <span class="st_h">'stylesheet'</span> <span class="sy0">:</span> <span class="st_h">'alternate stylesheet'</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;link rel=<span class="es1">\&quot;</span><span class="es4">$rel</span><span class="es1">\&quot;</span> type=<span class="es1">\&quot;</span>text/css<span class="es1">\&quot;</span> href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>DATA_SERVER<span class="sy0">.</span><span class="st0">&quot;<span class="es4">$stylecss</span><span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span><span class="es4">$style</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'CSS_FORCE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$styles</span> <span class="kw1">as</span> <span class="re0">$style</span><span class="sy0">=&gt;</span><span class="re0">$stylecss</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$rel</span> <span class="sy0">=</span> <span class="br0">&#40;</span> <span class="br0">&#40;</span><span class="re0">$style</span> <span class="sy0">==</span> <span class="st_h">'Yotsuba'</span><span class="br0">&#41;</span> ? <span class="st_h">'stylesheet'</span> <span class="sy0">:</span> <span class="st_h">'alternate stylesheet'</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;link rel=<span class="es1">\&quot;</span><span class="es4">$rel</span><span class="es1">\&quot;</span> type=<span class="es1">\&quot;</span>text/css<span class="es1">\&quot;</span> href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>CSS_FORCE<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span><span class="es4">$style</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$styles</span> <span class="kw1">as</span> <span class="re0">$style</span><span class="sy0">=&gt;</span><span class="re0">$stylecss</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$rel</span> <span class="sy0">=</span> <span class="br0">&#40;</span> <span class="br0">&#40;</span><span class="re0">$style</span> <span class="sy0">==</span> <span class="st_h">'Yotsuba'</span><span class="br0">&#41;</span> ? <span class="st_h">'stylesheet'</span> <span class="sy0">:</span> <span class="st_h">'alternate stylesheet'</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;link rel=<span class="es1">\&quot;</span><span class="es4">$rel</span><span class="es1">\&quot;</span> type=<span class="es1">\&quot;</span>text/css<span class="es1">\&quot;</span> href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>DATA_SERVER<span class="sy0">.</span><span class="st0">&quot;<span class="es4">$stylecss</span><span class="es1">\&quot;</span> title=<span class="es1">\&quot;</span><span class="es4">$style</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>USE_RSS<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st_h">'&lt;link rel=&quot;alternate&quot; title=&quot;RSS feed&quot; href=&quot;/'</span><span class="sy0">.</span>BOARD_DIR<span class="sy0">.</span><span class="st_h">'/index.rss&quot; type=&quot;application/rss+xml&quot; /&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;title&gt;'</span><span class="sy0">.</span><span class="kw3">strip_tags</span><span class="br0">&#40;</span>TITLE<span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">'&lt;/title&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">.</span><span class="re0">$cookiejs</span><span class="sy0">.</span><span class="st_h">'</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">//--&gt;&lt;/script&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">.</span><span class="re0">$scriptjs</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span> <span class="br0">&#40;</span>FIXED_TEXT_AD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">file_exists</span><span class="br0">&#40;</span>FIXED_TEXT_PATH<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;style&gt;.postarea { padding-left:400px; }&lt;/style&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st_h">'&lt;/head&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;body bgcolor=&quot;#FFFFEE&quot; text=&quot;#800000&quot; link=&quot;#0000EE&quot; vlink=&quot;#0000EE&quot;&gt;'</span><span class="sy0">.</span><span class="re0">$include1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div class=&quot;logo&quot;&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">.</span><span class="re0">$titlepart</span><span class="sy0">.</span><span class="st_h">'&lt;br&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;font size=5&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;b&gt;&lt;SPAN&gt;'</span><span class="sy0">.</span>TITLE<span class="sy0">.</span><span class="st_h">'&lt;/SPAN&gt;&lt;/b&gt;&lt;/font&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'SUBTITLE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st_h">'&lt;br&gt;&lt;font size=1&gt;'</span><span class="sy0">.</span>SUBTITLE<span class="sy0">.</span><span class="st_h">'&lt;/font&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/div&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;hr width=&quot;90%&quot; size=1&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>LEADERBOARD_AD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'LEADERBOARD_TXT'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> LEADERBOARD_TXT<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div style=&quot;text-align: center&quot;&gt;'</span> <span class="sy0">.</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ad_text_for<span class="br0">&#40;</span>LEADERBOARD_TXT<span class="br0">&#41;</span> <span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'&lt;/div&gt;&lt;hr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'LEADERBOARD_TABLE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$ldimg</span><span class="sy0">,</span><span class="re0">$ldhref</span><span class="br0">&#41;</span> <span class="sy0">=</span> rid<span class="br0">&#40;</span>LEADERBOARD_TABLE<span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div style=&quot;text-align: center&quot;&gt;&lt;a href=&quot;'</span><span class="sy0">.</span><span class="re0">$ldhref</span><span class="sy0">.</span><span class="st_h">'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'</span><span class="sy0">.</span><span class="re0">$ldimg</span><span class="sy0">.</span><span class="st_h">'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;hr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div style=&quot;text-align: center&quot;&gt;&lt;a href=&quot;'</span><span class="sy0">.</span>LEADERBOARD_LINK<span class="sy0">.</span><span class="st_h">'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/'</span><span class="sy0">.</span>LEADERBOARD_IMG<span class="sy0">.</span><span class="st_h">'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;hr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* Contribution form */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> form<span class="br0">&#40;</span><span class="sy0">&amp;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="sy0">,</span><span class="re0">$admin</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw2">global</span> <span class="re0">$log</span><span class="sy0">;</span> log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$maxbyte</span> <span class="sy0">=</span> MAX_KB <span class="sy0">*</span> <span class="nu0">1024</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$no</span><span class="sy0">=</span><span class="re0">$resno</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$closed</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$msg</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$hidden</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$closed</span> <span class="sy0">=</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$resno</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'closed'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$msg</span><span class="sy0">.=</span><span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>../&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> accesskey=<span class="es1">\&quot;</span>a<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_RETURN<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;]<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$msg</span><span class="sy0">.=</span><span class="st0">&quot;&lt;table width='100%'&gt;&lt;tr&gt;&lt;th bgcolor=#e04000&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$msg</span><span class="sy0">.=</span><span class="st0">&quot;&lt;font color=#FFFFFF&gt;&quot;</span><span class="sy0">.</span>S_POSTING<span class="sy0">.</span><span class="st0">&quot;&lt;/font&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$msg</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$admin</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$hidden</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;input type=hidden name=admin value=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>ADMIN_PASS<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$msg</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;h4&gt;&quot;</span><span class="sy0">.</span>S_NOTAGS<span class="sy0">.</span><span class="st0">&quot;&lt;/h4&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$closed</span><span class="sy0">!=</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="re0">$msg</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//form_ads($dat);</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">require_once</span> <span class="st_h">'oekaki.php'</span><span class="sy0">;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'mode'</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="st_h">'oe_finish'</span><span class="br0">&#41;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oe_form<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oe_preview<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div align=&quot;center&quot; class=&quot;postarea&quot;&gt;&lt;form name=&quot;post&quot; action=&quot;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span>PHP_SELF_ABS<span class="sy0">.</span><span class="st_h">'&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">'</span><span class="sy0">.</span><span class="re0">$hidden</span><span class="sy0">.</span><span class="st_h">'&lt;input type=hidden name=&quot;MAX_FILE_SIZE&quot; value=&quot;'</span><span class="sy0">.</span><span class="re0">$maxbyte</span><span class="sy0">.</span><span class="st_h">'&quot;&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;input type=hidden name=resto value=&quot;'</span><span class="sy0">.</span><span class="re0">$no</span><span class="sy0">.</span><span class="st_h">'&quot;&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span>FIXED_TEXT_AD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$fixedad</span> <span class="sy0">=</span> ad_text_for<span class="br0">&#40;</span>FIXED_TEXT_PATH<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;div id=&quot;ad&quot;&gt;'</span><span class="sy0">.</span><span class="re0">$fixedad</span><span class="sy0">.</span><span class="st_h">'&lt;/div&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>FORCED_ANON <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;table cellpadding=1 cellspacing=1&gt;&lt;tr colspan=2&gt;&lt;td&gt;&lt;input type=hidden name=name&gt;&lt;input type=hidden name=sub&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;'</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="st_h">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_EMAIL<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=email size=&quot;28&quot;&gt;&lt;span id=&quot;tdname&quot;&gt;&lt;/span&gt;&lt;span id=&quot;tdemail&quot;&gt;&lt;/span&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;table cellpadding=1 cellspacing=1&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_NAME<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=name size=&quot;28&quot;&gt;&lt;span id=&quot;tdname&quot;&gt;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_EMAIL<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=email size=&quot;28&quot;&gt;&lt;span id=&quot;tdemail&quot;&gt;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_SUBJECT<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=sub size=&quot;35&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$admin</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;Reply ID&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=resto size=&quot;10&quot;&gt; [&lt;label&gt;&lt;input type=checkbox name=age value=1&gt;Age&lt;/label&gt;] '</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;input type=submit value=&quot;'</span><span class="sy0">.</span>S_SUBMIT<span class="sy0">.</span><span class="st_h">'&quot; accesskey=&quot;s&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span> <span class="br0">&#40;</span>SPOILERS<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">' [&lt;label&gt;&lt;input type=checkbox name=spoiler value=on&gt;'</span><span class="sy0">.</span>S_SPOILERS<span class="sy0">.</span><span class="st_h">'&lt;/label&gt;]'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/td&gt;&lt;/tr&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;tr&gt;&lt;td valign=bottom&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_COMMENT<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;textarea class=inputtext name=com cols=&quot;48&quot; rows=&quot;4&quot; wrap=soft&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'mode'</span><span class="br0">&#93;</span> <span class="sy0">==</span> <span class="st_h">'oe_finish'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">require_once</span> <span class="st_h">'oekaki.php'</span><span class="sy0">;</span> oe_finish_form<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">elseif</span> <span class="br0">&#40;</span>MAX_IMGRES<span class="sy0">!=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_UPLOADFILE<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; &lt;td&gt;&lt;input type=file name=upfile size=&quot;35&quot;&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span><span class="sy0">&amp;&amp;</span>NO_TEXTONLY<span class="sy0">!=</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'[&lt;label&gt;&lt;input type=checkbox name=textonly value=on&gt;'</span><span class="sy0">.</span>S_NOFILE<span class="sy0">.</span><span class="st_h">'&lt;/label&gt;]'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'</span><span class="sy0">.</span>S_DELPASS<span class="sy0">.</span><span class="st_h">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=password name=&quot;pwd&quot; size=8 maxlength=8 value=&quot;&quot;&gt;&lt;small&gt;'</span><span class="sy0">.</span>S_DELEXPL<span class="sy0">.</span><span class="st_h">'&lt;/small&gt;&lt;input type=hidden name=mode value=&quot;regist&quot;&gt;&lt;/td&gt;&lt;/tr&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan=2&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;table border=0 cellpadding=0 cellspacing=0 width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td class=&quot;rules&quot;&gt;'</span><span class="sy0">.</span>S_RULES<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resno</span> <span class="sy0">&amp;&amp;</span> SHOW_UNIQUES <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;LI&gt;Currently &lt;b&gt;'</span><span class="sy0">.</span><span class="re0">$GLOBALS</span><span class="br0">&#91;</span><span class="st_h">'ipcount'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">'&lt;/b&gt; unique user posts.'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/td&gt;&lt;td align=&quot;right&quot; valign=&quot;center&quot;&gt;'</span><span class="sy0">.</span>DONATE<span class="sy0">.</span><span class="st_h">'&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>FORCED_ANON<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// extra spacer to make up for the 2 missing table rows</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>SHOW_BLOTTER <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2"><span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$blotdate</span><span class="sy0">,</span><span class="re0">$blotcontents</span><span class="br0">&#41;</span> <span class="sy0">=</span> blotter_contents<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;tr&gt;&lt;td class=&quot;rules&quot;&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">function updateBlotterVisible() {</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; if(get_cookie(&quot;blotter_hide&quot;) == &quot;show&quot;) {</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; document.getElementById(&quot;blotter&quot;).style.display = \'inline\';</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; } else {</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; document.getElementById(&quot;blotter&quot;).style.display = \'none\';</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">}</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="st_h">function toggleBlotter() {</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; if(get_cookie(&quot;blotter_hide&quot;) == &quot;show&quot;) {</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; document.cookie = &quot;blotter_hide=hide; expires=Thu, 4 Feb 2044 04:04:04 UTC; domain=4chan.org; path=/&quot;;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; } else {</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; document.cookie = &quot;blotter_hide=show; expires=Thu, 4 Feb 2044 04:04:04 UTC; domain=4chan.org; path=/&quot;;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; updateBlotterVisible();</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">}</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">document.write(\'&lt;div style=&quot;position:relative;&quot;&gt;&lt;div style=&quot;top:0px;left:0px;position:absolute;&quot; class=&quot;rules&quot;&gt;'</span><span class="sy0">.</span><span class="re0">$blotdate</span><span class="sy0">.</span><span class="st_h">'&lt;/div&gt;&lt;div style=&quot;top:0px;right:0px;position:absolute;&quot;&gt;&lt;a href=&quot;javascript:void(0)&quot; onclick=&quot;toggleBlotter()&quot;&gt;Show/Hide&lt;/a&gt; &lt;a href=&quot;'</span><span class="sy0">.</span>BLOTTER_URL<span class="sy0">.</span><span class="st_h">'?all&quot;&gt;Show All&lt;/a&gt;&lt;/div&gt;&lt;div id=&quot;blotter&quot; style=&quot;display:none&quot; class=&quot;rules&quot;&gt;&lt;br/&gt;\');</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&nbsp; &nbsp; &nbsp; &nbsp; document.write('</span> <span class="sy0">.</span> <span class="re0">$blotcontents</span> <span class="sy0">.</span> <span class="st_h">');</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">document.write(\'&lt;/div&gt;&lt;/div&gt;\');</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">updateBlotterVisible();</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">--&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;/script&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">&lt;/td&gt;&lt;/tr&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;&lt;/div&gt;&lt;hr&gt;</span></div></li>
<li class="li2"><div class="de2"><span class="st_h">&lt;script&gt;with(document.post) {name.value=get_cookie(&quot;4chan_name&quot;); email.value=get_cookie(&quot;4chan_email&quot;); pwd.value=get_pass(&quot;4chan_pass&quot;); }&lt;/script&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="st_h">'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="co1">// closed thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>../&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> accesskey=<span class="es1">\&quot;</span>a<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_RETURN<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;]&lt;hr&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; form_ads<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;table style=&quot;text-align:center;width:100%;height:300px;&quot;&gt;&lt;tr valign=&quot;middle&quot;&gt;&lt;td align=&quot;center&quot;&gt;&lt;font color=red size=5 style=&quot;&quot;&gt;&lt;b&gt;Thread closed.&lt;br/&gt;You may not reply at this time.&lt;/b&gt;&lt;/font&gt;&lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>BANROT_AD<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/*if(!$banadquery=mysql_global_call(&quot;select url,img from &quot;.BANROTLOG.&quot; order by rand() limit 1&quot;)){echo S_SQLFAIL;}</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $banadrow=mysql_fetch_row($banadquery);</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list($ba_url,$ba_img)=$banadrow;*/</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;center&gt;'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'TOPAD_TABLE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$topad</span><span class="sy0">,</span> <span class="re0">$toplink</span><span class="br0">&#41;</span> <span class="sy0">=</span> rid<span class="br0">&#40;</span>TOPAD_TABLE<span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$toplink</span><span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;&lt;img style=<span class="es1">\&quot;</span>border:1px solid black;<span class="es1">\&quot;</span> src=<span class="es1">\&quot;</span><span class="es4">$topad</span><span class="es1">\&quot;</span> width=468 height=60 border=0 /&gt;&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> rotating_ad_banner<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/*</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;a href=&quot;http://webhosting.cologuys.com&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/CG_100x60_2.gif&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($ba_url != &quot;&quot;) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;a href=&quot;'.BANROT_PHP.'?url='.$ba_url.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }*/</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>BANROT2_AD<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/*&nbsp; &nbsp; &nbsp; $dat .= @file_get_contents('/www/global/topad.txt');</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;a href=&quot;http://webhosting.cologuys.com&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/CG_100x60_2.gif&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.=&quot;&lt;/center&gt;&lt;hr&gt;\n&quot;;*/</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">elseif</span> <span class="br0">&#40;</span>BANROT_B<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/*if(!$banadquery=mysql_global_call(&quot;select url,img from &quot;.BANROT_B_LOG.&quot; where DATE_SUB(CURDATE(),INTERVAL 30 DAY) &lt;= installed) ORDER BY RAND() limit 1&quot;)){echo S_SQLFAIL;}</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $banadrow=mysql_fetch_row($banadquery);</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list($ba_url,$ba_img)=$banadrow;</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;br/&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($ba_url != &quot;&quot;) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;a href=&quot;'.$ba_url.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.='&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;';</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dat.=&quot;&lt;br&gt;&lt;a href=\&quot;http://www.4chan.org/advertise/\&quot; target=\&quot;_blank\&quot;&gt;&lt;small&gt;Buy a banner for this board!&lt;/small&gt;&lt;/a&gt;&lt;/center&gt;&lt;hr&gt;\n&quot;;*/</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span>NOT4CHAN<span class="sy0">!=</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> BANROT_AD<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">||</span> BANROT2_AD<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$dat.=&quot;&lt;br&gt;&lt;a href=\&quot;http://www.4chan.org/advertise/\&quot; target=\&quot;_blank\&quot;&gt;&lt;small&gt;Advertise with 4chan!&lt;/small&gt;&lt;/a&gt;&lt;/center&gt;&lt;hr&gt;\n&quot;;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/center&gt;&lt;hr&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'GLOBAL_MSG'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> GLOBAL_MSG<span class="sy0">!=</span><span class="st_h">''</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span>GLOBAL_MSG<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&lt;hr&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">=</span> broomcloset_form<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> delete_uploaded_files<span class="br0">&#40;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$upfile_name</span><span class="sy0">,</span><span class="re0">$path</span><span class="sy0">,</span><span class="re0">$upfile</span><span class="sy0">,</span><span class="re0">$dest</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="sy0">||</span><span class="re0">$upfile</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$upfile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es4">$dest</span>.pch&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* Footer */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> foot<span class="br0">&#40;</span><span class="sy0">&amp;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="kw2">global</span> <span class="re0">$update_avg_secs</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="re0">$include2</span><span class="sy0">=</span>file_get_contents_cached<span class="br0">&#40;</span>NAV2_TXT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* $dat.='&lt;div class=&quot;footer&quot;&gt;'.S_FOOT.'&lt;/div&gt;</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">'.$include2.'</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&lt;/body&gt;&lt;/html&gt;';*/</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span><span class="st0">&quot;<span class="es4">$include2</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$update_avg_secs</span><span class="br0">&#41;</span> <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;!-- <span class="es4">$update_avg_secs</span> s --&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> error<span class="br0">&#40;</span><span class="re0">$mes</span><span class="sy0">,</span><span class="re0">$unused</span><span class="sy0">=</span><span class="st_h">''</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; delete_uploaded_files<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; head<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; form_ads<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//echo &quot;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&lt;br&gt;&lt;br&gt;\n&lt;center&gt;&lt;font color=red size=5&gt;&lt;b&gt;$mes&lt;br&gt;&lt;br&gt;&lt;a href=&quot;;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st_h">'&lt;table style=&quot;text-align:center;width:100%;height:300px;&quot;&gt;&lt;tr valign=&quot;middle&quot;&gt;&lt;td align=&quot;center&quot;&gt;&lt;font color=red size=5 style=&quot;&quot;&gt;&lt;b&gt;'</span> <span class="sy0">.</span> <span class="re0">$mes</span> <span class="sy0">.</span> <span class="st_h">'&lt;br&gt;&lt;br&gt;&lt;a href='</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REQUEST_URI'</span><span class="br0">&#93;</span><span class="sy0">,</span>RES_DIR<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;../&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//echo PHP_SELF2.&quot;&gt;&quot;.S_RELOAD.&quot;&lt;/a&gt;&lt;/b&gt;&lt;/font&gt;&lt;/center&gt;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&quot;;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> &nbsp;PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;&gt;&quot;</span><span class="sy0">.</span>S_RELOAD<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;&lt;/b&gt;&lt;/font&gt;&lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>BANROT_AD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'TOPAD_TABLE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span><span class="sy0">.=</span><span class="st_h">'&lt;center&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> rotating_ad_banner<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>BOTTOM_AD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;hr size=1&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="kw1">if</span><span class="br0">&#40;</span>BOTTOM_AD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$bottomad</span> <span class="sy0">=</span> ad_text_for<span class="br0">&#40;</span>BOTTOMAD<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$bottomad</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;<span class="es4">$bottomad</span>&lt;hr&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$dat</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;/center&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; foot<span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="re0">$dat</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* Auto Linker */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> normalize_link_cb<span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$subdomain</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$original</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> <span class="kw3">strtolower</span><span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">=</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">&gt;</span><span class="nu0">2</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">--</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$no</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="kw1">break</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$subdomain</span> <span class="sy0">==</span> <span class="st_h">'www'</span> <span class="sy0">||</span> <span class="re0">$subdomain</span> <span class="sy0">==</span> <span class="st_h">'static'</span> <span class="sy0">||</span> <span class="re0">$subdomain</span> <span class="sy0">==</span> <span class="st_h">'content'</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$original</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$board</span> <span class="sy0">==</span> BOARD_DIR<span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&amp;gt;&amp;gt;<span class="es4">$no</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&amp;gt;&amp;gt;&amp;gt;/<span class="es4">$board</span>/<span class="es4">$no</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> normalize_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// change http://xxx.4chan.org/board/res/no links into plaintext &gt;&gt;# or &gt;&gt;&gt;/board/#</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$proto</span><span class="sy0">,</span><span class="st0">&quot;4chan.org&quot;</span><span class="br0">&#41;</span><span class="sy0">===</span><span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$proto</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace_callback</span><span class="br0">&#40;</span><span class="st_h">'@http://([A-za-z]*)[.]4chan[.]org/(\w+)/(?:res/(\d+)[.]html(?:#q?(\d+))?|\w+.php[?]res=(\d+)(?:#(\d+))?|)(?=[\s.&lt;!?,]|$)@i'</span><span class="sy0">,</span><span class="st_h">'normalize_link_cb'</span><span class="sy0">,</span><span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// rs.4chan.org to &gt;&gt;&gt;rs/query+string</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st_h">'@http://rs[.]4chan[.]org/\?s=([a-zA-Z0-9$_.+-]+)@i'</span><span class="sy0">,</span><span class="st_h">'&amp;gt;&amp;gt;&amp;gt;/rs/$1'</span><span class="sy0">,</span><span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$proto</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> intraboard_link_cb<span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$intraboard_cb_resno</span><span class="sy0">,</span> <span class="re0">$log</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$no</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resno</span> <span class="sy0">=</span> <span class="re0">$intraboard_cb_resno</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resto</span> <span class="sy0">=</span> <span class="re0">$log</span><span class="br0">&#91;</span><span class="re0">$no</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'resto'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resdir</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="re0">$resno</span> ? <span class="st_h">''</span> <span class="sy0">:</span> RES_DIR<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ext</span> <span class="sy0">=</span> PHP_EXT<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resno</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$resno</span><span class="sy0">==</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="co1">// linking to a reply in the same thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span> onClick=<span class="es1">\&quot;</span>replyhl('<span class="es4">$no</span>');<span class="es1">\&quot;</span>&gt;&amp;gt;&amp;gt;<span class="es4">$no</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="co1">// linking to a thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$resdir</span><span class="es4">$no</span><span class="es4">$ext</span>#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span>&gt;&amp;gt;&amp;gt;<span class="es4">$no</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="co1">// linking to a reply in another thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$resdir</span><span class="es4">$resto</span><span class="es4">$ext</span>#<span class="es4">$no</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span>&gt;&amp;gt;&amp;gt;<span class="es4">$no</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> intraboard_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="sy0">,</span> <span class="re0">$resno</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$intraboard_cb_resno</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$intraboard_cb_resno</span> <span class="sy0">=</span> <span class="re0">$resno</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace_callback</span><span class="br0">&#40;</span><span class="st_h">'/&amp;gt;&amp;gt;([0-9]+)/'</span><span class="sy0">,</span> <span class="st_h">'intraboard_link_cb'</span><span class="sy0">,</span> <span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$proto</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> interboard_link_cb<span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// on one hand, we can link to imgboard.php, using any old subdomain, </span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// and let apache &amp; imgboard.php handle it when they click on the link</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// on the other hand, we can use the database to fetch the proper subdomain</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// and even the resto to construct a proper link to the html file (and whether it exists or not)</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// for now, we'll assume there's more interboard links posted than interboard links visited.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$url</span> <span class="sy0">=</span> DATA_SERVER <span class="sy0">.</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">.</span> <span class="st_h">'/'</span> <span class="sy0">.</span> PHP_SELF <span class="sy0">.</span> <span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> ? <span class="br0">&#40;</span><span class="st_h">'?res='</span> <span class="sy0">.</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">:</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es4">$url</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span>&gt;<span class="es4">{$m[0]}</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span>&nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> interboard_rs_link_cb<span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// $m[1] might be a url-encoded query string, or might be manual-typed text</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// so we'll normalize it to raw text first and then re-encode it</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lsearchquery</span> <span class="sy0">=</span> <span class="kw3">urlencode</span><span class="br0">&#40;</span> <span class="kw3">urldecode</span><span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>http://rs.4chan.org/?s=<span class="es4">$lsearchquery</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span>&gt;<span class="es4">{$m[0]}</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> interboard_dis_link_cb<span class="br0">&#40;</span><span class="re0">$m</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$durl</span> <span class="sy0">=</span> <span class="re0">$m</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="co1">//i don't think this is useful but just in case</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span>http://dis.4chan.org/read/<span class="es4">$durl</span><span class="es1">\&quot;</span> class=<span class="es1">\&quot;</span>quotelink<span class="es1">\&quot;</span>&gt;<span class="es4">{$m[0]}</span>&lt;/a&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> dis_matching_re<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">global</span> <span class="re0">$dis_matching_re</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$dis_matching_re</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$boards</span> <span class="sy0">=</span> <span class="kw3">file</span><span class="br0">&#40;</span><span class="st_h">'/www/global/disboards.txt'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span> <span class="br0">&#40;</span><span class="re0">$boards</span> <span class="kw1">as</span> <span class="re0">$board</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$bn</span><span class="sy0">,</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;&gt;&quot;</span><span class="sy0">,</span> <span class="re0">$board</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dis_matching_re</span> <span class="sy0">.=</span> <span class="re0">$bn</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dis_matching_re</span> <span class="sy0">.=</span> <span class="st_h">'|'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dis_matching_re</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$dis_matching_re</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//lose last |</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$dis_matching_re</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> interboard_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$boards</span> <span class="sy0">=</span> <span class="st0">&quot;an?|cm?|fa|fit|gif|h[cr]?|[bdefgkmnoprstuvxy]|wg?|ic?|y|cgl|c[ko]|mu|po|t[gv]|toy|trv|jp|r9k|sp&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$disboards</span> <span class="sy0">=</span> dis_matching_re<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace_callback</span><span class="br0">&#40;</span><span class="st_h">'@&amp;gt;&amp;gt;&amp;gt;/('</span><span class="sy0">.</span><span class="re0">$boards</span><span class="sy0">.</span><span class="st_h">')/([0-9]*)@i'</span><span class="sy0">,</span> <span class="st_h">'interboard_link_cb'</span><span class="sy0">,</span> <span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace_callback</span><span class="br0">&#40;</span><span class="st_h">'@&amp;gt;&amp;gt;&amp;gt;/rs/([^\s&lt;&gt;]+)@'</span><span class="sy0">,</span> <span class="st_h">'interboard_rs_link_cb'</span><span class="sy0">,</span> <span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace_callback</span><span class="br0">&#40;</span><span class="st_h">'@&amp;gt;&amp;gt;&amp;gt;/(('</span><span class="sy0">.</span><span class="re0">$disboards</span><span class="sy0">.</span><span class="st_h">')/[^\s&lt;&gt;]*)@i'</span><span class="sy0">,</span> <span class="st_h">'interboard_dis_link_cb'</span><span class="sy0">,</span> <span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$proto</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> auto_link<span class="br0">&#40;</span><span class="re0">$proto</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> normalize_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// auto-link remaining 4chan.org URLs if they're not part of HTML</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$proto</span><span class="sy0">,</span><span class="st0">&quot;4chan.org&quot;</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st_h">'/(http:\/\/(?:[A-Za-z]*\.)?)(4chan)(\.org)(\/)([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?/i'</span><span class="sy0">,</span><span class="st0">&quot;&lt;a href=<span class="es1">\&quot;</span><span class="es1">\\</span>0<span class="es1">\&quot;</span> target=<span class="es1">\&quot;</span>_blank<span class="es1">\&quot;</span>&gt;<span class="es1">\\</span>0&lt;/a&gt;&quot;</span><span class="sy0">,</span><span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st_h">'/([&lt;][^&gt;]*?)&lt;a href=&quot;((http:\/\/(?:[A-Za-z]*\.)?)(4chan)(\.org)(\/)([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?)&quot; target=&quot;_blank&quot;&gt;\\2&lt;\/a&gt;([^&lt;]*?[&gt;])/i'</span><span class="sy0">,</span> <span class="st_h">'\\1\\3\\4\\5\\6\\7\\8'</span><span class="sy0">,</span> <span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> intraboard_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="sy0">,</span><span class="re0">$resno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$proto</span> <span class="sy0">=</span> interboard_links<span class="br0">&#40;</span><span class="re0">$proto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$proto</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> auto_ban_poster<span class="br0">&#40;</span><span class="re0">$nametrip</span><span class="sy0">,</span> <span class="re0">$banlength</span><span class="sy0">,</span> <span class="re0">$global</span><span class="sy0">,</span> <span class="re0">$reason</span><span class="sy0">,</span> <span class="re0">$pubreason</span><span class="sy0">=</span><span class="st_h">''</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$nametrip</span><span class="br0">&#41;</span> <span class="re0">$nametrip</span> <span class="sy0">=</span> S_ANONAME<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$nametrip</span><span class="sy0">,</span> <span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!'</span><span class="br0">&#41;</span> <span class="sy0">!==</span> <span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$nameparts</span><span class="sy0">=</span><span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!'</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$nametrip</span> <span class="sy0">=</span> <span class="st0">&quot;<span class="es4">{$nameparts[0]}</span> #<span class="es4">{$nameparts[1]}</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$host</span> <span class="sy0">=</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REMOTE_ADDR'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$reverse</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="kw3">gethostbyaddr</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$xff</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="kw3">getenv</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_X_FORWARDED_FOR&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$nametrip</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$nametrip</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$global</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="re0">$global</span>?<span class="nu0">1</span><span class="sy0">:</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$reason</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$reason</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$pubreason</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$pubreason</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$pubreason</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$pubreason</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//if they're already banned on this board, don't insert again</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//since this is just a spam post</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//i don't think it matters if the active ban is global=0 and this one is global=1</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$existingq</span> <span class="sy0">=</span> mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;select count(*)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOGBAN<span class="sy0">.</span><span class="st0">&quot; where host='<span class="es4">$host</span>' and active=1 and (board='<span class="es4">$board</span>' or global=1)&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$existingban</span> <span class="sy0">=</span> <span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$existingq</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$existingban</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delete_uploaded_files<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$banlength</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// warning</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// check for recent warnings to punish spammers</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$autowarnq</span><span class="sy0">=</span>mysql_global_call<span class="br0">&#40;</span><span class="st0">&quot;SELECT COUNT(*) FROM &quot;</span><span class="sy0">.</span>SQLLOGBAN<span class="sy0">.</span><span class="st0">&quot; WHERE host='<span class="es4">$host</span>' AND admin='Auto-ban' AND now &gt; DATE_SUB(NOW(),INTERVAL 3 DAY) AND reason like '%<span class="es4">$reason</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$autowarncount</span><span class="sy0">=</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$autowarnq</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$autowarncount</span> <span class="sy0">&gt;</span> <span class="nu0">3</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$banlength</span> <span class="sy0">=</span> <span class="nu0">14</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$banlength</span> <span class="sy0">==</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="co1">// permanent</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$length</span> <span class="sy0">=</span> <span class="st_h">'0000'</span> <span class="sy0">.</span> <span class="st_h">'00'</span> <span class="sy0">.</span><span class="st_h">'00'</span><span class="sy0">;</span> <span class="co1">// YYYY/MM/DD</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$banlength</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$banlength</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$banlength</span> <span class="sy0">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="re0">$banlength</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$length</span> <span class="sy0">=</span> <span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;Ymd&quot;</span><span class="sy0">,</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="re0">$banlength</span><span class="sy0">*</span><span class="br0">&#40;</span><span class="nu0">24</span><span class="sy0">*</span><span class="nu0">60</span><span class="sy0">*</span><span class="nu0">60</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$length</span> <span class="sy0">.=</span> <span class="st0">&quot;00&quot;</span><span class="sy0">.</span><span class="st0">&quot;00&quot;</span><span class="sy0">.</span><span class="st0">&quot;00&quot;</span><span class="sy0">;</span> <span class="co1">// H:M:S</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$result</span><span class="sy0">=</span>mysql_global_do<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO &quot;</span><span class="sy0">.</span>SQLLOGBAN<span class="sy0">.</span><span class="st0">&quot; (board,global,name,host,reason,length,admin,reverse,xff) VALUES('<span class="es4">$board</span>','<span class="es4">$global</span>','<span class="es4">$nametrip</span>','<span class="es4">$host</span>','<span class="es4">$pubreason</span>&lt;b&gt;Auto-ban&lt;/b&gt;: <span class="es4">$reason</span>','<span class="es4">$length</span>','Auto-ban','<span class="es4">$reverse</span>','<span class="es4">$xff</span>')&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; append_ban<span class="br0">&#40;</span><span class="re0">$global</span> ? <span class="st0">&quot;global&quot;</span> <span class="sy0">:</span> <span class="re0">$global</span><span class="sy0">,</span> <span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> check_blacklist<span class="br0">&#40;</span><span class="re0">$post</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$querystr</span> <span class="sy0">=</span> <span class="st0">&quot;SELECT SQL_NO_CACHE * FROM blacklist WHERE active=1 AND (boardrestrict='' or boardrestrict='<span class="es4">$board</span>') AND (0 &quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$post</span> <span class="kw1">as</span> <span class="re0">$field</span><span class="sy0">=&gt;</span><span class="re0">$contents</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$contents</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$contents</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="kw3">html_entity_decode</span><span class="br0">&#40;</span><span class="re0">$contents</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$querystr</span> <span class="sy0">.=</span> <span class="st0">&quot;OR (field='<span class="es4">$field</span>' AND contents='<span class="es4">$contents</span>') &quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$querystr</span> <span class="sy0">.=</span> <span class="st0">&quot;) LIMIT 1&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span> <span class="sy0">=</span> mysql_global_call<span class="br0">&#40;</span><span class="re0">$querystr</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_assoc</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'ban'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$prvreason</span> <span class="sy0">=</span> <span class="st0">&quot;Blacklisted <span class="es4">${row['field']}</span> - &quot;</span> <span class="sy0">.</span> <span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'contents'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auto_ban_poster<span class="br0">&#40;</span><span class="re0">$post</span><span class="br0">&#91;</span><span class="st_h">'trip'</span><span class="br0">&#93;</span>?<span class="re0">$post</span><span class="br0">&#91;</span><span class="st_h">'nametrip'</span><span class="br0">&#93;</span><span class="sy0">:</span><span class="re0">$post</span><span class="br0">&#91;</span><span class="st_h">'name'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'banlength'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="re0">$prvreason</span><span class="sy0">,</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'banreason'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">// word-wrap without touching things inside of tags</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> wordwrap2<span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span><span class="re0">$cols</span><span class="sy0">,</span><span class="re0">$cut</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if there's no runs of $cols non-space characters, wordwrap is a no-op</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">&lt;</span><span class="re0">$cols</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="st_h">'/[^ &lt;&gt;]{'</span><span class="sy0">.</span><span class="re0">$cols</span><span class="sy0">.</span><span class="st_h">'}/'</span><span class="sy0">,</span> <span class="re0">$str</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$str</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sections</span> <span class="sy0">=</span> <span class="kw3">preg_split</span><span class="br0">&#40;</span><span class="st_h">'/[&lt;&gt;]/'</span><span class="sy0">,</span> <span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">&lt;</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$sections</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$i</span><span class="sy0">%</span><span class="nu19">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// inside a tag</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="st_h">'&lt;'</span> <span class="sy0">.</span> <span class="re0">$sections</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span> <span class="sy0">.</span> <span class="st_h">'&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="co1">// outside a tag</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$words</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">' '</span><span class="sy0">,</span><span class="re0">$sections</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$words</span> <span class="kw1">as</span> <span class="sy0">&amp;</span><span class="re0">$word</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$word</span> <span class="sy0">=</span> <span class="kw3">wordwrap</span><span class="br0">&#40;</span><span class="re0">$word</span><span class="sy0">,</span> <span class="re0">$cols</span><span class="sy0">,</span> <span class="re0">$cut</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// fix utf-8 sequences (XXX: is this slower than mbstring?)</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lines</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="re0">$cut</span><span class="sy0">,</span> <span class="re0">$word</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$j</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span><span class="re0">$j</span><span class="sy0">&lt;</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$lines</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="re0">$j</span><span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// all lines except the first</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$chr</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$lines</span><span class="br0">&#91;</span><span class="re0">$j</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">ord</span><span class="br0">&#40;</span><span class="re0">$chr</span><span class="br0">&#41;</span> <span class="sy0">&amp;</span> <span class="nu12">0xC0</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu12">0x80</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// if chr is a UTF-8 continuation...</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lines</span><span class="br0">&#91;</span><span class="re0">$j</span><span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">.=</span> <span class="re0">$chr</span><span class="sy0">;</span> <span class="co1">// put it on the end of the previous line</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$lines</span><span class="br0">&#91;</span><span class="re0">$j</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$lines</span><span class="br0">&#91;</span><span class="re0">$j</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// take it off the current line</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">continue</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span> <span class="co1">// chr was a beginning utf-8 character</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$word</span> <span class="sy0">=</span> <span class="kw3">implode</span><span class="br0">&#40;</span><span class="re0">$cut</span><span class="sy0">,</span> <span class="re0">$lines</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">implode</span><span class="br0">&#40;</span><span class="st_h">' '</span><span class="sy0">,</span> <span class="re0">$words</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$str</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> cidrtest <span class="br0">&#40;</span><span class="re0">$longip</span><span class="sy0">,</span> <span class="re0">$CIDR</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span> <span class="br0">&#40;</span><span class="re0">$net</span><span class="sy0">,</span> <span class="re0">$mask</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">split</span> <span class="br0">&#40;</span><span class="st0">&quot;/&quot;</span><span class="sy0">,</span> <span class="re0">$CIDR</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ip_net</span> <span class="sy0">=</span> <span class="kw3">ip2long</span> <span class="br0">&#40;</span><span class="re0">$net</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ip_mask</span> <span class="sy0">=</span> ~<span class="br0">&#40;</span><span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">&lt;&lt;</span> <span class="br0">&#40;</span><span class="nu0">32</span> <span class="sy0">-</span> <span class="re0">$mask</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ip_ip</span> <span class="sy0">=</span> <span class="re0">$longip</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ip_ip_net</span> <span class="sy0">=</span> <span class="re0">$ip_ip</span> <span class="sy0">&amp;</span> <span class="re0">$ip_mask</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="br0">&#40;</span><span class="re0">$ip_ip_net</span> <span class="sy0">==</span> <span class="re0">$ip_net</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> &nbsp;proxy_connect<span class="br0">&#40;</span><span class="re0">$port</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$fp</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">fsockopen</span> <span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st0">&quot;REMOTE_ADDR&quot;</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$port</span><span class="sy0">,</span><span class="re0">$a</span><span class="sy0">,</span><span class="re0">$b</span><span class="sy0">,</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$fp</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span><span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span><span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> processlist_cleanup<span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st_h">'Done'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//mysql_board_call(&quot;DELETE FROM proclist WHERE id='$id'&quot;);</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> logtime<span class="br0">&#40;</span><span class="re0">$desc</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; static <span class="re0">$run</span> <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'PROFILING'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'PROCESSLIST'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$run</span><span class="sy0">==-</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$run</span> <span class="sy0">=</span> <span class="kw3">getmypid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// rand(0,16777215);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>PROCESSLIST <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">register_shutdown_function</span><span class="br0">&#40;</span><span class="st_h">'processlist_cleanup'</span><span class="sy0">,</span> <span class="re0">$run</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dump</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="kw3">serialize</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'GET'</span><span class="sy0">=&gt;</span><span class="re0">$_GET</span><span class="sy0">,</span><span class="st_h">'POST'</span><span class="sy0">=&gt;</span><span class="re0">$_POST</span><span class="sy0">,</span><span class="st_h">'SERVER'</span><span class="sy0">=&gt;</span><span class="re0">$_SERVER</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO proclist VALUES ('<span class="es4">$run</span>','<span class="es4">$dump</span>','')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>PROCESSLIST <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;UPDATE proclist SET descr='<span class="es4">$desc</span>' WHERE id='<span class="es4">$run</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$board</span> <span class="sy0">=</span> BOARD_DIR<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$time</span> <span class="sy0">=</span> <span class="kw3">microtime</span><span class="br0">&#40;</span><span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_global_call<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO prof_times VALUES ('<span class="es4">$board</span>',<span class="es4">$run</span>,<span class="es4">$time</span>,'<span class="es4">$desc</span>')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> make_american<span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="st0">&quot;america&quot;</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$com</span><span class="sy0">;</span> <span class="co1">//already american</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">rtrim</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$end</span> <span class="sy0">=</span> <span class="st_h">'!'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$com</span> <span class="sy0">==</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$com</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="st0">&quot;/([.!?])$/&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="sy0">,</span> <span class="re0">$matches</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="re0">$end</span> <span class="sy0">=</span> <span class="re0">$matches</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">.=</span> <span class="st0">&quot; IN AMERICA&quot;</span><span class="sy0">.</span><span class="re0">$end</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$com</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="coMULTI">/* Regist */</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> regist<span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span><span class="re0">$email</span><span class="sy0">,</span><span class="re0">$sub</span><span class="sy0">,</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$url</span><span class="sy0">,</span><span class="re0">$pwd</span><span class="sy0">,</span><span class="re0">$upfile</span><span class="sy0">,</span><span class="re0">$upfile_name</span><span class="sy0">,</span><span class="re0">$resto</span><span class="sy0">,</span><span class="re0">$age</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw2">global</span> <span class="re0">$path</span><span class="sy0">,</span><span class="re0">$pwdc</span><span class="sy0">,</span><span class="re0">$textonly</span><span class="sy0">,</span><span class="re0">$admin</span><span class="sy0">,</span><span class="re0">$spoiler</span><span class="sy0">,</span><span class="re0">$dest</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$pwd</span><span class="sy0">==</span>ADMIN_PASS<span class="br0">&#41;</span> <span class="re0">$admin</span><span class="sy0">=</span><span class="re0">$pwd</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$admin</span><span class="sy0">!=</span>ADMIN_PASS <span class="sy0">||</span> <span class="sy0">!</span>valid<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="re0">$admin</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$mes</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$upfile</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// allow textonly threads for moderators!</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>valid<span class="br0">&#40;</span><span class="st_h">'textonly'</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$textonly</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// only allow mods/janitors to post, and textonly is always ok</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$textonly</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>valid<span class="br0">&#40;</span><span class="st_h">'janitor_board'</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// time</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$time</span> <span class="sy0">=</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$tim</span> <span class="sy0">=</span> <span class="re0">$time</span><span class="sy0">.</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="kw3">microtime</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">2</span><span class="sy0">,</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;<span class="coMULTI">/* logtime(&quot;locking tables: &quot;.($resto?'reply':'thread').&quot;, &quot;.($upfile?'image':'text'));</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; if(PROCESSLIST == 1 &amp;&amp; BOARD_DIR != 'b' &amp;&amp; 0) {</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; if(!mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE,proclist WRITE&quot;))</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; die(S_SQLCONF.'&lt;!--lk:'.mysql_errno().'--&gt;');</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; }</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; else if(BOARD_DIR != 'b' &amp;&amp; 0) {</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; if(!mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE&quot;))</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; die(S_SQLCONF.'&lt;!--lk:'.mysql_errno().'--&gt;');</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">}</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; logtime(&quot;got lock&quot;);*/</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$locked_time</span> <span class="sy0">=</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;set session query_cache_type=0&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// check closed</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$resto</span><span class="sy0">=</span><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$resto</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$cchk</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select closed from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=&quot;</span><span class="sy0">.</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$closed</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$cchk</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$closed</span><span class="sy0">==</span><span class="nu0">1</span><span class="sy0">&amp;&amp;!</span><span class="re0">$admin</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span><span class="st0">&quot;You can't reply to this thread anymore.&quot;</span><span class="sy0">,</span><span class="re0">$upfile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$cchk</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_chk'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">require_once</span> <span class="st_h">'oekaki.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oe_regist_check<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$upfile</span> <span class="sy0">=</span> <span class="kw3">realpath</span><span class="br0">&#40;</span><span class="st_h">'tmp/'</span> <span class="sy0">.</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_ip'</span><span class="br0">&#93;</span> <span class="sy0">.</span> <span class="st_h">'.png'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$upfile_name</span> <span class="sy0">=</span> <span class="st_h">'Oekaki'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$pchfile</span> <span class="sy0">=</span> <span class="kw3">realpath</span><span class="br0">&#40;</span><span class="st_h">'tmp/'</span> <span class="sy0">.</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_ip'</span><span class="br0">&#93;</span> <span class="sy0">.</span> <span class="st_h">'.pch'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$pchfile</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$pchfile</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$has_image</span> <span class="sy0">=</span> <span class="re0">$upfile</span><span class="sy0">&amp;&amp;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$upfile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$has_image</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="co1">// check image limit</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select COUNT(*) from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where resto=<span class="es4">$resto</span> and fsize!=0&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$countimgres</span><span class="sy0">=</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$countimgres</span><span class="sy0">&gt;</span>MAX_IMGRES<span class="br0">&#41;</span> error<span class="br0">&#40;</span><span class="st0">&quot;Max limit of &quot;</span><span class="sy0">.</span>MAX_IMGRES<span class="sy0">.</span><span class="st0">&quot; image replies has been reached.&quot;</span><span class="sy0">,</span><span class="re0">$upfile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//upload processing</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dest</span> <span class="sy0">=</span> <span class="kw3">tempnam</span><span class="br0">&#40;</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;img&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$dest = $path.$tim.'.tmp';</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_chk'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="re0">$upfile</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">chmod</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="sy0">,</span> <span class="nu8">0644</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$pchfile</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="re0">$pchfile</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es4">$dest</span>.pch&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">move_uploaded_file</span><span class="br0">&#40;</span><span class="re0">$upfile</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">clearstatcache</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// otherwise $dest looks like 0 bytes!</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Moved uploaded file&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$upfile_name</span> <span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$upfile_name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$fsize</span><span class="sy0">=</span><span class="kw3">filesize</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_file</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$fsize</span> <span class="sy0">||</span> <span class="re0">$fsize</span><span class="sy0">&gt;</span>MAX_KB <span class="sy0">*</span> <span class="nu0">1024</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_TOOBIG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">// PDF processing</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>ENABLE_PDF<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">strcasecmp</span><span class="br0">&#40;</span><span class="st_h">'.pdf'</span><span class="sy0">,</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$upfile_name</span><span class="sy0">,-</span><span class="nu0">4</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ext</span><span class="sy0">=</span><span class="st_h">'.pdf'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$W</span><span class="sy0">=</span><span class="re0">$H</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span> &nbsp; &nbsp;&nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$md5</span> <span class="sy0">=</span> md5_of_file<span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// run through ghostscript to check for validity</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">pclose</span><span class="br0">&#40;</span><span class="kw3">popen</span><span class="br0">&#40;</span><span class="st0">&quot;/usr/local/bin/gs -q -dSAFER -dNOPAUSE -dBATCH -sDEVICE=nullpage <span class="es4">$dest</span>&quot;</span><span class="sy0">,</span><span class="st_h">'w'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">getimagesize</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_array</span><span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#41;</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_NOREC<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$md5</span> <span class="sy0">=</span> md5_of_file<span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">//chmod($dest,0666);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$W</span> <span class="sy0">=</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$H</span> <span class="sy0">=</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">switch</span> <span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">1</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.gif&quot;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">2</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.jpg&quot;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">3</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.png&quot;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">4</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.swf&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">5</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.psd&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">6</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.bmp&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">7</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.tiff&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">8</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.tiff&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">9</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.jpc&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">10</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.jp2&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">11</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.jpx&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">13</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.swf&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">default</span> <span class="sy0">:</span> <span class="re0">$ext</span><span class="sy0">=</span><span class="st0">&quot;.xxx&quot;</span><span class="sy0">;</span>error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>GIF_ONLY <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="co1">// end PDF processing -else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$insfile</span><span class="sy0">=</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$upfile_name</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="sy0">-</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; spam_filter_post_image<span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="sy0">,</span> <span class="re0">$md5</span><span class="sy0">,</span> <span class="re0">$upfile_name</span><span class="sy0">,</span> <span class="re0">$ext</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="co1">// Picture reduction</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxw</span> <span class="sy0">=</span> MAX_W<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxh</span> <span class="sy0">=</span> MAX_H<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxw</span> <span class="sy0">=</span> MAXR_W<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxh</span> <span class="sy0">=</span> MAXR_H<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'MIN_W'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> MIN_W <span class="sy0">&gt;</span> <span class="re0">$W</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'MIN_H'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> MIN_H <span class="sy0">&gt;</span> <span class="re0">$H</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'MAX_DIMENSION'</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxdimension</span> <span class="sy0">=</span> MAX_DIMENSION<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxdimension</span> <span class="sy0">=</span> <span class="nu0">5000</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$W</span> <span class="sy0">&gt;</span> <span class="re0">$maxdimension</span> <span class="sy0">||</span> <span class="re0">$H</span> <span class="sy0">&gt;</span> <span class="re0">$maxdimension</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_TOOBIGRES<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="re0">$W</span> <span class="sy0">&gt;</span> <span class="re0">$maxw</span> <span class="sy0">||</span> <span class="re0">$H</span> <span class="sy0">&gt;</span> <span class="re0">$maxh</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$W2</span> <span class="sy0">=</span> <span class="re0">$maxw</span> <span class="sy0">/</span> <span class="re0">$W</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$H2</span> <span class="sy0">=</span> <span class="re0">$maxh</span> <span class="sy0">/</span> <span class="re0">$H</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#40;</span><span class="re0">$W2</span> <span class="sy0">&lt;</span> <span class="re0">$H2</span><span class="br0">&#41;</span> ? <span class="re0">$key</span> <span class="sy0">=</span> <span class="re0">$W2</span> <span class="sy0">:</span> <span class="re0">$key</span> <span class="sy0">=</span> <span class="re0">$H2</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$TN_W</span> <span class="sy0">=</span> <span class="kw3">ceil</span><span class="br0">&#40;</span><span class="re0">$W</span> <span class="sy0">*</span> <span class="re0">$key</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$TN_H</span> <span class="sy0">=</span> <span class="kw3">ceil</span><span class="br0">&#40;</span><span class="re0">$H</span> <span class="sy0">*</span> <span class="re0">$key</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$mes</span> <span class="sy0">=</span> <span class="re0">$upfile_name</span> <span class="sy0">.</span> <span class="st_h">' '</span> <span class="sy0">.</span> S_UPGOOD<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_chk'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;error&quot;</span><span class="br0">&#93;</span><span class="sy0">&gt;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;error&quot;</span><span class="br0">&#93;</span><span class="sy0">==</span>UPLOAD_ERR_INI_SIZE<span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_TOOBIG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;error&quot;</span><span class="br0">&#93;</span><span class="sy0">==</span>UPLOAD_ERR_FORM_SIZE<span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_TOOBIG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;error&quot;</span><span class="br0">&#93;</span><span class="sy0">==</span>UPLOAD_ERR_PARTIAL<span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;error&quot;</span><span class="br0">&#93;</span><span class="sy0">==</span>UPLOAD_ERR_CANT_WRITE<span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_UPFAIL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$upfile_name</span><span class="sy0">&amp;&amp;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st0">&quot;upfile&quot;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st0">&quot;size&quot;</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; error<span class="br0">&#40;</span>S_TOOBIGORNONE<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>ENABLE_EXIF<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exif</span> <span class="sy0">=</span> <span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="kw3">shell_exec</span><span class="br0">&#40;</span><span class="st0">&quot;/usr/local/bin/exiftags <span class="es4">$dest</span>&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//The last result number</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$lastno</span> <span class="sy0">=</span> <span class="kw3">mysql_result</span><span class="br0">&#40;</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select max(no) from &quot;</span><span class="sy0">.</span>SQLLOG<span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$resto</span><span class="sy0">=</span><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$resto</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select count(no) from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where root&gt;0 and no=<span class="es4">$resto</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_NOTHREADERR<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st0">&quot;REQUEST_METHOD&quot;</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="st0">&quot;POST&quot;</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UNJUST<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// Form content check</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$name</span><span class="sy0">||</span><span class="kw3">ereg</span><span class="br0">&#40;</span><span class="st0">&quot;^[ |&amp;#12288;|]*$&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$name</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$com</span><span class="sy0">||</span><span class="kw3">ereg</span><span class="br0">&#40;</span><span class="st0">&quot;^[ |&amp;#12288;|<span class="es1">\t</span>]*$&quot;</span><span class="sy0">,</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$com</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$sub</span><span class="sy0">||</span><span class="kw3">ereg</span><span class="br0">&#40;</span><span class="st0">&quot;^[ |&amp;#12288;|]*$&quot;</span><span class="sy0">,</span><span class="re0">$sub</span><span class="br0">&#41;</span><span class="br0">&#41;</span> &nbsp; <span class="re0">$sub</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>NO_TEXTONLY<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$admin</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="sy0">&amp;&amp;!</span><span class="re0">$has_image</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_NOPIC<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="sy0">&amp;&amp;!</span><span class="re0">$textonly</span><span class="sy0">&amp;&amp;!</span><span class="re0">$has_image</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_NOPIC<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$has_image</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_NOTEXT<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;<span class="re0">$name</span><span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span>S_MANAGEMENT<span class="sy0">,</span><span class="st0">&quot;<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>S_MANAGEMENT<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="re0">$name</span><span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span>S_DELETION<span class="sy0">,</span><span class="st0">&quot;<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>S_DELETION<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$admin</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">2000</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_TOOLONG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">100</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_TOOLONG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">100</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_TOOLONG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">100</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_TOOLONG<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">10</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UNUSUAL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$url</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">10</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span>S_UNUSUAL<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">logtime<span class="br0">&#40;</span><span class="st0">&quot;starting autoban checks&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; spam_filter_post_content<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="re0">$sub</span><span class="sy0">,</span> <span class="re0">$name</span><span class="sy0">,</span> <span class="re0">$fsize</span><span class="sy0">,</span> <span class="re0">$resto</span><span class="sy0">,</span> <span class="re0">$W</span><span class="sy0">,</span> <span class="re0">$H</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="sy0">,</span> <span class="re0">$upfile_name</span><span class="sy0">,</span> <span class="re0">$email</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//host check</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//$host = gethostbyaddr($_SERVER[&quot;REMOTE_ADDR&quot;]);</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$host</span> <span class="sy0">=</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st0">&quot;REMOTE_ADDR&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//lol /b/</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$xff</span> <span class="sy0">=</span> <span class="kw3">getenv</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_X_FORWARDED_FOR&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; spam_filter_post_ip<span class="br0">&#40;</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;inserting xff&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>SAVE_XFF<span class="sy0">==</span><span class="nu0">1</span><span class="sy0">&amp;&amp;</span><span class="kw3">getenv</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_X_FORWARDED_FOR&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; mysql_global_do<span class="br0">&#40;</span><span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO xff (tim,board,host) VALUES ('<span class="es6">%s</span>','<span class="es6">%s</span>','<span class="es6">%s</span>')&quot;</span><span class="sy0">,</span> <span class="re0">$tim</span><span class="sy0">,</span>BOARD_DIR<span class="sy0">,</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="kw3">getenv</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_X_FORWARDED_FOR&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// No, path, time, and url format</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$pwd</span><span class="sy0">==</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$pwdc</span><span class="sy0">==</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$pwd</span><span class="sy0">=</span><span class="kw3">rand</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="re0">$pwd</span><span class="sy0">=</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$pwd</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">8</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$pwd</span><span class="sy0">=</span><span class="re0">$pwdc</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$c_pass</span> <span class="sy0">=</span> <span class="re0">$pwd</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$pass</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="re0">$pwd</span><span class="br0">&#41;</span> ? <span class="kw3">substr</span><span class="br0">&#40;</span><span class="kw3">md5</span><span class="br0">&#40;</span><span class="re0">$pwd</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="nu0">2</span><span class="sy0">,</span><span class="nu0">8</span><span class="br0">&#41;</span> <span class="sy0">:</span> <span class="st0">&quot;*&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="re0">$youbi</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span>S_SUN<span class="sy0">,</span> S_MON<span class="sy0">,</span> S_TUE<span class="sy0">,</span> S_WED<span class="sy0">,</span> S_THU<span class="sy0">,</span> S_FRI<span class="sy0">,</span> S_SAT<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$yd</span> <span class="sy0">=</span> <span class="re0">$youbi</span><span class="br0">&#91;</span><span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;w&quot;</span><span class="sy0">,</span> <span class="re0">$time</span><span class="br0">&#41;</span><span class="br0">&#93;</span> <span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>SHOW_SECONDS <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$now</span> <span class="sy0">=</span> <span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;m/d/y&quot;</span><span class="sy0">,</span><span class="re0">$time</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;(&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span>string<span class="br0">&#41;</span><span class="re0">$yd</span><span class="sy0">.</span><span class="st0">&quot;)&quot;</span><span class="sy0">.</span><span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;H:i:s&quot;</span><span class="sy0">,</span><span class="re0">$time</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$now</span> <span class="sy0">=</span> <span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;m/d/y&quot;</span><span class="sy0">,</span><span class="re0">$time</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;(&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span>string<span class="br0">&#41;</span><span class="re0">$yd</span><span class="sy0">.</span><span class="st0">&quot;)&quot;</span><span class="sy0">.</span><span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;H:i&quot;</span><span class="sy0">,</span><span class="re0">$time</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>DISP_ID<span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="sy0">&amp;&amp;</span>DISP_ID<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$now</span> <span class="sy0">.=</span> <span class="st0">&quot; ID:???&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$now</span><span class="sy0">.=</span><span class="st0">&quot; ID:&quot;</span><span class="sy0">.</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="kw3">crypt</span><span class="br0">&#40;</span><span class="kw3">md5</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st0">&quot;REMOTE_ADDR&quot;</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">'id'</span><span class="sy0">.</span><span class="kw3">date</span><span class="br0">&#40;</span><span class="st0">&quot;Ymd&quot;</span><span class="sy0">,</span> <span class="re0">$time</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="st_h">'id'</span><span class="br0">&#41;</span><span class="sy0">,+</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$c_name</span> <span class="sy0">=</span> <span class="re0">$name</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$c_email</span> <span class="sy0">=</span> <span class="re0">$email</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// now that the cookie_name and _email are separated, we can modify the real ones</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> <span class="re0">$_COOKIE</span><span class="br0">&#91;</span><span class="st_h">'4chan_auser'</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$email</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//Text plastic surgery (rorororor)</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$email</span><span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;<span class="re0">$email</span><span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;[<span class="es1">\r</span><span class="es1">\n</span>]&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$email</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$sub</span> &nbsp;<span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$sub</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp;<span class="re0">$sub</span> &nbsp;<span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;[<span class="es1">\r</span><span class="es1">\n</span>]&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$sub</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$url</span> &nbsp;<span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$url</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp;<span class="re0">$url</span> &nbsp;<span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;[<span class="es1">\r</span><span class="es1">\n</span>]&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$url</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$resto</span><span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;<span class="re0">$resto</span><span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;[<span class="es1">\r</span><span class="es1">\n</span>]&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$com</span> &nbsp;<span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>SPOILERS<span class="sy0">==</span><span class="nu0">1</span><span class="sy0">&amp;&amp;</span><span class="re0">$spoiler</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sub</span> <span class="sy0">=</span> <span class="st0">&quot;SPOILER&lt;&gt;<span class="es4">$sub</span>&quot;</span><span class="sy0">;</span> </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// Standardize new character lines</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span> <span class="st0">&quot;<span class="es1">\r</span><span class="es1">\n</span>&quot;</span><span class="sy0">,</span> &nbsp;<span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span> <span class="st0">&quot;<span class="es1">\r</span>&quot;</span><span class="sy0">,</span> &nbsp;<span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//$com = preg_replace(&quot;/\A([0-9A-Za-z]{10})+\Z/&quot;, &quot;!s8AAL8z!&quot;, $com);</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// Continuous lines</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es1">\n</span>((&amp;#12288;| )*<span class="es1">\n</span>){3,}&quot;</span><span class="sy0">,</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">,</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$admin</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">&gt;</span>MAX_LINES<span class="br0">&#41;</span> error<span class="br0">&#40;</span><span class="st0">&quot;Error: Too many lines.&quot;</span><span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">nl2br</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//br is substituted before newline char</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">,</span> &nbsp;<span class="st0">&quot;&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; <span class="co1">//\n is erased</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>ROBOT9000<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> &nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="kw1">include</span> <span class="st_h">'/www/global/plugins/robot9000.php'</span><span class="sy0">;</span> &nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="re0">$r9k</span> <span class="sy0">=</span> robot9000<span class="br0">&#40;</span><span class="re0">$r9kname</span><span class="sy0">,</span><span class="re0">$email</span><span class="sy0">,</span><span class="re0">$sub</span><span class="sy0">,</span><span class="re0">$com</span><span class="sy0">,</span><span class="re0">$md5</span><span class="sy0">,</span><span class="kw3">ip2long</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">,</span>valid<span class="br0">&#40;</span><span class="st_h">'floodbypass'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$r9k</span> <span class="sy0">!=</span> <span class="st0">&quot;ok&quot;</span><span class="br0">&#41;</span> error<span class="br0">&#40;</span><span class="re0">$r9k</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; </div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>ENABLE_EXIF<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$exif</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//turn exif into a table</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exiflines</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">,</span><span class="re0">$exif</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exif</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;table class=<span class="es1">\&quot;</span>exif<span class="es1">\&quot;</span> id=<span class="es1">\&quot;</span>exif<span class="es4">$tim</span><span class="es1">\&quot;</span> style=<span class="es1">\&quot;</span>display:none;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$exiflines</span> <span class="kw1">as</span> <span class="re0">$exifline</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$exiftag</span><span class="sy0">,</span><span class="re0">$exifvalue</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">': '</span><span class="sy0">,</span><span class="re0">$exifline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$exifvalue</span> <span class="sy0">!=</span> <span class="st_h">''</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exif</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;tr&gt;&lt;td&gt;<span class="es4">$exiftag</span>&lt;/td&gt;&lt;td&gt;<span class="es4">$exifvalue</span>&lt;/td&gt;&lt;/tr&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exif</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;tr&gt;&lt;td&gt;&lt;b&gt;<span class="es4">$exiftag</span>&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$exif</span> <span class="sy0">.=</span> <span class="st_h">'&lt;/table&gt;'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;br/&gt;&lt;span class=<span class="es1">\&quot;</span>abbr<span class="es1">\&quot;</span>&gt;EXIF data available. Click &lt;a href=<span class="es1">\&quot;</span>javascript:void(0)<span class="es1">\&quot;</span> onclick=<span class="es1">\&quot;</span>toggle('exif<span class="es4">$tim</span>')<span class="es1">\&quot;</span>&gt;here&lt;/a&gt; to show/hide.&lt;/span&gt;&lt;br/&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">.=</span> <span class="st0">&quot;<span class="es4">$exif</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_chk'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">.=</span> oe_info<span class="br0">&#40;</span><span class="re0">$dest</span><span class="sy0">,</span><span class="re0">$tim</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//$name=ereg_replace(&quot;&amp;#9670;&quot;,&quot;&amp;#9671;&quot;,$name); &nbsp;//replace filled diamond with hollow diamond (sjis)</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$name</span><span class="sy0">=</span><span class="kw3">ereg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;[<span class="es1">\r</span><span class="es1">\n</span>]&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$names</span><span class="sy0">=</span><span class="kw3">iconv</span><span class="br0">&#40;</span><span class="st0">&quot;UTF-8&quot;</span><span class="sy0">,</span> <span class="st0">&quot;CP932//IGNORE&quot;</span><span class="sy0">,</span> <span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// convert to Windows Japanese #&amp;#65355;&amp;#65345;&amp;#65357;&amp;#65353;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//start new tripcode crap</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span> <span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;#&quot;</span><span class="sy0">,</span> <span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> CleanStr<span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="st0">&quot;/\#+$/&quot;</span><span class="sy0">,</span> <span class="re0">$names</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$names</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;/\#+$/&quot;</span><span class="sy0">,</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span> <span class="re0">$names</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="st0">&quot;/\#/&quot;</span><span class="sy0">,</span> <span class="re0">$names</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$names</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;#&quot;</span><span class="sy0">,</span><span class="st0">&quot;&amp;&amp;&quot;</span><span class="sy0">,</span><span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="re0">$names</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co2"># otherwise HTML numeric entities screw up explode()!</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span> <span class="br0">&#40;</span><span class="re0">$nametemp</span><span class="sy0">,</span><span class="re0">$trip</span><span class="sy0">,</span><span class="re0">$sectrip</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;&amp;&quot;</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#&quot;</span><span class="sy0">,</span> <span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;#&quot;</span><span class="sy0">,</span><span class="re0">$names</span><span class="sy0">,</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$names</span> <span class="sy0">=</span> <span class="re0">$nametemp</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">.=</span> <span class="st0">&quot;&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$trip</span> <span class="sy0">!=</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>FORTUNE_TRIP <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$trip</span> <span class="sy0">==</span> <span class="st0">&quot;fortune&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$fortunes</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st0">&quot;Bad Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Average Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Good Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Excellent Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Reply hazy, try again&quot;</span><span class="sy0">,</span><span class="st0">&quot;Godly Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Very Bad Luck&quot;</span><span class="sy0">,</span><span class="st0">&quot;Outlook good&quot;</span><span class="sy0">,</span><span class="st0">&quot;Better not tell you now&quot;</span><span class="sy0">,</span><span class="st0">&quot;You will meet a dark handsome stranger&quot;</span><span class="sy0">,</span><span class="st0">&quot;&amp;#65399;&amp;#65408;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;(&amp;#65439;&amp;#8704;&amp;#65439;)&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473; !!!!&quot;</span><span class="sy0">,</span><span class="st0">&quot;&amp;#65288;&amp;#12288;Ãƒâ€šÃ‚Â´_&amp;#12445;`&amp;#65289;&amp;#65420;&amp;#65392;&amp;#65437; &quot;</span><span class="sy0">,</span><span class="st0">&quot;Good news will come to you by mail&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$fortunenum</span> <span class="sy0">=</span> <span class="kw3">rand</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="sy0">,</span><span class="kw3">sizeof</span><span class="br0">&#40;</span><span class="re0">$fortunes</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$fortcol</span> <span class="sy0">=</span> <span class="st0">&quot;#&quot;</span> <span class="sy0">.</span> <span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es6">%02x</span><span class="es6">%02x</span><span class="es6">%02x</span>&quot;</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="nu0">127</span><span class="sy0">+</span><span class="nu0">127</span><span class="sy0">*</span><span class="kw3">sin</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="sy0">*</span>M_PI <span class="sy0">*</span> <span class="re0">$fortunenum</span> <span class="sy0">/</span> <span class="kw3">sizeof</span><span class="br0">&#40;</span><span class="re0">$fortunes</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="nu0">127</span><span class="sy0">+</span><span class="nu0">127</span><span class="sy0">*</span><span class="kw3">sin</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="sy0">*</span>M_PI <span class="sy0">*</span> <span class="re0">$fortunenum</span> <span class="sy0">/</span> <span class="kw3">sizeof</span><span class="br0">&#40;</span><span class="re0">$fortunes</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="nu0">2</span><span class="sy0">/</span><span class="nu0">3</span> <span class="sy0">*</span> M_PI<span class="br0">&#41;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="nu0">127</span><span class="sy0">+</span><span class="nu0">127</span><span class="sy0">*</span><span class="kw3">sin</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="sy0">*</span>M_PI <span class="sy0">*</span> <span class="re0">$fortunenum</span> <span class="sy0">/</span> <span class="kw3">sizeof</span><span class="br0">&#40;</span><span class="re0">$fortunes</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">4</span><span class="sy0">/</span><span class="nu0">3</span> <span class="sy0">*</span> M_PI<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;font color=<span class="es4">$fortcol</span>&gt;&lt;b&gt;Your fortune: &quot;</span><span class="sy0">.</span><span class="re0">$fortunes</span><span class="br0">&#91;</span><span class="re0">$fortunenum</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st0">&quot;&lt;/b&gt;&lt;/font&gt;&lt;br /&gt;&lt;br /&gt;&quot;</span><span class="sy0">.</span><span class="re0">$com</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$trip</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$sectrip</span> <span class="sy0">==</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$name</span> <span class="sy0">==</span> <span class="st0">&quot;&lt;/span&gt;&quot;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$sectrip</span> <span class="sy0">==</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> S_ANONAME<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/span&gt;&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$trip</span><span class="sy0">==</span><span class="st0">&quot;fortune&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//remove fortune even if FORTUNE_TRIP is off</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$trip</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$sectrip</span> <span class="sy0">==</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$name</span> <span class="sy0">==</span> <span class="st0">&quot;&lt;/span&gt;&quot;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$sectrip</span> <span class="sy0">==</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> S_ANONAME<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/span&gt;&quot;</span><span class="sy0">,</span><span class="st0">&quot;&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$salt</span> <span class="sy0">=</span> <span class="kw3">strtr</span><span class="br0">&#40;</span><span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;/[^\.-z]/&quot;</span><span class="sy0">,</span><span class="st0">&quot;.&quot;</span><span class="sy0">,</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$trip</span><span class="sy0">.</span><span class="st0">&quot;H.&quot;</span><span class="sy0">,</span><span class="nu0">1</span><span class="sy0">,</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="st0">&quot;:;&lt;=&gt;?@[<span class="es1">\\</span>]^_`&quot;</span><span class="sy0">,</span><span class="st0">&quot;ABCDEFGabcdef&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$trip</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="kw3">crypt</span><span class="br0">&#40;</span><span class="re0">$trip</span><span class="sy0">,</span> <span class="re0">$salt</span><span class="br0">&#41;</span><span class="sy0">,-</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span><span class="sy0">.=</span><span class="st0">&quot; &lt;span class=<span class="es1">\&quot;</span>postertrip<span class="es1">\&quot;</span>&gt;!&quot;</span><span class="sy0">.</span><span class="re0">$trip</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$sectrip</span> <span class="sy0">!=</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$salt</span> <span class="sy0">=</span> <span class="st0">&quot;LOLLOLOLOLOLOLOLOLOLOLOLOLOLOLOL&quot;</span><span class="sy0">;</span> <span class="co2">#this is ONLY used if the host doesn't have openssl</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co2">#I don't know a better way to get random data</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span>SALTFILE<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co2">#already generated a key</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$salt</span> <span class="sy0">=</span> <span class="kw3">file_get_contents</span><span class="br0">&#40;</span>SALTFILE<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">system</span><span class="br0">&#40;</span><span class="st0">&quot;openssl rand 448 &gt; '&quot;</span><span class="sy0">.</span>SALTFILE<span class="sy0">.</span><span class="st0">&quot;'&quot;</span><span class="sy0">,</span><span class="re0">$err</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$err</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">chmod</span><span class="br0">&#40;</span>SALTFILE<span class="sy0">,</span><span class="nu8">0400</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$salt</span> <span class="sy0">=</span> <span class="kw3">file_get_contents</span><span class="br0">&#40;</span>SALTFILE<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sha</span> <span class="sy0">=</span> <span class="kw3">base64_encode</span><span class="br0">&#40;</span><span class="kw3">pack</span><span class="br0">&#40;</span><span class="st0">&quot;H*&quot;</span><span class="sy0">,</span><span class="kw3">sha1</span><span class="br0">&#40;</span><span class="re0">$sectrip</span><span class="sy0">.</span><span class="re0">$salt</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sha</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$sha</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">11</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$trip</span><span class="sy0">==</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span> <span class="re0">$name</span><span class="sy0">.=</span><span class="st0">&quot; &lt;span class=<span class="es1">\&quot;</span>postertrip<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span><span class="sy0">.=</span><span class="st0">&quot;!!&quot;</span><span class="sy0">.</span><span class="re0">$sha</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="co1">//end new tripcode crap</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$name</span><span class="br0">&#41;</span> <span class="re0">$name</span><span class="sy0">=</span>S_ANONAME<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="re0">$com</span><span class="sy0">=</span>S_ANOTEXT<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$sub</span><span class="br0">&#41;</span> <span class="re0">$sub</span><span class="sy0">=</span>S_ANOTITLE<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>DICE_ROLL<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="st0">&quot;/dice[ +](<span class="es1">\\</span>d+)[ d+](<span class="es1">\\</span>d+)(([ +-]+?)(-?<span class="es1">\\</span>d+))?/&quot;</span><span class="sy0">,</span> <span class="re0">$email</span><span class="sy0">,</span> <span class="re0">$match</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicetxt</span> <span class="sy0">=</span> <span class="st0">&quot;rolled &quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicenum</span> <span class="sy0">=</span> <span class="kw3">min</span><span class="br0">&#40;</span><span class="nu0">25</span><span class="sy0">,</span> <span class="re0">$match</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$diceside</span> <span class="sy0">=</span> <span class="re0">$match</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$diceaddexpr</span> <span class="sy0">=</span> <span class="re0">$match</span><span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicesign</span> <span class="sy0">=</span> <span class="re0">$match</span><span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$diceadd</span> <span class="sy0">=</span> <span class="kw3">intval</span><span class="br0">&#40;</span><span class="re0">$match</span><span class="br0">&#91;</span><span class="nu0">5</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span> <span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$dicenum</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicerand</span> <span class="sy0">=</span> <span class="kw3">mt_rand</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="sy0">,</span> <span class="re0">$diceside</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$i</span><span class="br0">&#41;</span> <span class="re0">$dicetxt</span> <span class="sy0">.=</span> <span class="st0">&quot;, &quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicetxt</span> <span class="sy0">.=</span> <span class="re0">$dicerand</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicesum</span> <span class="sy0">+=</span> <span class="re0">$dicerand</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$diceaddexpr</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$dicesign</span><span class="sy0">,</span> <span class="st0">&quot;-&quot;</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="re0">$diceadd</span> <span class="sy0">*=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicetxt</span> <span class="sy0">.=</span> <span class="br0">&#40;</span><span class="re0">$diceadd</span> <span class="sy0">&gt;=</span> <span class="nu0">0</span> ? <span class="st0">&quot; + &quot;</span> <span class="sy0">:</span> <span class="st0">&quot; - &quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="kw3">abs</span><span class="br0">&#40;</span><span class="re0">$diceadd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicesum</span> <span class="sy0">+=</span> <span class="re0">$diceadd</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dicetxt</span> <span class="sy0">.=</span> <span class="st0">&quot; = <span class="es4">$dicesum</span>&lt;br /&gt;&lt;br /&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;b&gt;<span class="es4">$dicetxt</span>&lt;/b&gt;&quot;</span><span class="sy0">.</span><span class="re0">$com</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$emails</span><span class="sy0">=</span><span class="re0">$email</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">ereg</span><span class="br0">&#40;</span><span class="st0">&quot;(#|&amp;#65283;)(.*)&quot;</span><span class="sy0">,</span><span class="re0">$emails</span><span class="sy0">,</span><span class="re0">$regs</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$regs</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="st0">&quot;pubies&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">explode</span><span class="br0">&#40;</span><span class="st0">&quot;#&quot;</span><span class="sy0">,</span><span class="re0">$email</span><span class="sy0">,</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>valid<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$color1</span><span class="sy0">=</span><span class="st0">&quot;#800080&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$color2</span><span class="sy0">=</span><span class="st0">&quot;#900090&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ma</span><span class="sy0">=</span><span class="st0">&quot;Mod&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">stristr</span><span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span><span class="st0">&quot;moot&quot;</span><span class="br0">&#41;</span><span class="sy0">||</span><span class="kw3">stristr</span><span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span><span class="st0">&quot;coda&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$color1</span><span class="sy0">=</span><span class="st0">&quot;#F00000&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$color2</span><span class="sy0">=</span><span class="st0">&quot;#FF0000&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$ma</span><span class="sy0">=</span><span class="st0">&quot;Admin&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span><span class="sy0">=</span><span class="st0">&quot;&lt;span title='<span class="es4">$email</span>' style=<span class="es1">\&quot;</span>color:<span class="es4">$color1</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span><span class="re0">$name</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span><span class="sy0">=</span><span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot; &lt;span class=<span class="es1">\&quot;</span>postertrip<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">,</span><span class="st0">&quot;&lt;/span&gt; &lt;span class=<span class="es1">\&quot;</span>postertrip<span class="es1">\&quot;</span>&gt;&lt;span title='<span class="es4">$email</span>' style=<span class="es1">\&quot;</span>color:<span class="es4">$color2</span>;font-weight:normal<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span><span class="sy0">.=</span><span class="st0">&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=<span class="es1">\&quot;</span>commentpostername<span class="es1">\&quot;</span>&gt;&lt;span title='<span class="es4">$email</span>' style=<span class="es1">\&quot;</span>color:<span class="es4">$color1</span><span class="es1">\&quot;</span>&gt;## <span class="es4">$ma</span>&lt;/span&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$email</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="coMULTI">/* &nbsp; } elseif ($regs[2]==&quot;munroexkcd&quot;) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $name=&quot;&lt;span style=\&quot;color:#0000F0\&quot;&gt;&quot;.$name;</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $name=str_replace(&quot; &lt;span class=\&quot;postertrip\&quot;&gt;&quot;,&quot;&lt;/span&gt; &lt;span class=\&quot;postertrip\&quot;&gt;&lt;span style=\&quot;color:#0000FF;font-weight:normal\&quot;&gt;&quot;,$name);</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $name.=&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=\&quot;commentpostername\&quot;&gt;&lt;span style=\&quot;color:#0000F0\&quot;&gt;## BlOgGeR&lt;/span&gt;&quot;;</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; list($email)=explode(&quot;#&quot;,$email,2);</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; } elseif ($regs[2]==&quot;netkingdongs&quot;) {</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $name='&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!!NETKING...';</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list($email)=explode(&quot;#&quot;,$email,2);</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; } elseif ($regs[2]==&quot;redhammer&quot;) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; if(!valid()) auto_ban(&quot;&lt;b&gt;autobanmenow&lt;/b&gt;&quot;,$name,&quot;redhammer capcode&quot;);</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; list($email)=explode(&quot;#&quot;,$email,2); */</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$nameparts</span><span class="sy0">=</span><span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!'</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; check_blacklist<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'name'</span> <span class="sy0">=&gt;</span> <span class="re0">$nameparts</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'trip'</span> <span class="sy0">=&gt;</span> <span class="re0">$trip</span><span class="sy0">,</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'nametrip'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;<span class="es4">{$nameparts[0]}</span> #<span class="es4">{$trip}</span>&quot;</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'md5'</span> <span class="sy0">=&gt;</span> <span class="re0">$md5</span><span class="sy0">,</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'email'</span> <span class="sy0">=&gt;</span> <span class="re0">$email</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'sub'</span> <span class="sy0">=&gt;</span> <span class="re0">$sub</span><span class="sy0">,</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'com'</span> <span class="sy0">=&gt;</span> <span class="re0">$com</span><span class="sy0">,</span> </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'pwd'</span> <span class="sy0">=&gt;</span> <span class="re0">$pass</span><span class="sy0">,</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'xff'</span> <span class="sy0">=&gt;</span> <span class="re0">$xff</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st_h">'filename'</span> <span class="sy0">=&gt;</span> <span class="re0">$insfile</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; spam_filter_post_trip<span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span> <span class="re0">$trip</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>SPOILERS<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> spoiler_parse<span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>SAGE_FILTER<span class="sy0">==</span><span class="nu0">1</span><span class="sy0">&amp;&amp;</span><span class="br0">&#40;</span><span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="st0">&quot;sage&quot;</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="sy0">||</span><span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="st0">&quot;sage&quot;</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="sy0">,</span><span class="st0">&quot;sage&quot;</span><span class="br0">&#41;</span><span class="sy0">!==</span><span class="kw4">FALSE</span><span class="br0">&#41;</span> <span class="re0">$email</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span> <span class="co1">//lol /b/</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>WORD_FILT<span class="sy0">&amp;&amp;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="st0">&quot;wf.php&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> word_filter<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span><span class="st0">&quot;com&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sub</span> <span class="sy0">=</span> word_filter<span class="br0">&#40;</span><span class="re0">$sub</span><span class="sy0">,</span><span class="st0">&quot;sub&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;:getprophet:&quot;</span><span class="sy0">,</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$namearr</span><span class="sy0">=</span><span class="kw3">explode</span><span class="br0">&#40;</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;'</span><span class="sy0">,</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strstr</span><span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="re0">$nametrip</span><span class="sy0">=</span><span class="st_h">'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;'</span><span class="sy0">.</span><span class="re0">$namearr</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="re0">$nametrip</span><span class="sy0">=</span><span class="st0">&quot;&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$namearr</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">!=</span> S_ANONAME<span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$name</span> <span class="sy0">=</span> word_filter<span class="br0">&#40;</span><span class="re0">$namearr</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span><span class="st0">&quot;name&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="re0">$nametrip</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>FORCED_ANON<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="re0">$name</span> <span class="sy0">=</span> <span class="st0">&quot;&lt;/span&gt;<span class="es4">$now</span>&lt;span&gt;&quot;</span><span class="sy0">;</span> <span class="re0">$sub</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> <span class="re0">$now</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> wordwrap2<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="nu0">100</span><span class="sy0">,</span> <span class="st0">&quot;&lt;br /&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$com</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st0">&quot;!(^|&gt;)(&amp;gt;[^&lt;]*)!&quot;</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es1">\\</span>1&lt;font class=<span class="es1">\&quot;</span>unkfunc<span class="es1">\&quot;</span>&gt;<span class="es1">\\</span>2&lt;/font&gt;&quot;</span><span class="sy0">,</span> <span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$is_sage</span> <span class="sy0">=</span> <span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="sy0">,</span> <span class="st0">&quot;sage&quot;</span><span class="br0">&#41;</span> <span class="sy0">!==</span> <span class="kw4">FALSE</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//post is now completely created(?)</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Before flood check&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$may_flood</span> <span class="sy0">=</span> valid<span class="br0">&#40;</span><span class="st_h">'floodbypass'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$may_flood</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Check for duplicate comments</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;select count(no)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where com='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' &quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and host='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' &quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and time&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$time</span><span class="sy0">-</span>RENZOKU_DUPE<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span>error<span class="br0">&#40;</span>S_RENZOKU<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$has_image</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Check for flood limit on replies</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;select count(no)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where time&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$time</span> <span class="sy0">-</span> RENZOKU<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and host='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' and resto&gt;0&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span>error<span class="br0">&#40;</span>S_RENZOKU<span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$is_sage</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Check flood limit on sage posts</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;select count(no)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where time&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$time</span> <span class="sy0">-</span> RENZOKU_SAGE<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and host='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' and resto&gt;0 and permasage=1&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span>error<span class="br0">&#40;</span>S_RENZOKU<span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Check flood limit on new threads</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;select count(no)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where time&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$time</span> <span class="sy0">-</span> RENZOKU3<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and host='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' and root&gt;0&quot;</span><span class="sy0">;</span> <span class="co1">//root&gt;0 == non-sticky</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span>error<span class="br0">&#40;</span>S_RENZOKU3<span class="sy0">,</span> <span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Upload processing</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$has_image</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$may_flood</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;select count(no)&gt;0 from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where time&gt;&quot;</span><span class="sy0">.</span><span class="br0">&#40;</span><span class="re0">$time</span> <span class="sy0">-</span> RENZOKU2<span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; &quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;and host='&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;' and resto&gt;0&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span>error<span class="br0">&#40;</span>S_RENZOKU2<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//Duplicate image check</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$result</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select no,resto from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where md5='<span class="es4">$md5</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$dupeno</span><span class="sy0">,</span><span class="re0">$duperesto</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$duperesto</span><span class="br0">&#41;</span> <span class="re0">$duperesto</span> <span class="sy0">=</span> <span class="re0">$dupeno</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span><span class="st_h">'&lt;a href=&quot;'</span><span class="sy0">.</span>DATA_SERVER <span class="sy0">.</span> BOARD_DIR <span class="sy0">.</span> <span class="st0">&quot;/res/&quot;</span> <span class="sy0">.</span> <span class="re0">$duperesto</span> <span class="sy0">.</span> PHP_EXT <span class="sy0">.</span> <span class="st_h">'#'</span> <span class="sy0">.</span> <span class="re0">$dupeno</span> <span class="sy0">.</span> <span class="st_h">'&quot;&gt;'</span><span class="sy0">.</span>S_DUPE<span class="sy0">.</span><span class="st_h">'&lt;/a&gt;'</span><span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="re0">$rootqu</span> <span class="sy0">=</span> <span class="re0">$resto</span> ? <span class="st0">&quot;0&quot;</span> <span class="sy0">:</span> <span class="st0">&quot;now()&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// thumbnail</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$has_image</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="re0">$dest</span><span class="sy0">,</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>USE_THUMB<span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$tn_name</span> <span class="sy0">=</span> thumb<span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">,</span><span class="re0">$tim</span><span class="sy0">,</span><span class="re0">$ext</span><span class="sy0">,</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$tn_name</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$ext</span> <span class="sy0">!=</span> <span class="st0">&quot;.pdf&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_UNUSUAL<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'oe_chk'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">rename</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es4">$dest</span>.pch&quot;</span><span class="sy0">,</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'.pch'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$upfile</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// get rid of the tmp/ entries</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$pchfile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">logtime<span class="br0">&#40;</span><span class="st0">&quot;Thumbnail created&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Before insertion&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// noko (stay) actions</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$email</span> <span class="sy0">==</span> <span class="st_h">'noko'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$email</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> <span class="re0">$noko</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$email</span> <span class="sy0">==</span> <span class="st_h">'noko2'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$email</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> <span class="re0">$noko</span> <span class="sy0">=</span> <span class="nu0">2</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//find sticky &amp; autosage</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// auto-sticky</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sticky</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$autosage</span> <span class="sy0">=</span> spam_filter_should_autosage<span class="br0">&#40;</span><span class="re0">$com</span><span class="sy0">,</span> <span class="re0">$sub</span><span class="sy0">,</span> <span class="re0">$name</span><span class="sy0">,</span> <span class="re0">$fsize</span><span class="sy0">,</span> <span class="re0">$resto</span><span class="sy0">,</span> <span class="re0">$W</span><span class="sy0">,</span> <span class="re0">$H</span><span class="sy0">,</span> <span class="re0">$dest</span><span class="sy0">,</span> <span class="re0">$insertid</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'AUTOSTICKY'</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> AUTOSTICKY<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$autosticky</span> <span class="sy0">=</span> <span class="kw3">preg_split</span><span class="br0">&#40;</span><span class="st0">&quot;/,\s*/&quot;</span><span class="sy0">,</span> AUTOSTICKY<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$insertid</span> <span class="sy0">%</span> <span class="nu0">1000000</span> <span class="sy0">==</span> <span class="nu0">0</span> <span class="sy0">||</span> <span class="kw3">in_array</span><span class="br0">&#40;</span><span class="re0">$insertid</span><span class="sy0">,</span><span class="re0">$autosticky</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$sticky</span> <span class="sy0">=</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_cols</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_vals</span> <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$sticky</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_cols</span> <span class="sy0">=</span> <span class="st0">&quot;,sticky&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_vals</span> <span class="sy0">=</span> <span class="st0">&quot;,1&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//permasage just means &quot;is sage&quot; for replies</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$resto</span> ? <span class="re0">$is_sage</span> <span class="sy0">:</span> <span class="re0">$autosage</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_cols</span> <span class="sy0">.=</span> <span class="st0">&quot;,permasage&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$flag_vals</span> <span class="sy0">.=</span> <span class="st0">&quot;,1&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;insert into &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; (now,name,email,sub,com,host,pwd,filename,ext,w,h,tn_w,tn_h,tim,time,md5,fsize,root,resto<span class="es4">$flag_cols</span>) values (&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="re0">$now</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$name</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$sub</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$pass</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="kw3">mysql_escape_string</span><span class="br0">&#40;</span><span class="re0">$insfile</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$W</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$H</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$TN_W</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$TN_H</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$time</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="st0">&quot;'&quot;</span><span class="sy0">.</span><span class="re0">$md5</span><span class="sy0">.</span><span class="st0">&quot;',&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$fsize</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="re0">$rootqu</span><span class="sy0">.</span><span class="st0">&quot;,&quot;</span><span class="sy0">.</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$resto</span><span class="sy0">.</span></div></li>
<li class="li2"><div class="de2"><span class="re0">$flag_vals</span><span class="sy0">.</span><span class="st0">&quot;)&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$result</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span> &nbsp;<span class="co1">//post registration</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$cookie_domain</span> <span class="sy0">=</span> <span class="br0">&#40;</span>NOT4CHAN<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span>?<span class="st_h">'.not4chan.org'</span><span class="sy0">:</span><span class="st_h">'.4chan.org'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//Cookies</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw3">setrawcookie</span><span class="br0">&#40;</span><span class="st0">&quot;4chan_name&quot;</span><span class="sy0">,</span> <span class="kw3">rawurlencode</span><span class="br0">&#40;</span><span class="re0">$c_name</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="br0">&#40;</span><span class="re0">$c_name</span>?<span class="br0">&#40;</span><span class="nu0">7</span><span class="sy0">*</span><span class="nu0">24</span><span class="sy0">*</span><span class="nu0">3600</span><span class="br0">&#41;</span><span class="sy0">:-</span><span class="nu0">3600</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="st_h">'/'</span><span class="sy0">,</span><span class="re0">$cookie_domain</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">//header(&quot;Set-Cookie: 4chan_name=$c_name; expires=&quot;.date(&quot;D, d-M-Y H:i:s&quot;,time()+7*24*3600).&quot; GMT&quot;,false);</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$c_email</span><span class="sy0">!=</span><span class="st0">&quot;sage&quot;</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="br0">&#40;</span><span class="re0">$c_email</span><span class="sy0">!=</span><span class="st0">&quot;age&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">setcookie</span> <span class="br0">&#40;</span><span class="st0">&quot;4chan_email&quot;</span><span class="sy0">,</span> <span class="re0">$c_email</span><span class="sy0">,</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="br0">&#40;</span><span class="re0">$c_email</span>?<span class="br0">&#40;</span><span class="nu0">7</span><span class="sy0">*</span><span class="nu0">24</span><span class="sy0">*</span><span class="nu0">3600</span><span class="br0">&#41;</span><span class="sy0">:-</span><span class="nu0">3600</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="st_h">'/'</span><span class="sy0">,</span><span class="re0">$cookie_domain</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;<span class="co1">// 1 week cookie expiration</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw3">setcookie</span><span class="br0">&#40;</span><span class="st0">&quot;4chan_pass&quot;</span><span class="sy0">,</span> <span class="re0">$c_pass</span><span class="sy0">,</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="nu0">7</span><span class="sy0">*</span><span class="nu0">24</span><span class="sy0">*</span><span class="nu0">3600</span><span class="sy0">,</span><span class="st_h">'/'</span><span class="sy0">,</span><span class="re0">$cookie_domain</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;<span class="co1">// 1 week cookie expiration</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$insertid</span> <span class="sy0">=</span> mysql_board_insert_id<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="co1">//sage or age action</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resline</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select count(no) from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where resto=&quot;</span><span class="sy0">.</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$countres</span><span class="sy0">=</span><span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span> </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resline</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select sticky,permasage from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=&quot;</span><span class="sy0">.</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$stuck</span><span class="sy0">,</span><span class="re0">$psage</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$resline</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">stripos</span><span class="br0">&#40;</span><span class="re0">$email</span><span class="sy0">,</span><span class="st_h">'sage'</span><span class="br0">&#41;</span><span class="sy0">===</span><span class="kw4">FALSE</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$countres</span> <span class="sy0">&lt;</span> MAX_RES <span class="sy0">&amp;&amp;</span> <span class="re0">$stuck</span> <span class="sy0">!=</span> <span class="st0">&quot;1&quot;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$psage</span> <span class="sy0">!=</span> <span class="st0">&quot;1&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="br0">&#40;</span><span class="re0">$admin</span><span class="sy0">&amp;&amp;</span><span class="re0">$age</span><span class="sy0">&amp;&amp;</span><span class="re0">$stuck</span> <span class="sy0">!=</span> <span class="st0">&quot;1&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$query</span><span class="sy0">=</span><span class="st0">&quot;update &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; set root=now() where no=<span class="es4">$resto</span>&quot;</span><span class="sy0">;</span> <span class="co1">//age</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$static_rebuild</span> <span class="sy0">=</span> <span class="kw3">defined</span><span class="br0">&#40;</span><span class="st0">&quot;STATIC_REBUILD&quot;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span>STATIC_REBUILD<span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Before trim_db&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// trim database</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$static_rebuild</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trim_db<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;After trim_db&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="kw1">if</span><span class="br0">&#40;</span>PROCESSLIST <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span><span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="br0">&#40;</span><span class="re0">$locked_time</span><span class="sy0">+</span><span class="nu0">7</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$dump</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="kw3">serialize</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'GET'</span><span class="sy0">=&gt;</span><span class="re0">$_GET</span><span class="sy0">,</span><span class="st_h">'POST'</span><span class="sy0">=&gt;</span><span class="re0">$_POST</span><span class="sy0">,</span><span class="st_h">'SERVER'</span><span class="sy0">=&gt;</span><span class="re0">$_SERVER</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO proclist VALUES (connection_id(),'<span class="es4">$dump</span>','slow post')&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">/*mysql_board_unlock();</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp;</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; logtime(&quot;Tables unlocked&quot;); &nbsp; &nbsp; */</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>BOARD_DIR <span class="sy0">==</span> <span class="st_h">'b'</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">iplog_add<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$insertid</span><span class="sy0">,</span> <span class="re0">$host</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Ip logged&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw1">if</span><span class="br0">&#40;</span>RAPIDSEARCH_LOGGING <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; rapidsearch_check<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$insertid</span><span class="sy0">,</span> <span class="re0">$com</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;rapidsearch check finished&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$deferred</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// update html</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$deferred</span> <span class="sy0">=</span> updatelog<span class="br0">&#40;</span><span class="re0">$resto</span><span class="sy0">,</span> <span class="re0">$static_rebuild</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$deferred</span> <span class="sy0">=</span> updatelog<span class="br0">&#40;</span><span class="re0">$insertid</span><span class="sy0">,</span> <span class="re0">$static_rebuild</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; logtime<span class="br0">&#40;</span><span class="st0">&quot;Pages rebuilt&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// determine url to redirect to </span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$noko</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$redirect</span> <span class="sy0">=</span> DATA_SERVER <span class="sy0">.</span> BOARD_DIR <span class="sy0">.</span> <span class="st0">&quot;/res/&quot;</span> <span class="sy0">.</span> <span class="re0">$insertid</span> <span class="sy0">.</span> PHP_EXT<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$noko</span><span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$redirect</span> <span class="sy0">=</span> DATA_SERVER <span class="sy0">.</span> BOARD_DIR <span class="sy0">.</span> <span class="st0">&quot;/res/&quot;</span> <span class="sy0">.</span> <span class="re0">$resto</span> <span class="sy0">.</span> PHP_EXT <span class="sy0">.</span> <span class="st_h">'#'</span> <span class="sy0">.</span> <span class="re0">$insertid</span><span class="sy0">;</span> &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$redirect</span> <span class="sy0">=</span> PHP_SELF2_ABS<span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$deferred</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;html&gt;&lt;head&gt;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>2;URL=<span class="es4">$redirect</span><span class="es1">\&quot;</span>&gt;&lt;/head&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;body&gt;<span class="es4">$mes</span> &quot;</span><span class="sy0">.</span>S_SCRCHANGE<span class="sy0">.</span><span class="st0">&quot;&lt;br&gt;Your post may not appear immediately.&lt;!-- thread:<span class="es4">$resto</span>,no:<span class="es4">$insertid</span> --&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;html&gt;&lt;head&gt;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>1;URL=<span class="es4">$redirect</span><span class="es1">\&quot;</span>&gt;&lt;/head&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;body&gt;<span class="es4">$mes</span> &quot;</span><span class="sy0">.</span>S_SCRCHANGE<span class="sy0">.</span><span class="st0">&quot;&lt;!-- thread:<span class="es4">$resto</span>,no:<span class="es4">$insertid</span> --&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> resredir<span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$res</span> <span class="sy0">=</span> <span class="br0">&#40;</span>int<span class="br0">&#41;</span><span class="re0">$res</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_lock<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$redir</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select no,resto from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where no=&quot;</span><span class="sy0">.</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$redir</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$no</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$maxq</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select max(no) from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$max</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$maxq</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$max</span> <span class="sy0">||</span> <span class="br0">&#40;</span><span class="re0">$res</span> <span class="sy0">&gt;</span> <span class="re0">$max</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP/1.0 404 Not Found&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="co1">// res &lt; max, so it must be deleted!</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP/1.0 410 Gone&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_NOTHREADERR<span class="sy0">,</span><span class="re0">$dest</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="sy0">==</span><span class="st0">&quot;0&quot;</span><span class="br0">&#41;</span> <span class="co1">// thread</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$redirect</span> <span class="sy0">=</span> DATA_SERVER <span class="sy0">.</span> BOARD_DIR <span class="sy0">.</span> <span class="st0">&quot;/res/&quot;</span> <span class="sy0">.</span> <span class="re0">$no</span> <span class="sy0">.</span> PHP_EXT <span class="sy0">.</span> <span class="st_h">'#'</span> <span class="sy0">.</span> <span class="re0">$no</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">else</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$redirect</span> <span class="sy0">=</span> DATA_SERVER <span class="sy0">.</span> BOARD_DIR <span class="sy0">.</span> <span class="st0">&quot;/res/&quot;</span> <span class="sy0">.</span> <span class="re0">$resto</span> <span class="sy0">.</span> PHP_EXT <span class="sy0">.</span> <span class="st_h">'#'</span> <span class="sy0">.</span> <span class="re0">$no</span><span class="sy0">;</span> &nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>0;URL=<span class="es4">$redirect</span><span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="sy0">==</span><span class="st0">&quot;0&quot;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_unlock<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; </div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="sy0">==</span><span class="st0">&quot;0&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// thread</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">//thumbnails</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> thumb<span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">,</span><span class="re0">$tim</span><span class="sy0">,</span><span class="re0">$ext</span><span class="sy0">,</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreate&quot;</span><span class="br0">&#41;</span><span class="sy0">||!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreateFromJPEG&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$fname</span><span class="sy0">=</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="re0">$ext</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$thumb_dir</span> <span class="sy0">=</span> THUMB_DIR<span class="sy0">;</span> &nbsp; &nbsp; <span class="co1">//thumbnail directory</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$outpath</span> <span class="sy0">=</span> <span class="re0">$thumb_dir</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'s.jpg'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$width</span> &nbsp; &nbsp; <span class="sy0">=</span> MAX_W<span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">//output width</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$height</span> &nbsp; &nbsp;<span class="sy0">=</span> MAX_H<span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">//output height</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$width</span> &nbsp; &nbsp; <span class="sy0">=</span> MAXR_W<span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">//output width (imgreply)</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$height</span> &nbsp; &nbsp;<span class="sy0">=</span> MAXR_H<span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">//output height (imgreply)</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// width, height, and type are aquired</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>ENABLE_PDF<span class="sy0">==</span><span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$ext</span><span class="sy0">==</span><span class="st_h">'.pdf'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// create jpeg for the thumbnailer</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$pdfjpeg</span> <span class="sy0">=</span> <span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'.pdf.tmp'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;/usr/local/bin/gs -q -dSAFER -dNOPAUSE -dBATCH -sDEVICE=jpeg -sOutputFile=<span class="es4">$pdfjpeg</span> <span class="es4">$fname</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$pdfjpeg</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$fname</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$fname</span> <span class="sy0">=</span> <span class="re0">$pdfjpeg</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$size</span> <span class="sy0">=</span> <span class="kw3">GetImageSize</span><span class="br0">&#40;</span><span class="re0">$fname</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$memory_limit_increased</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">&gt;</span> <span class="nu0">3000000</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$memory_limit_increased</span> <span class="sy0">=</span> <span class="kw4">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'memory_limit'</span><span class="sy0">,</span> <span class="kw3">memory_get_usage</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// for huge images</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">switch</span> <span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">1</span> <span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreateFromGIF&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$im_in</span> <span class="sy0">=</span> <span class="kw3">ImageCreateFromGIF</span><span class="br0">&#40;</span><span class="re0">$fname</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$im_in</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">break</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_executable</span><span class="br0">&#40;</span><span class="kw3">realpath</span><span class="br0">&#40;</span><span class="st0">&quot;/www/global/gif2png&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">||!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreateFromPNG&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">exec</span><span class="br0">&#40;</span><span class="kw3">realpath</span><span class="br0">&#40;</span><span class="st0">&quot;/www/global/gif2png&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st0">&quot; <span class="es4">$fname</span>&quot;</span><span class="sy0">,</span><span class="re0">$a</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'.png'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$im_in</span> <span class="sy0">=</span> <span class="kw3">ImageCreateFromPNG</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'.png'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$path</span><span class="sy0">.</span><span class="re0">$tim</span><span class="sy0">.</span><span class="st_h">'.png'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$im_in</span><span class="br0">&#41;</span><span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">2</span> <span class="sy0">:</span> <span class="re0">$im_in</span> <span class="sy0">=</span> <span class="kw3">ImageCreateFromJPEG</span><span class="br0">&#40;</span><span class="re0">$fname</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$im_in</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">return</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">case</span> <span class="nu0">3</span> <span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreateFromPNG&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="re0">$im_in</span> <span class="sy0">=</span> <span class="kw3">ImageCreateFromPNG</span><span class="br0">&#40;</span><span class="re0">$fname</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$im_in</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">return</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">default</span> <span class="sy0">:</span> <span class="kw1">return</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">// Resizing</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">&gt;</span> <span class="re0">$width</span> <span class="sy0">||</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">&gt;</span> <span class="re0">$height</span> <span class="sy0">||</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$key_w</span> <span class="sy0">=</span> <span class="re0">$width</span> <span class="sy0">/</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$key_h</span> <span class="sy0">=</span> <span class="re0">$height</span> <span class="sy0">/</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#40;</span><span class="re0">$key_w</span> <span class="sy0">&lt;</span> <span class="re0">$key_h</span><span class="br0">&#41;</span> ? <span class="re0">$keys</span> <span class="sy0">=</span> <span class="re0">$key_w</span> <span class="sy0">:</span> <span class="re0">$keys</span> <span class="sy0">=</span> <span class="re0">$key_h</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$out_w</span> <span class="sy0">=</span> <span class="kw3">ceil</span><span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">*</span> <span class="re0">$keys</span><span class="br0">&#41;</span> <span class="sy0">+</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$out_h</span> <span class="sy0">=</span> <span class="kw3">ceil</span><span class="br0">&#40;</span><span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">*</span> <span class="re0">$keys</span><span class="br0">&#41;</span> <span class="sy0">+</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="coMULTI">/*if ($size[2]==1) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $out_w = $size[0];</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $out_h = $size[1];</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; } //what was this for again? */</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$out_w</span> <span class="sy0">=</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$out_h</span> <span class="sy0">=</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// the thumbnail is created</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;ImageCreateTrueColor&quot;</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span>get_gd_ver<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">==</span><span class="st0">&quot;2&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$im_out</span> <span class="sy0">=</span> <span class="kw3">ImageCreateTrueColor</span><span class="br0">&#40;</span><span class="re0">$out_w</span><span class="sy0">,</span> <span class="re0">$out_h</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span><span class="re0">$im_out</span> <span class="sy0">=</span> <span class="kw3">ImageCreate</span><span class="br0">&#40;</span><span class="re0">$out_w</span><span class="sy0">,</span> <span class="re0">$out_h</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// copy resized original</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw3">ImageCopyResampled</span><span class="br0">&#40;</span><span class="re0">$im_out</span><span class="sy0">,</span> <span class="re0">$im_in</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$out_w</span><span class="sy0">,</span> <span class="re0">$out_h</span><span class="sy0">,</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$size</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">// thumbnail saved</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw3">ImageJPEG</span><span class="br0">&#40;</span><span class="re0">$im_out</span><span class="sy0">,</span> <span class="re0">$outpath</span> <span class="sy0">,</span><span class="nu0">60</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//chmod($thumb_dir.$tim.'s.jpg',0666);</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">// created image is destroyed</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw3">ImageDestroy</span><span class="br0">&#40;</span><span class="re0">$im_in</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw3">ImageDestroy</span><span class="br0">&#40;</span><span class="re0">$im_out</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$pdfjpeg</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw3">unlink</span><span class="br0">&#40;</span><span class="re0">$pdfjpeg</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="co1">// if PDF was thumbnailed delete the orig jpeg</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$memory_limit_increased</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">ini_restore</span><span class="br0">&#40;</span><span class="st_h">'memory_limit'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">return</span> <span class="re0">$outpath</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="co1">//check version of gd</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> get_gd_ver<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st0">&quot;gd_info&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$gdver</span><span class="sy0">=</span><span class="kw3">gd_info</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="re0">$gdver</span><span class="br0">&#91;</span><span class="st0">&quot;GD Version&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span> <span class="co1">//earlier than php4.3.0</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw3">ob_start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">phpinfo</span><span class="br0">&#40;</span><span class="nu0">8</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">ob_get_contents</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">ob_end_clean</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">strip_tags</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">stristr</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="sy0">,</span><span class="st0">&quot;gd version&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">stristr</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="sy0">,</span><span class="st0">&quot;version&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$end</span><span class="sy0">=</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="sy0">,</span><span class="st0">&quot;.&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="re0">$end</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$length</span> <span class="sy0">=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$phpinfo</span><span class="sy0">=</span><span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$phpinfo</span><span class="sy0">,</span><span class="re0">$length</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">return</span> <span class="re0">$phpinfo</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">//md5 calculation for earlier than php4.2.0</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> md5_of_file<span class="br0">&#40;</span><span class="re0">$inFile</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$inFile</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st_h">'md5_file'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">md5_file</span><span class="br0">&#40;</span><span class="re0">$inFile</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$fd</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$inFile</span><span class="sy0">,</span> <span class="st_h">'r'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$fileContents</span> <span class="sy0">=</span> <span class="kw3">fread</span><span class="br0">&#40;</span><span class="re0">$fd</span><span class="sy0">,</span> <span class="kw3">filesize</span><span class="br0">&#40;</span><span class="re0">$inFile</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">fclose</span> <span class="br0">&#40;</span><span class="re0">$fd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">md5</span><span class="br0">&#40;</span><span class="re0">$fileContents</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* text plastic surgery */</span></div></li>
<li class="li1"><div class="de1"><span class="co1">// you can call with skip_bidi=1 if cleaning a paragraph element (like $com)</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> CleanStr<span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span><span class="re0">$skip_bidi</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw2">global</span> <span class="re0">$admin</span><span class="sy0">,</span><span class="re0">$html</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$str</span> <span class="sy0">=</span> <span class="kw3">trim</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//blankspace removal</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">get_magic_quotes_gpc</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="co1">//magic quotes is deleted (?)</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">=</span> <span class="kw3">stripslashes</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$admin</span><span class="sy0">!=</span>ADMIN_PASS<span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">=</span> <span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span> &nbsp; &nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span><span class="br0">&#40;</span> <span class="re0">$admin</span><span class="sy0">==</span>ADMIN_PASS<span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="re0">$html</span><span class="sy0">!=</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">=</span> <span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$skip_bidi</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// fix malformed bidirectional overrides - insert as many PDFs as RLOs</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//RLO</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es2">\xE2</span><span class="es2">\x80</span><span class="es2">\xAC</span>&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es2">\xE2</span><span class="es2">\x80</span><span class="es2">\xAE</span>&quot;</span><span class="coMULTI">/* U+202E */</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;#8236;&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#8238;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;#x202c;&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#x202e;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//RLE</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es2">\xE2</span><span class="es2">\x80</span><span class="es2">\xAC</span>&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es2">\xE2</span><span class="es2">\x80</span><span class="es2">\xAB</span>&quot;</span><span class="coMULTI">/* U+202B */</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;#8236;&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#8235;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$str</span> <span class="sy0">.=</span> <span class="kw3">str_repeat</span><span class="br0">&#40;</span><span class="st0">&quot;&amp;#x202c;&quot;</span><span class="sy0">,</span> <span class="kw3">substr_count</span><span class="br0">&#40;</span><span class="re0">$str</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#x202b;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">return</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot;,&quot;</span><span class="sy0">,</span> <span class="st0">&quot;&amp;#44;&quot;</span><span class="sy0">,</span> <span class="re0">$str</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//remove commas</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="co1">//check for table existance</span></div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> table_exist<span class="br0">&#40;</span><span class="re0">$table</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$result</span> <span class="sy0">=</span> mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;show tables like '<span class="es4">$table</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$a</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">return</span> <span class="re0">$a</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="kw2">function</span> report<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">require</span> <span class="st_h">'/www/global/forms/report.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">require</span> <span class="st_h">'/www/global/modes/report.php'</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REQUEST_METHOD'</span><span class="br0">&#93;</span> <span class="sy0">==</span> <span class="st_h">'GET'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>report_post_exists<span class="br0">&#40;</span><span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fancydie<span class="br0">&#40;</span><span class="st_h">'That post doesn\'t exist anymore.'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>report_post_sticky<span class="br0">&#40;</span><span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fancydie<span class="br0">&#40;</span><span class="st_h">'Stop trying to report a sticky.'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_check_ip<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form_report<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$_GET</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_check_ip<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_submit<span class="br0">&#40;</span>BOARD_DIR<span class="sy0">,</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'no'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$_POST</span><span class="br0">&#91;</span><span class="st_h">'cat'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="st_h">'&lt;/body&gt;&lt;/html&gt;'</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/* user image deletion */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> usrdel<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$pwd</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw2">global</span> <span class="re0">$path</span><span class="sy0">,</span><span class="re0">$pwdc</span><span class="sy0">,</span><span class="re0">$onlyimgdel</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$host</span> <span class="sy0">=</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st0">&quot;REMOTE_ADDR&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$delno</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="re0">$delflag</span> <span class="sy0">=</span> <span class="kw4">FALSE</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$rebuildindex</span> <span class="sy0">=</span> <span class="sy0">!</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st0">&quot;STATIC_REBUILD&quot;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> STATIC_REBUILD<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw3">reset</span><span class="br0">&#40;</span><span class="re0">$_POST</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$item</span> <span class="sy0">=</span> <span class="kw3">each</span><span class="br0">&#40;</span><span class="re0">$_POST</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$item</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">==</span><span class="st_h">'delete'</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw3">array_push</span><span class="br0">&#40;</span><span class="re0">$delno</span><span class="sy0">,</span><span class="re0">$item</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="re0">$delflag</span><span class="sy0">=</span><span class="kw4">TRUE</span><span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$pwd</span><span class="sy0">==</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">&amp;&amp;</span><span class="br0">&#40;</span><span class="re0">$pwdc</span><span class="sy0">!=</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="re0">$pwd</span><span class="sy0">=</span><span class="re0">$pwdc</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$countdel</span><span class="sy0">=</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$delno</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$flag</span> <span class="sy0">=</span> <span class="kw4">FALSE</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE&quot;);</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="re0">$rebuild</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// keys are pages that need to be rebuilt (0 is index, of course)</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">for</span><span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">&lt;</span><span class="re0">$countdel</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resto</span> <span class="sy0">=</span> delete_post<span class="br0">&#40;</span><span class="re0">$delno</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$pwd</span><span class="sy0">,</span> <span class="re0">$onlyimgdel</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="re0">$countdel</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// only show error for user deletion, not multi</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$resto</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$rebuild</span><span class="br0">&#91;</span><span class="re0">$resto</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="co1">//mysql_board_call(&quot;UNLOCK TABLES&quot;); &nbsp;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$rebuild</span> <span class="kw1">as</span> <span class="re0">$key</span><span class="sy0">=&gt;</span><span class="re0">$val</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="re0">$key</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// leaving the second parameter as 0 rebuilds the index each time!</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$rebuildindex</span><span class="br0">&#41;</span> updatelog<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// update the index page last</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="coMULTI">/*password validation */</span></div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> oldvalid<span class="br0">&#40;</span><span class="re0">$pass</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; error<span class="br0">&#40;</span>S_WRONGPASS<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="coMULTI">/*if($pass &amp;&amp; ($pass != ADMIN_PASS) ) {</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; auto_ban_poster($name, 2, 1, 'failed the password check on imgboard manager mode', 'Trying to exploit administrative pages.');</span></div></li>
<li class="li1"><div class="de1"><span class="coMULTI">&nbsp; &nbsp; &nbsp; &nbsp; error(S_WRONGPASS);</span></div></li>
<li class="li2"><div class="de2"><span class="coMULTI">&nbsp; }*/</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; head<span class="br0">&#40;</span><span class="re0">$dat</span><span class="sy0">,</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">echo</span> <span class="re0">$dat</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_RETURNS<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;]<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;[&lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">.</span>S_LOGUPD<span class="sy0">.</span><span class="st0">&quot;&lt;/a&gt;]<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;table width='100%'&gt;&lt;tr&gt;&lt;th bgcolor=#E08000&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;font color=#FFFFFF&gt;&quot;</span><span class="sy0">.</span>S_MANAMODE<span class="sy0">.</span><span class="st0">&quot;&lt;/font&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;p&gt;&lt;form action=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span> method=POST&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="co1">// Mana login form</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$pass</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;center&gt;&lt;input type=hidden name=admin value=post&gt;&lt;input type=hidden name=mode value=admin&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;input class=inputtext type=password name=pass size=8&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;input type=submit value=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>S_MANASUB<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&lt;/form&gt;&lt;/center&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="kw2">function</span> rebuild<span class="br0">&#40;</span><span class="re0">$all</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;Pragma: no-cache&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;Rebuilding &quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$all</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">echo</span> <span class="st0">&quot;all&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="kw1">echo</span> <span class="st0">&quot;missing&quot;</span><span class="sy0">;</span> <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot; replies and pages... &lt;a href=<span class="es1">\&quot;</span>&quot;</span><span class="sy0">.</span>PHP_SELF2_ABS<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;Go back&lt;/a&gt;&lt;br&gt;&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">ob_end_flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_lock<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$starttime</span> <span class="sy0">=</span> <span class="kw3">microtime</span><span class="br0">&#40;</span><span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$treeline</span><span class="sy0">=</span>mysql_board_call<span class="br0">&#40;</span><span class="st0">&quot;select no,resto from &quot;</span><span class="sy0">.</span>SQLLOG<span class="sy0">.</span><span class="st0">&quot; where root&gt;0 order by root desc&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">echo</span> S_SQLFAIL<span class="sy0">;</span><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; log_cache<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; mysql_board_unlock<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;Writing...<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$all</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="st_h">'CACHE_TTL'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span><span class="kw3">list</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$resto</span><span class="br0">&#41;</span><span class="sy0">=</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$treeline</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$resto</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;No.<span class="es4">$no</span> created.&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;Index pages created.&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$posts</span> <span class="sy0">=</span> rebuildqueue_take_all<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$posts</span> <span class="kw1">as</span> <span class="re0">$no</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$deferred</span> <span class="sy0">=</span> <span class="br0">&#40;</span> updatelog<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span> ? <span class="st_h">' (deferred)'</span> <span class="sy0">:</span> <span class="st_h">''</span> <span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$no</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;No.<span class="es4">$no</span> created.<span class="es4">$deferred</span>&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;Index pages created.<span class="es4">$deferred</span>&lt;br&gt;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$totaltime</span> <span class="sy0">=</span> <span class="kw3">microtime</span><span class="br0">&#40;</span><span class="kw4">true</span><span class="br0">&#41;</span> <span class="sy0">-</span> <span class="re0">$starttime</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;br&gt;Time elapsed (lock excluded): <span class="es4">$totaltime</span> seconds&quot;</span><span class="sy0">,</span><span class="st0">&quot;&lt;br&gt;Pages created.&lt;br&gt;&lt;br&gt;<span class="es1">\n</span>Redirecting back to board.<span class="es1">\n</span>&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>10;URL=&quot;</span><span class="sy0">.</span>PHP_SELF2<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1"><span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp;</div></li>
<li class="li1"><div class="de1"><span class="coMULTI">/*-----------Main-------------*/</span></div></li>
<li class="li2"><div class="de2"><span class="kw1">switch</span><span class="br0">&#40;</span><span class="re0">$mode</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">case</span> <span class="st_h">'regist'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; regist<span class="br0">&#40;</span><span class="re0">$name</span><span class="sy0">,</span><span class="re0">$email</span><span class="sy0">,</span><span class="re0">$sub</span><span class="sy0">,</span><span class="re0">$com</span><span class="sy0">,</span><span class="st_h">''</span><span class="sy0">,</span><span class="re0">$pwd</span><span class="sy0">,</span><span class="re0">$upfile</span><span class="sy0">,</span><span class="re0">$upfile_name</span><span class="sy0">,</span><span class="re0">$resto</span><span class="sy0">,</span><span class="re0">$age</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">case</span> <span class="st_h">'report'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; report<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">case</span> <span class="st_h">'admin'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; oldvalid<span class="br0">&#40;</span><span class="re0">$pass</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$admin</span><span class="sy0">==</span><span class="st0">&quot;post&quot;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;/form&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; form<span class="br0">&#40;</span><span class="re0">$post</span><span class="sy0">,</span><span class="re0">$res</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="re0">$post</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">case</span> <span class="st_h">'rebuild'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; rebuild<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">case</span> <span class="st_h">'rebuildall'</span><span class="sy0">:</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; rebuild<span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">case</span> <span class="st_h">'admindel'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; usrdel<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$pwd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>0;URL=admin.php<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">case</span> <span class="st_h">'nothing'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">break</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">case</span> <span class="st_h">'usrdel'</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; usrdel<span class="br0">&#40;</span><span class="re0">$no</span><span class="sy0">,</span><span class="re0">$pwd</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">default</span><span class="sy0">:</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>JANITOR_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$mode</span> <span class="sy0">==</span> <span class="st_h">'latest'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; broomcloset_latest<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$mode</span> <span class="sy0">==</span> <span class="st_h">'oe_finish'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="kw1">require_once</span> <span class="st_h">'oekaki.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;oe_finish<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">elseif</span><span class="br0">&#40;</span>OEKAKI_BOARD <span class="sy0">==</span> <span class="nu0">1</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$mode</span> <span class="sy0">==</span> <span class="st_h">'oe_paint'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="kw1">require_once</span> <span class="st_h">'oekaki.php'</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;oe_paint<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2">&nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; resredir<span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>10;URL=&quot;</span><span class="sy0">.</span>PHP_SELF2_ABS<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span><span class="kw1">else</span><span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; READ&quot;);</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;Updating index...<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp; updatelog<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="co1">//mysql_board_call(&quot;UNLOCK TABLES&quot;);</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; <span class="kw1">echo</span> <span class="st0">&quot;&lt;META HTTP-EQUIV=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>0;URL=&quot;</span><span class="sy0">.</span>PHP_SELF2_ABS<span class="sy0">.</span><span class="st0">&quot;<span class="es1">\&quot;</span>&gt;&quot;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; <span class="br0">&#125;</span></div></li>
<li class="li2"><div class="de2"><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li2"><div class="de2"><span class="sy1">?&gt;</span></div></li>
</ol></div>
		</div>
	</div></div>
	<div class="content_title">
		<span class="span_right raw_links"><a href="/index/a45dp3Q1" rel="nofollow">create a <u>new version</u> of this paste</a></span>
		RAW Paste Data
	</div>
	<form class="paste_form" id="myform" method="post" action="/post.php">
		<div class="textarea_border">
			<textarea id="paste_code" class="paste_code" name="paste_code" onkeydown="return catchTab(this,event)">&lt;?
if(file_exists('/www/global/lockdown')) {
	if($_COOKIE['4chan_auser'] &amp;&amp; $_COOKIE['4chan_apass'] &amp;&amp; ($_POST['mode']=='usrdel'||$_GET['mode']=='latest')) {
		// ok
	} 
	else {
		 die('Posting temporarily disabled. Come back later!&lt;br/&gt;&amp;mdash;Team 4chan (uptime? what\'s that?)');
	}
}
include_once &quot;./yotsuba_config.php&quot;;
include(&quot;./postfilter.php&quot;);
include(&quot;./ads.php&quot;);
define('SQLLOGBAN', 'banned_users');		//Table (NOT DATABASE) used for holding banned users
define('SQLLOGMOD', 'mod_users');		//Table (NOT DATABASE) used for holding mod users
define('SQLLOGDEL', 'del_log');		//Table (NOT DATABASE) used for holding deletion log

if(BOARD_DIR == 'test') {
 ini_set('display_errors', 1);
}
extract($_POST);
extract($_GET);
extract($_COOKIE);

$id = intval($id);

if(array_key_exists('upfile',$_FILES)) {
$upfile_name=$_FILES[&quot;upfile&quot;][&quot;name&quot;];
$upfile=$_FILES[&quot;upfile&quot;][&quot;tmp_name&quot;];
}
else {
$upfile_name=$upfile='';
}

$path = realpath(&quot;./&quot;).'/'.IMG_DIR;
ignore_user_abort(TRUE);

if(WORD_FILT&amp;&amp;file_exists(&quot;wf.php&quot;)){include_once(&quot;wf.php&quot;);}
if(JANITOR_BOARD == 1) 
	include_once '/www/global/plugins/broomcloset.php';

//mysql_board_connect();

// truncate $str to $max_lines lines and return $str and $abbr
// where $abbr = whether or not $str was actually truncated
function abbreviate($str,$max_lines) {
	if(!defined('MAX_LINES_SHOWN')) {
		if(defined('BR_CHECK')) {
		define('MAX_LINES_SHOWN', BR_CHECK);
		} else {
		define('MAX_LINES_SHOWN', 20);
		}
		$max_lines = MAX_LINES_SHOWN;
	}
	$lines = explode(&quot;&lt;br /&gt;&quot;, $str);
	if(count($lines) &gt; $max_lines) {
		$abbr = 1;
		$lines = array_slice($lines, 0, $max_lines);
		$str = implode(&quot;&lt;br /&gt;&quot;, $lines);
	} else {
		$abbr = 0;
	}
	
	//close spans after abbreviating
	//XXX will not work with more html - use abbreviate_html from shiichan
	$str .= str_repeat(&quot;&lt;/span&gt;&quot;, substr_count($str, &quot;&lt;span&quot;) - substr_count($str, &quot;&lt;/span&quot;));
	
	return array($str, $abbr);
}


// print $contents to $filename by using a temporary file and renaming it 
// (makes *.html and *.gz if USE_GZIP is on)
function print_page($filename,$contents,$force_nogzip=0) {
	$gzip = (USE_GZIP == 1 &amp;&amp; !$force_nogzip);
	$tempfile = tempnam(realpath(RES_DIR), &quot;tmp&quot;); //note: THIS actually creates the file
	file_put_contents($tempfile, $contents, FILE_APPEND);
	rename($tempfile, $filename);
	chmod($filename, 0664); //it was created 0600

	if($gzip) {	
		$tempgz = tempnam(realpath(RES_DIR), &quot;tmp&quot;); //note: THIS actually creates the file
		$gzfp = gzopen($tempgz, &quot;w&quot;);
		gzwrite($gzfp, $contents);
		gzclose($gzfp);
		rename($tempgz, $filename . '.gz');
		chmod($filename . '.gz', 0664); //it was created 0600
	}
}

function file_get_contents_cached($filename) {
	static $cache = array();
	if(isset($cache[$filename]))
		return $cache[$filename];
	//$cache[$filename] = file_get_contents($filename);
	return $cache[$filename];
}
	
function blotter_contents() {
	static $cache;
	if(isset($cache)) return $cache;
	$ret = &quot;&quot;;
	$topN = 4; //how many lines to print
	$bl_lines = file( BLOTTER_PATH );
	$bl_top = array_slice($bl_lines, 0, $topN);
	$date = &quot;&quot;;
	foreach($bl_top as $line) {
			if(!$date) {
				$lineparts = explode(' - ', $line);
				if(strpos($lineparts[0],'&lt;font')!==FALSE) {
					$dateparts = explode('&gt;', $lineparts[0]);
					$date = $dateparts[1];
					$date = &quot;&lt;li&gt;&lt;font color=\&quot;red\&quot;&gt;Blotter updated: $date&lt;/font&gt;&quot;;
				}
				else {
					$date = $lineparts[0];
					$date = &quot;&lt;li&gt;Blotter updated: $date&quot;;
				}
			}
			$line = trim($line);
			$line = str_replace(&quot;\\&quot;, &quot;\\\\&quot;, $line);
			$line = str_replace(&quot;'&quot;, &quot;\'&quot;, $line);
			$ret .= &quot;'&lt;li&gt;$line'+\n&quot;;
	}
	$ret .= &quot;''&quot;;
	$cache = array($date,$ret);
	return array($date,$ret);
}

// insert into the rapidsearch queue
function rapidsearch_insert($board, $no, $body) {
	$board = mysql_real_escape_string($board);
	$no = (int)$no;
	$body = mysql_real_escape_string($body);
	mysql_global_do(&quot;INSERT INTO rs.rsqueue (`board`,`no`,`ts`,`com`) VALUES ('$board',$no,NOW(),'$body')&quot;);
}

function find_match_and_prefix($regex, $str, $off, &amp;$match)
{
	if (!preg_match($regex, $str, $m, PREG_OFFSET_CAPTURE, $off)) return FALSE;
	
	$moff = $m[0][1];
	$match = array(substr($str, $off, $moff-$off), $m[0][0]);

	return TRUE;
}

function spoiler_parse($com) {
	if (!find_match_and_prefix(&quot;/\[spoiler\]/&quot;, $com, 0, $m)) return $com;
	
	$bl = strlen(&quot;[spoiler]&quot;); $el = $bl+1;
	$st = '&lt;span class=&quot;spoiler&quot; onmouseover=&quot;this.style.color=\'#FFF\';&quot; onmouseout=&quot;this.style.color=this.style.backgroundColor=\'#000\'&quot; style=&quot;color:#000;background:#000&quot;&gt;';
	$et = '&lt;/span&gt;';
	$ret = $m[0].$st; $lev = 1;
	$off = strlen($m[0]) + $bl;
	
	while (1) {
		if (!find_match_and_prefix(&quot;@\[/?spoiler\]@&quot;, $com, $off, $m)) break;
		list($txt, $tag) = $m;
		
		$ret .= $txt;
		$off += strlen($txt) + strlen($tag);
		
		if ($tag == &quot;[spoiler]&quot;) {
			$ret .= $st;
			$lev++;
		} else if ($lev) {
			$ret .= $et;
			$lev--;
		}
	}
	
	$ret .= substr($com, $off, strlen($com)-$off);
	$ret .= str_repeat($et, $lev);

	return $ret;
}

//rebuild the bans in array $boards
function rebuild_bans($boards) {
    $cmd = &quot;nohup /usr/local/bin/suid_run_global bin/rebuildbans $boards &gt;/dev/null 2&gt;&amp;1 &amp;&quot;;
	exec($cmd);
}

function append_ban($board, $ip) {
    $cmd = &quot;nohup /usr/local/bin/suid_run_global bin/appendban $board $ip &gt;/dev/null 2&gt;&amp;1 &amp;&quot;;
	exec($cmd);
}

// check whether the current user can perform $action (on $no, for some actions)
// board-level access is cached in $valid_cache.
function valid($action='moderator', $no=0){
	static $valid_cache; // the access level of the user
	$access_level = array('none' =&gt; 0, 'janitor' =&gt; 1, 'janitor_this_board' =&gt; 2, 'moderator' =&gt; 5, 'manager' =&gt; 10, 'admin' =&gt; 20);
	if(!isset($valid_cache)) {
		$valid_cache = $access_level['none'];
		if(isset($_COOKIE['4chan_auser'])&amp;&amp;isset($_COOKIE['4chan_apass'])){
			$user = mysql_real_escape_string($_COOKIE['4chan_auser']);
			$pass = mysql_real_escape_string($_COOKIE['4chan_apass']);
		}
		if($user&amp;&amp;$pass) {
			$result=mysql_global_call(&quot;SELECT allow,deny FROM &quot;.SQLLOGMOD.&quot; WHERE username='$user' and password='$pass'&quot;);
			list($allow,$deny) = mysql_fetch_row($result);
			mysql_free_result($result);
			if($allow) {
				$allows = explode(',', $allow);
				$seen_janitor_token = false;
				// each token can increase the access level,
				// except that we only know that they're a moderator or a janitor for another board
				// AFTER we read all the tokens
				foreach($allows as $token) {
					if($token == 'janitor')
						$seen_janitor_token = true;
					else if($token == 'manager' &amp;&amp; $valid_cache &lt; $access_level['manager'])
						$valid_cache = $access_level['manager'];
					else if($token == 'admin' &amp;&amp; $valid_cache &lt; $access_level['admin'])
						$valid_cache = $access_level['admin'];
					else if(($token == BOARD_DIR || $token == 'all') &amp;&amp; $valid_cache &lt; $access_level['janitor_this_board'])
						$valid_cache = $access_level['janitor_this_board']; // or could be moderator, will be increased in next step
				}
				// now we can set moderator or janitor status 
				if(!$seen_janitor_token) {
					if($valid_cache &lt; $access_level['moderator'])
						$valid_cache = $access_level['moderator'];
				}
				else {
					if($valid_cache &lt; $access_level['janitor'])
						$valid_cache = $access_level['janitor'];
				}
				if($deny) {
					$denies = explode(',', $deny);
					if(in_array(BOARD_DIR,$denies)) {
						$valid_cache = $access_level['none'];
					}
				}
			}
		}
	}
	switch($action) {
		case 'moderator':
			return $valid_cache &gt;= $access_level['moderator'];
		case 'textonly':
			return $valid_cache &gt;= $access_level['moderator'];
		case 'janitor_board':
			return $valid_cache &gt;= $access_level['janitor'];
		case 'delete':
			if($valid_cache &gt;= $access_level['janitor_this_board']) {
				return true;
			}
			// if they're a janitor on another board, check for illegal post unlock			
			else if($valid_cache &gt;= $access_level['janitor']) {
				$query=mysql_global_do(&quot;SELECT COUNT(*) from reports WHERE board='&quot;.BOARD_DIR.&quot;' AND no=$no AND cat=2&quot;);
				$illegal_count = mysql_result($query, 0, 0);
				mysql_free_result($query);
				return $illegal_count &gt;= 3;
			}
		case 'reportflood':
			return $valid_cache &gt;= $access_level['janitor'];
		case 'floodbypass':
			return $valid_cache &gt;= $access_level['moderator'];
		default: // unsupported action
			return false;
	}
}

function sticky_post($no, $position) {
	global $log; log_cache();
	$post_sticknum=&quot;202701010000&quot;.sprintf(&quot;%02d&quot;,$position);
	$log[$no]['root'] = $post_sticknum;
	$log[$no]['sticky'] = '1';
	mysql_board_call('UPDATE '.SQLLOG.&quot; SET sticky='1'&quot;.
				&quot;, root='&quot;.$post_sticknum.&quot;'&quot;.
				&quot; WHERE no='&quot;.mysql_real_escape_string($no).&quot;'&quot;);
}

function permasage_post($no) {
	global $log; log_cache();
	$log[$no]['permasage'] = '1';
	mysql_board_call('UPDATE '.SQLLOG.&quot; SET permasage='1'&quot;.
				&quot; WHERE no='&quot;.mysql_real_escape_string($no).&quot;'&quot;);
}

function rebuildqueue_create_table() {
	$sql = &lt;&lt;&lt;EOSQL
CREATE TABLE `rebuildqueue` (
  `board` char(4) NOT NULL,
  `no` int(11) NOT NULL,
  `ownedby` int(11) NOT NULL default '0',
  `ts` timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,
  PRIMARY KEY  (`board`,`no`,`ownedby`)
)
EOSQL;
	mysql_board_call($sql);
}

function rebuildqueue_add($no) {
	$board = BOARD_DIR;
	$no = (int)$no;
	for($i=0;$i&lt;2;$i++)
		if(!mysql_board_call(&quot;INSERT IGNORE INTO rebuildqueue (board,no) VALUES ('$board','$no')&quot;))
			rebuildqueue_create_table();
		else
			break;
}

function rebuildqueue_remove($no) {
	$board = BOARD_DIR;
	$no = (int)$no;
	for($i=0;$i&lt;2;$i++)
		if(!mysql_board_call(&quot;DELETE FROM rebuildqueue WHERE board='$board' AND no='$no'&quot;))
			rebuildqueue_create_table();
		else
			break;
}

function rebuildqueue_take_all() {
	$board = BOARD_DIR;
	$uid = mt_rand(1, mt_getrandmax());
	for($i=0;$i&lt;2;$i++)
		if(!mysql_board_call(&quot;UPDATE rebuildqueue SET ownedby=$uid,ts=ts WHERE board='$board' AND ownedby=0&quot;))
			rebuildqueue_create_table();
		else
			break;
	$q = mysql_board_call(&quot;SELECT no FROM rebuildqueue WHERE board='$board' AND ownedby=$uid&quot;);
	$posts = array();
	while($post=mysql_fetch_assoc($q))
		$posts[] = $post['no'];
	return $posts;
}

function iplog_add($board, $no, $ip) {
	$board = mysql_real_escape_string($board);
	$no = (int)$no;
	$ip = mysql_real_escape_string($ip);
	mysql_board_call(&quot;INSERT INTO iplog (board,no,ip) VALUES ('$board',$no,'$ip')&quot;);
}
// build a structure out of all the posts in the database.
// this lets us replace a LOT of queries with a simple array access.
// it only builds the first time it was called.
// rather than calling log_cache(1) to rebuild everything,
// you should just manipulate the structure directly.
function log_cache($invalidate=0) {
	global $log, $ipcount, $mysql_unbuffered_reads, $lastno;
	$ips = array();
	$threads = array(); // no's
	if($invalidate==0 &amp;&amp; isset($log)) return;
	$log = array(); // no -&gt; [ data ]
	//mysql_board_call(&quot;SET read_buffer_size=1048576&quot;);
	$mysql_unbuffered_reads = 1;
	//$query = mysql_board_call(&quot;SELECT * FROM &quot;.SQLLOG);
	$offset = 0;
	$lastno = 0;
	//while($row = mysql_fetch_assoc($query)) {
		if($row['no'] &gt; $lastno) $lastno = $row['no'];
		$ips[$row['host']] = 1;
		// initialize log row if necessary
		if( !isset($log[$row['no']]) ) { 
			$log[$row['no']] = $row;
			$log[$row['no']]['children'] = array();
		} else { // otherwise merge it with $row
			foreach($row as $key=&gt;$val)
				$log[$row['no']][$key] = $val;
		}
		// if this is a reply
		if($row['resto']) {
			// initialize whatever we need to
			if( !isset($log[$row['resto']]) ) 
			//	$log[$row['resto']] = array();
			if( !isset($log[$row['resto']]['children']) )
				$log[$row['resto']]['children'] = array();
				
			// add this post to list of children
			$log[$row['resto']]['children'][$row['no']] = 1;
			if($row['fsize']) {
				if(!isset($log[$row['resto']]['imgreplycount']))
					$log[$row['resto']]['imgreplycount'] = 0;
				else
					$log[$row['resto']]['imgreplycount']++;
			}
		} /*else {
			$threads[] = $row['no'];
		}*/
	}
	
	//$query = mysql_board_call(&quot;SELECT no FROM &quot;.SQLLOG.&quot; WHERE root&gt;0 order by root desc&quot;);
	while($row = mysql_fetch_assoc($query)) {
		if(isset($log[$row['no']]) &amp;&amp; $log[$row['no']]['resto']==0)
			$threads[] = $row['no'];
	}
	$log['THREADS'] = $threads;
	$mysql_unbuffered_reads = 0;
	
	// calculate old-status for PAGE_MAX mode
	if(EXPIRE_NEGLECTED != 1) {
		rsort($threads, SORT_NUMERIC);
	
		$threadcount = count($threads);
		if(PAGE_MAX &gt; 0) // the lowest 5% of maximum threads get marked old
			for($i = floor(0.95*PAGE_MAX*PAGE_DEF); $i &lt; $threadcount; $i++) {
				if(!$log[$threads[$i]]['sticky'] &amp;&amp; EXPIRE_NEGLECTED != 1)
					$log[$threads[$i]]['old'] = 1;
			}
		else { // threads w/numbers below 5% of LOG_MAX get marked old
			foreach($threads as $thread) {
				if($lastno-LOG_MAX*0.95&gt;$thread)
					if(!$log[$thread]['sticky'])
						$log[$thread]['old'] = 1;				
			}
		}
	}
	
	$ipcount = count($ips);
//}


// deletes a post from the database
// imgonly: whether to just delete the file or to delete from the database as well
// automatic: always delete regardless of password/admin (for self-pruning)
// children: whether to delete just the parent post of a thread or also delete the children
// die: whether to die on error
// careful, setting children to 0 could leave orphaned posts.
function delete_post($resno, $pwd, $imgonly=0, $automatic=0, $children=1, $die=1) {
	global $log, $path;
	log_cache();
	$resno = intval($resno);

	// get post info
	if(!isset($log[$resno])){if ($die) error(&quot;Can't find the post $resno.&quot;);}
	$row=$log[$resno];
	
	// check password- if not ok, check admin status (and set $admindel if allowed)
	$delete_ok = ( $automatic || (substr(md5($pwd),2,8) == $row['pwd']) || ($row['host'] == $_SERVER['REMOTE_ADDR']) );
	if( ($pwd==ADMIN_PASS || $pwd==ADMIN_PASS2) ) { $delete_ok = $admindel = valid('delete', $resno); }
	if(!$delete_ok) error(S_BADDELPASS);

	// check ghost bumping
	if(!isset($admindel) || !$admindel) {
		if(BOARD_DIR == 'a' &amp;&amp; (int)$row['time'] &gt; (time() - 25) &amp;&amp; $row['email'] != 'sage') {
			$ghostdump = var_export(array(
				'server'=&gt;$_SERVER,
				'post'=&gt;$_POST,
				'cookie'=&gt;$_COOKIE,
				'row'=&gt;$row),true);
			//file_put_contents('ghostbump.'.time(),$ghostdump);
		}
	}

	if(isset($admindel) &amp;&amp; $admindel) { // extra actions for admin user
		$auser = mysql_escape_string($_COOKIE['4chan_auser']);
		$adfsize=($row['fsize']&gt;0)?1:0;
		$adname=str_replace('&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!','#',$row['name']);
		if($imgonly) { $imgonly=1; } else { $imgonly=0; }
		$row['sub'] = mysql_escape_string($row['sub']);
		$row['com'] = mysql_escape_string($row['com']);
		$row['filename'] = mysql_escape_string($row['filename']);
		mysql_global_do(&quot;INSERT INTO &quot;.SQLLOGDEL.&quot; (imgonly,postno,board,name,sub,com,img,filename,admin) values('$imgonly','$resno','&quot;.SQLLOG.&quot;','$adname','{$row['sub']}','{$row['com']}','$adfsize','{$row['filename']}','$auser')&quot;);	
	}
	
	if($row['resto']==0 &amp;&amp; $children &amp;&amp; !$imgonly) // select thread and children
		$result=mysql_board_call(&quot;select no,resto,tim,ext from &quot;.SQLLOG.&quot; where no=$resno or resto=$resno&quot;);
	else // just select the post
		$result=mysql_board_call(&quot;select no,resto,tim,ext from &quot;.SQLLOG.&quot; where no=$resno&quot;);
	
	while($delrow=mysql_fetch_array($result)) {
		// delete
		$delfile = $path.$delrow['tim'].$delrow['ext'];	//path to delete
		$delthumb = THUMB_DIR.$delrow['tim'].'s.jpg';
		if(is_file($delfile)) unlink($delfile); // delete image
		if(is_file($delthumb)) unlink($delthumb); // delete thumb
		if(OEKAKI_BOARD == 1 &amp;&amp; is_file($path.$delrow['tim'].'.pch')) 
			unlink($path.$delrow['tim'].'.pch'); // delete oe animation
		if(!$imgonly){ // delete thread page &amp; log_cache row
			if($delrow['resto'])
				unset( $log[$delrow['resto']]['children'][$delrow['no']] );
			unset( $log[$delrow['no']] );
			$log['THREADS'] = array_diff($log['THREADS'], array($delrow['no'])); // remove from THREADS
			mysql_global_do(&quot;DELETE FROM reports WHERE no=&quot;.$delrow['no']); // clear reports
			if(USE_GZIP == 1) {
				@unlink(RES_DIR.$delrow['no'].PHP_EXT);
				@unlink(RES_DIR.$delrow['no'].PHP_EXT.'.gz');
			}
			else {
				@unlink(RES_DIR.$delrow['no'].PHP_EXT);
			}
		}
	}

	//delete from DB
	if($row['resto']==0 &amp;&amp; $children &amp;&amp; !$imgonly) // delete thread and children
		$result=mysql_board_call(&quot;delete from &quot;.SQLLOG.&quot; where no=$resno or resto=$resno&quot;);
	elseif(!$imgonly) // just delete the post
		$result=mysql_board_call(&quot;delete from &quot;.SQLLOG.&quot; where no=$resno&quot;);
			
	return $row['resto']; // so the caller can know what pages need to be rebuilt
}

// purge old posts
// should be called whenever a new post is added.
function trim_db() {
	if(JANITOR_BOARD == 1) return;
	
	log_cache();
	
	$maxposts = LOG_MAX;
	// max threads = max pages times threads-per-page
	$maxthreads = (PAGE_MAX &gt; 0)?(PAGE_MAX * PAGE_DEF):0;
	
	// New max-page method
	if($maxthreads) {
		$exp_order = 'no';
		if(EXPIRE_NEGLECTED == 1) $exp_order = 'root';
		logtime('trim_db before select threads');
		$result = mysql_board_call(&quot;SELECT no FROM &quot;.SQLLOG.&quot; WHERE sticky=0 AND resto=0 ORDER BY $exp_order ASC&quot;);
		logtime('trim_db after select threads');
		$threadcount = mysql_num_rows($result);
		while($row=mysql_fetch_array($result) and $threadcount &gt;= $maxthreads) {
			delete_post($row['no'], 'trim', 0, 1); // imgonly=0, automatic=1, children=1
			$threadcount--;
		}
		mysql_free_result($result);
	// Original max-posts method (note: cleans orphaned posts later than parent posts)
	} else {
		// make list of stickies
		$stickies = array(); // keys are stickied thread numbers
		$result = mysql_board_call(&quot;SELECT no from &quot;.SQLLOG.&quot; where sticky=1 and resto=0&quot;);
		while($row=mysql_fetch_array($result)) {
			$stickies[ $row['no'] ] = 1;
		}
		
		$result = mysql_board_call(&quot;SELECT no,resto,sticky FROM &quot;.SQLLOG.&quot; ORDER BY no ASC&quot;);
		$postcount = mysql_num_rows($result);
		while($row=mysql_fetch_array($result) and $postcount &gt;= $maxposts) {
			// don't delete if this is a sticky thread
			if($row['sticky'] == 1) continue; 
			// don't delete if this is a REPLY to a sticky
			if($row['resto'] != 0 &amp;&amp; $stickies[ $row['resto'] ] == 1) continue; 
			delete_post($row['no'], 'trim', 0, 1, 0); // imgonly=0, automatic=1, children=0
			$postcount--;
		}
		mysql_free_result($result);
	}

}

//resno - thread page to update (no of thread OP)
//rebuild - don't rebuild page indexes
function updatelog($resno=0,$rebuild=0){
  global $log,$path;
	set_time_limit(60);
if($_SERVER['REQUEST_METHOD']=='GET' &amp;&amp; !valid()) die(''); // anti ddos
	log_cache();
	
	  $imgdir = ((USE_SRC_CGI==1)?str_replace('src','src.cgi',IMG_DIR2):IMG_DIR2);
	if(defined('INTERSTITIAL_LINK')) $imgdir .= INTERSTITIAL_LINK;
	  $thumbdir = THUMB_DIR2;
		$imgurl = DATA_SERVER;


  $resno=(int)$resno;
  if($resno){
   	if(!isset($log[$resno])) {
   		updatelog(0,$rebuild); // the post didn't exist, just rebuild the indexes
   		return;
   	}
   	else if($log[$resno]['resto']) {
			updatelog($log[$resno]['resto'],$rebuild); // $resno is a reply, try rebuilding the parent
			return;
		}
  }
  
  if($resno){
  	$treeline = array($resno); logtime(&quot;Formatting thread page&quot;);
    //if(!$treeline=mysql_board_call(&quot;select * from &quot;.SQLLOG.&quot; where root&gt;0 and no=&quot;.$resno.&quot; order by root desc&quot;)){echo S_SQLFAIL;}
  }else{
  	$treeline = $log['THREADS']; logtime(&quot;Formatting index page&quot;);
    //if(!$treeline=mysql_board_call(&quot;select * from &quot;.SQLLOG.&quot; where root&gt;0 order by root desc&quot;)){echo S_SQLFAIL;}
  }


	$counttree=count($treeline);
  //$counttree=mysql_num_rows($treeline);
  if(!$counttree){
    $logfilename=PHP_SELF2;
    $dat='';
    head($dat,$resno);
    form($dat,$resno);
    print_page($logfilename, $dat);
  }
  
	if(UPDATE_THROTTLING &gt;= 1) {
	  $update_start = time();
	  touch(&quot;updatelog.stamp&quot;, $update_start);
	  $low_priority = false;
	  clearstatcache();
	  if(@filemtime(PHP_SELF) &gt; $update_start-UPDATE_THROTTLING) {
	  	$low_priority = true;
	  	//touch($update_start . &quot;.lowprio&quot;);
	  }
	  else {
	  	touch(PHP_SELF,$update_start);
	  }
	 // 	$mt = @filemtime(PHP_SELF);
	//  	touch($update_start . &quot;.$mt.highprio&quot;);
	}
	
	// if we're using CACHE_TTL method
	if(CACHE_TTL &gt;= 1) {
		if($resno) {
			$logfilename = RES_DIR.$resno.PHP_EXT;
		}
		else {
			$logfilename = PHP_SELF2;
		}
		//if(USE_GZIP == 1) $logfilename .= '.html';
		// if the file has been made and it's younger than CACHE_TTL seconds ago
		clearstatcache();
		if(file_exists($logfilename) &amp;&amp; filemtime($logfilename) &gt; (time() - CACHE_TTL)) {
			// save the post to be rebuilt later
			rebuildqueue_add($resno);
			// if it's a thread, try again on the indexes
			if($resno &amp;&amp; !$rebuild) updatelog();
			// and we don't do any more rebuilding on this request
			return true;
		}
		else {
			// we're gonna update it now, so take it out of the queue
			rebuildqueue_remove($resno);
			// and make sure nobody else starts trying to update it because it's too old
			touch($logfilename);
		}			
	}
  
  for($page=0;$page&lt;$counttree;$page+=PAGE_DEF){
    $dat='';
    head($dat,$resno);
    form($dat,$resno);
    if(!$resno){
      $st = $page;
    }
    $dat.='&lt;form name=&quot;delform&quot; action=&quot;';
    $dat.=PHP_SELF_ABS.'&quot; method=POST&gt;';

  for($i = $st; $i &lt; $st+PAGE_DEF; $i++){
  	if(UPDATE_THROTTLING &gt;= 1) {
	  	clearstatcache();
  		if($low_priority &amp;&amp; @filemtime(&quot;updatelog.stamp&quot;) &gt; $update_start) {
  				//touch($update_start . &quot;.throttled&quot;);
	  			return;
	  	}
		if(rand(0,15)==0) return;
	 }
  	
  	list($_unused,$no) = each($treeline);
    //list($no,$sticky,$permasage,$closed,$now,$name,$email,$sub,$com,$host,$pwd,$filename,$ext,$w,$h,$tn_w,$tn_h,$tim,$time,$md5,$fsize,$root,$resto)=mysql_fetch_row($treeline);
    if(!$no){break;}
    extract($log[$no]);
    //if(!$resno&amp;&amp;!file_exists(RES_DIR.$no.PHP_EXT)) { updatelog($no); break; } // uhh

	//POST FILTERING
	if(JANITOR_BOARD == 1) {
		$name = broomcloset_capcode($name);
	}
        if($email) $name = &quot;&lt;a href=\&quot;mailto:$email\&quot; class=\&quot;linkmail\&quot;&gt;$name&lt;/a&gt;&quot;;
    if(strpos($sub,&quot;SPOILER&lt;&gt;&quot;)===0) {
    	$sub = substr($sub,strlen(&quot;SPOILER&lt;&gt;&quot;)); //trim out SPOILER&lt;&gt;
    	$spoiler = 1;
    } else $spoiler = 0;
    $com = auto_link($com,$resno);
    if(!$resno) list($com,$abbreviated) = abbreviate($com, MAX_LINES_SHOWN);

	  if(isset($abbreviated) &amp;&amp; $abbreviated) $com .= &quot;&lt;br /&gt;&lt;span class=\&quot;abbr\&quot;&gt;Comment too long. Click &lt;a href=\&quot;&quot;.RES_DIR.($resto?$resto:$no).PHP_EXT.&quot;#$no\&quot;&gt;here&lt;/a&gt; to view the full text.&lt;/span&gt;&quot;;
    // Picture file name
    $img = $path.$tim.$ext;
    $displaysrc = $imgdir.$tim.$ext;
    $linksrc = ((USE_SRC_CGI==1)?(str_replace(&quot;.cgi&quot;,&quot;&quot;,$imgdir).$tim.$ext):$displaysrc);
	if(defined('INTERSTITIAL_LINK')) $linksrc = str_replace(INTERSTITIAL_LINK,&quot;&quot;,$linksrc);
    $src = IMG_DIR.$tim.$ext;
    $longname = $filename.$ext;
    if (strlen($filename)&gt;40) {
	    $shortname = substr($filename, 0, 40).&quot;(...)&quot;.$ext;
    } else {
	    $shortname = $longname;
    }
    // img tag creation
    $imgsrc = &quot;&quot;;
    if($ext){
    	// turn the 32-byte ascii md5 into a 24-byte base64 md5
    	$shortmd5 = base64_encode(pack(&quot;H*&quot;, $md5));
      if ($fsize &gt;= 1048576) { $size = round(($fsize/1048576),2).&quot; M&quot;;
      } else if ($fsize &gt;= 1024) { $size = round($fsize/1024).&quot; K&quot;;
      } else { $size = $fsize.&quot; &quot;; }
      if(!$tn_w &amp;&amp; !$tn_h &amp;&amp; $ext==&quot;.gif&quot;){
      	$tn_w=$w;
        $tn_h=$h;
      }
      	          if($spoiler) {
	          $size= &quot;Spoiler Image, $size&quot;; 
	              $imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=\&quot;&quot;.SPOILER_THUMB.&quot;\&quot; border=0 align=left hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;	          
	          } elseif($tn_w &amp;&amp; $tn_h){//when there is size...
        if(@is_file(THUMB_DIR.$tim.'s.jpg')){
          $imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=&quot;.$thumbdir.$tim.'s.jpg'.&quot; border=0 align=left width=$tn_w height=$tn_h hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;
        }else{
          $imgsrc = &quot;&lt;a href=\&quot;&quot;.$displaysrc.&quot;\&quot; target=_blank&gt;&lt;span class=\&quot;tn_thread\&quot; title=\&quot;&quot;.$size.&quot;B\&quot;&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;;
        }
      }else{
        if(@is_file(THUMB_DIR.$tim.'s.jpg')){
          $imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=&quot;.$thumbdir.$tim.'s.jpg'.&quot; border=0 align=left hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;
        }else{
          $imgsrc = &quot;&lt;a href=\&quot;&quot;.$displaysrc.&quot;\&quot; target=_blank&gt;&lt;span class=\&quot;tn_thread\&quot; title=\&quot;&quot;.$size.&quot;B\&quot;&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;;
        }
      }
      if (!is_file($src)) {
	      $dat.='&lt;img src=&quot;'.$imgurl.'filedeleted.gif&quot; alt=&quot;File deleted.&quot;&gt;';
      } else {
        $dimensions=($ext=='.pdf')?'PDF':&quot;{$w}x{$h}&quot;;
      	if ($resno) {
   	      $dat.=&quot;&lt;span class=\&quot;filesize\&quot;&gt;&quot;.S_PICNAME.&quot;&lt;a href=\&quot;$linksrc\&quot; target=\&quot;_blank\&quot;&gt;$time$ext&lt;/a&gt;-(&quot;.$size.&quot;B, &quot;.$dimensions.&quot;, &lt;span title=\&quot;&quot;.$longname.&quot;\&quot;&gt;&quot;.$shortname.&quot;&lt;/span&gt;)&lt;/span&gt;&quot;.$imgsrc;
				} else {
		      $dat.=&quot;&lt;span class=\&quot;filesize\&quot;&gt;&quot;.S_PICNAME.&quot;&lt;a href=\&quot;$linksrc\&quot; target=\&quot;_blank\&quot;&gt;$time$ext&lt;/a&gt;-(&quot;.$size.&quot;B, &quot;.$dimensions.&quot;)&lt;/span&gt;&quot;.$imgsrc;
        }
      }
    }
    //  Main creation
    $dat.=&quot;&lt;a name=\&quot;$resno\&quot;&gt;&lt;/a&gt;\n&lt;input type=checkbox name=\&quot;$no\&quot; value=delete&gt;&lt;span class=\&quot;filetitle\&quot;&gt;$sub&lt;/span&gt; \n&quot;;
    $dat.=&quot;&lt;span class=\&quot;postername\&quot;&gt;$name&lt;/span&gt; $now &lt;span id=\&quot;nothread$no\&quot;&gt;&quot;;

    if($sticky==1) {
    	$stickyicon=' &lt;img src=&quot;'.$imgurl.'sticky.gif&quot; alt=&quot;sticky&quot;&gt; ';
    } else { $stickyicon=&quot;&quot;; }
    if($closed==1) {
    	$stickyicon .= ' &lt;img src=&quot;'.$imgurl.'closed.gif&quot; alt=&quot;closed&quot;&gt; ';
    }
    
    if(PARTY==1) {
    	$dat .= &quot;&lt;img src='http://img.4chan.org/xmashat.gif' style='position:absolute;margin-top:-100px;left:0px;'&gt;&quot;;
    }
    	
    if($resno) {
    	$dat.=&quot;&lt;a href=\&quot;#$no\&quot; class=\&quot;quotejs\&quot;&gt;No.&lt;/a&gt;&lt;a href=\&quot;javascript:quote('$no')\&quot; class=\&quot;quotejs\&quot;&gt;$no&lt;/a&gt; $stickyicon &amp;nbsp; &quot;;
    } else {
    	$dat.=&quot;&lt;a href=\&quot;&quot;.RES_DIR.$no.PHP_EXT.&quot;#&quot;.$no.&quot;\&quot; class=\&quot;quotejs\&quot;&gt;No.&lt;/a&gt;&lt;a href=\&quot;&quot;.RES_DIR.$no.PHP_EXT.&quot;#q&quot;.$no.&quot;\&quot; class=\&quot;quotejs\&quot;&gt;$no&lt;/a&gt; $stickyicon &amp;nbsp; [&lt;a href=\&quot;&quot;.RES_DIR.$no.PHP_EXT.&quot;\&quot;&gt;&quot;.S_REPLY.&quot;&lt;/a&gt;]&quot;;
    }
    $dat.=&quot;&lt;/span&gt;\n&lt;blockquote&gt;$com&lt;/blockquote&gt;&quot;;

     // Deletion pending
      if(isset($log[$no]['old'])) $dat.=&quot;&lt;span class=\&quot;oldpost\&quot;&gt;&quot;.S_OLD.&quot;&lt;/span&gt;&lt;br&gt;\n&quot;;

    $resline = $log[$no]['children'];
    ksort($resline);
    $countres=count($log[$no]['children']);
    $t=0;
    if($sticky==1) {
	    $disam=1;
    } elseif(defined('REPLIES_SHOWN')) {
    	$disam=REPLIES_SHOWN;
    } else {
    	$disam=5;
    }
    $s=$countres - $disam;
	  $cur=1;
	  while ($s &gt;= $cur) {
	    list($row) = each($resline);
      if($log[$row][&quot;fsize&quot;]!=0) { $t++; }
	    $cur++;
		}
    if ($countres!=0) reset($resline);

    if(!$resno){
    if ($s&lt;2) { $posts=&quot; post&quot;; } else { $posts=&quot; posts&quot;; }
    if ($t&lt;2) { $replies=&quot;reply&quot;; } else { $replies=&quot;replies&quot;; }
     if(($s&gt;0)&amp;&amp;($t==0)){
      $dat.=&quot;&lt;span class=\&quot;omittedposts\&quot;&gt;&quot;.$s.$posts.&quot; omitted. Click Reply to view.&lt;/span&gt;\n&quot;;
     } elseif (($s&gt;0)&amp;&amp;($t&gt;0)) {
      $dat.=&quot;&lt;span class=\&quot;omittedposts\&quot;&gt;&quot;.$s.$posts.&quot; and &quot;.$t.&quot; image &quot;.$replies.&quot; omitted. Click Reply to view.&lt;/span&gt;\n&quot;;
     }
    }else{$s=0;}
	
    while(list($resrow)=each($resline)){
      if($s&gt;0){$s--;continue;}
      //list($no,$sticky,$permasage,$closed,$now,$name,$email,$sub,$com,$host,$pwd,$filename,$ext,$w,$h,$tn_w,$tn_h,$tim,$time,$md5,$fsize,$root,$resto)=$resrow;
      extract($log[$resrow]);
      if(!$no){break;}

	//POST FILTERING
	if(JANITOR_BOARD == 1) {
		$name = broomcloset_capcode($name);
	}
        if($email) $name = &quot;&lt;a href=\&quot;mailto:$email\&quot; class=\&quot;linkmail\&quot;&gt;$name&lt;/a&gt;&quot;;
    if(strpos($sub,&quot;SPOILER&lt;&gt;&quot;)===0) {
    	$sub = substr($sub,strlen(&quot;SPOILER&lt;&gt;&quot;)); //trim out SPOILER&lt;&gt;
    	$spoiler = 1;
    } else $spoiler = 0;
    $com = auto_link($com,$resno);
    if(!$resno) list($com,$abbreviated) = abbreviate($com, MAX_LINES_SHOWN);

	  if(isset($abbreviated)&amp;&amp;$abbreviated) $com .= &quot;&lt;br /&gt;&lt;span class=\&quot;abbr\&quot;&gt;Comment too long. Click &lt;a href=\&quot;&quot;.RES_DIR.($resto?$resto:$no).PHP_EXT.&quot;#$no\&quot;&gt;here&lt;/a&gt; to view the full text.&lt;/span&gt;&quot;;
	  
	        // Picture file name
	        $r_img = $path.$tim.$ext;
	        $r_displaysrc = $imgdir.$tim.$ext;
            $r_linksrc = ((USE_SRC_CGI==1)?(str_replace(&quot;.cgi&quot;,&quot;&quot;,$imgdir).$tim.$ext):$r_displaysrc);
	if(defined('INTERSTITIAL_LINK')) $r_linksrc = str_replace(INTERSTITIAL_LINK,&quot;&quot;,$r_linksrc);
	        $r_src = IMG_DIR.$tim.$ext;
	        $longname = $filename.$ext;
	        if (strlen($filename)&gt;30) {
	          $shortname = substr($filename, 0, 30).&quot;(...)&quot;.$ext;
	        } else {
	          $shortname = $longname;
	        }
	        // img tag creation
	        $r_imgsrc = &quot;&quot;;
	        if($ext){
	            	// turn the 32-byte ascii md5 into a 24-byte base64 md5
    		$shortmd5 = base64_encode(pack(&quot;H*&quot;, $md5));
		  if ($fsize &gt;= 1048576) { $size = round(($fsize/1048576),2).&quot; M&quot;;
		  } else if ($fsize &gt;= 1024) { $size = round($fsize/1024).&quot; K&quot;;
		  } else { $size = $fsize.&quot; &quot;; }
	          if(!$tn_w &amp;&amp; !$tn_h &amp;&amp; $ext==&quot;.gif&quot;){
	            $tn_w=$w;
	            $tn_h=$h;
	          }
	          if($spoiler) {
	          $size= &quot;Spoiler Image, $size&quot;; 
	              $r_imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$r_displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=\&quot;&quot;.SPOILER_THUMB.&quot;\&quot; border=0 align=left hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;	          
	          }
	          elseif($tn_w &amp;&amp; $tn_h){//when there is size...
	            if(@is_file(THUMB_DIR.$tim.'s.jpg')){
	              $r_imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$r_displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=&quot;.$thumbdir.$tim.'s.jpg'.&quot; border=0 align=left width=$tn_w height=$tn_h hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;
	            }else{
	              $r_imgsrc = &quot;&lt;a href=\&quot;&quot;.$r_displaysrc.&quot;\&quot; target=_blank&gt;&lt;span class=\&quot;tn_reply\&quot; title=\&quot;&quot;.$size.&quot;B\&quot;&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;;
	            }
	          }else{
	            if(@is_file(THUMB_DIR.$tim.'s.jpg')){
	              $r_imgsrc = &quot;&lt;br&gt;&lt;a href=\&quot;&quot;.$r_displaysrc.&quot;\&quot; target=_blank&gt;&lt;img src=&quot;.$thumbdir.$tim.'s.jpg'.&quot; border=0 align=left hspace=20 alt=\&quot;&quot;.$size.&quot;B\&quot; md5=\&quot;$shortmd5\&quot;&gt;&lt;/a&gt;&quot;;
	            }else{
	              $r_imgsrc = &quot;&lt;a href=\&quot;&quot;.$r_displaysrc.&quot;\&quot; target=_blank&gt;&lt;span class=\&quot;tn_reply\&quot; title=\&quot;&quot;.$size.&quot;B\&quot;&gt;Thumbnail unavailable&lt;/span&gt;&lt;/a&gt;&quot;;
	            }
	          }
	          if (!is_file($r_src)) {
	            $r_imgreply='&lt;br&gt;&lt;img src=&quot;'.$imgurl.'filedeleted-res.gif&quot; alt=&quot;File deleted.&quot;&gt;';
	          } else {
	          	$dimensions=($ext=='.pdf')?'PDF':&quot;{$w}x{$h}&quot;;
            	if ($resno) {
		            $r_imgreply=&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span class=\&quot;filesize\&quot;&gt;&quot;.S_PICNAME.&quot;&lt;a href=\&quot;$r_linksrc\&quot; target=\&quot;_blank\&quot;&gt;$time$ext&lt;/a&gt;-(&quot;.$size.&quot;B, &quot;.$dimensions.&quot;, &lt;span title=\&quot;&quot;.$longname.&quot;\&quot;&gt;&quot;.$shortname.&quot;&lt;/span&gt;)&lt;/span&gt;&quot;.$r_imgsrc;
							} else {
		            $r_imgreply=&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span class=\&quot;filesize\&quot;&gt;&quot;.S_PICNAME.&quot;&lt;a href=\&quot;$r_linksrc\&quot; target=\&quot;_blank\&quot;&gt;$time$ext&lt;/a&gt;-(&quot;.$size.&quot;B, &quot;.$dimensions.&quot;)&lt;/span&gt;&quot;.$r_imgsrc;
              }
	          }
	        }
	        
      // Main Reply creation
      $dat.=&quot;&lt;a name=\&quot;$no\&quot;&gt;&lt;/a&gt;\n&quot;;
          	$dat.=&quot;&lt;table&gt;&lt;tr&gt;&lt;td nowrap class=\&quot;doubledash\&quot;&gt;&amp;gt;&amp;gt;&lt;/td&gt;&lt;td id=\&quot;$no\&quot; class=\&quot;reply\&quot;&gt;\n&quot;;
//      if (($t&gt;3)&amp;&amp;($fsize!=0)) {
//      $dat.=&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;b&gt;Image hidden&lt;/b&gt;&amp;nbsp;&amp;nbsp; $now No.$no \n&quot;;
//			} else {
      $dat.=&quot;&lt;input type=checkbox name=\&quot;$no\&quot; value=delete&gt;&lt;span class=\&quot;replytitle\&quot;&gt;$sub&lt;/span&gt; \n&quot;;
      $dat.=&quot;&lt;span class=\&quot;commentpostername\&quot;&gt;$name&lt;/span&gt; $now &lt;span id=\&quot;norep$no\&quot;&gt;&quot;;
      if($resno) {
        $dat.=&quot;&lt;a href=\&quot;#$no\&quot; class=\&quot;quotejs\&quot;&gt;No.&lt;/a&gt;&lt;a href=\&quot;javascript:quote('$no')\&quot; class=\&quot;quotejs\&quot;&gt;$no&lt;/a&gt;&lt;/span&gt;&quot;;
      } else {
        $dat.=&quot;&lt;a href=\&quot;&quot;.RES_DIR.$resto.PHP_EXT.&quot;#$no\&quot; class=\&quot;quotejs\&quot;&gt;No.&lt;/a&gt;&lt;a href=\&quot;&quot;.RES_DIR.$resto.PHP_EXT.&quot;#q$no\&quot; class=\&quot;quotejs\&quot;&gt;$no&lt;/a&gt;&lt;/span&gt;&quot;;
      }
      if(isset($r_imgreply)) $dat.=$r_imgreply; 
      $dat.=&quot;&lt;blockquote&gt;$com&lt;/blockquote&gt;&quot;;
//      }
      $dat.=&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;
    	unset($r_imgreply);
    }
    $dat.=&quot;&lt;br clear=left&gt;&lt;hr&gt;\n&quot;;
    clearstatcache();//clear stat cache of a file
    //mysql_free_result($resline);
	$p++;
    if($resno){break;} //only one tree line at time of res
  }
	// bottom of a page
	if(BOTTOM_AD == 1) {
		$bottomad = &quot;&quot;;
		
		if (defined(&quot;BOTTOM_TXT&quot;) &amp;&amp; BOTTOM_TXT) {
			$bottomad .= ad_text_for(BOTTOM_TXT);
		}
		
		if (defined(&quot;BOTTOM_TABLE&quot;) &amp;&amp; BOTTOM_TABLE) {
			list($bottomimg,$bottomlink) = rid(BOTTOM_TABLE,1);
			$bottomad .= &quot;&lt;center&gt;&lt;a href=\&quot;$bottomlink\&quot; target=\&quot;_blank\&quot;&gt;&lt;img style=\&quot;border:1px solid black;\&quot; src=\&quot;$bottomimg\&quot; width=728 height=90 border=0 /&gt;&lt;/a&gt;&lt;/center&gt;&quot;;
		}
		
		if($bottomad)
			$dat .= &quot;$bottomad&lt;hr&gt;&quot;;
	}
		
$dat.='&lt;table align=right&gt;&lt;tr&gt;&lt;td nowrap align=center class=deletebuttons&gt;
&lt;input type=hidden name=mode value=usrdel&gt;'.S_REPDEL.' [&lt;input class=checkbox type=checkbox name=onlyimgdel value=on&gt;'.S_DELPICONLY.']&lt;br&gt;
'.S_DELKEY.' &lt;input class=inputtext type=password name=&quot;pwd&quot; size=8 maxlength=8 value=&quot;&quot;&gt;
&lt;input type=submit value=&quot;'.S_DELETE.'&quot;&gt;&lt;input type=&quot;button&quot; value=&quot;Report&quot; onclick=&quot;var o=document.getElementsByTagName(\'INPUT\');for(var i=0;i&lt;o.length;i++)if(o[i].type==\'checkbox\' &amp;&amp; o[i].checked &amp;&amp; o[i].value==\'delete\') return reppop(\''.PHP_SELF_ABS.'?mode=report&amp;no=\'+o[i].name+\'\');&quot;&gt;&lt;/form&gt;&lt;script&gt;document.delform.pwd.value=get_pass(&quot;4chan_pass&quot;);&lt;/script&gt;&lt;/td&gt;&lt;/tr&gt;';
if (strpos($_SERVER['SERVER_NAME'],&quot;.4chan.org&quot;)) {
	$dat.='&lt;tr&gt;&lt;td align=&quot;right&quot;&gt;Style [';
	$dat.='&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Yotsuba\'); return false;&quot;&gt;Yotsuba&lt;/a&gt; | ';
	$dat.='&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Yotsuba B\'); return false;&quot;&gt;Yotsuba B&lt;/a&gt; | ';
	$dat.='&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Futaba\'); return false;&quot;&gt;Futaba&lt;/a&gt; | ';
	$dat.='&lt;a href=&quot;#&quot; onclick=&quot;setActiveStyleSheet(\'Burichan\'); return false;&quot;&gt;Burichan&lt;/a&gt;]&lt;/td&gt;&lt;/tr&gt;';
}
$dat.='&lt;/table&gt;';

    if(!$resno){ // if not in res display mode
      $prev = $st - PAGE_DEF;
      $next = $st + PAGE_DEF;
    // Page navigation
      $dat.=&quot;&lt;table class=pages align=left border=1&gt;&lt;tr&gt;&quot;;
      if($prev &gt;= 0){ //ok to make prev button
        if($prev==0){
          $dat.=&quot;&lt;form action=\&quot;&quot;.PHP_SELF2.&quot;\&quot; onsubmit='location=this.action;return false;' method=get&gt;&lt;td&gt;&quot;;
        }else{
          $dat.=&quot;&lt;form action=\&quot;&quot;.$prev/PAGE_DEF.PHP_EXT.&quot;\&quot; onsubmit='location=this.action;return false;' method=get&gt;&lt;td&gt;&quot;;
        }
        $dat.=&quot;&lt;input type=submit value=\&quot;&quot;.S_PREV.&quot;\&quot; accesskey=\&quot;z\&quot;&gt;&quot;;
        $dat.=&quot;&lt;/td&gt;&lt;/form&gt;&quot;;
      }else{$dat.=&quot;&lt;td&gt;&quot;.S_FIRSTPG.&quot;&lt;/td&gt;&quot;;}
		// page listing
      $dat.=&quot;&lt;td&gt;&quot;;
      for($i = 0; $i &lt; $counttree ; $i+=PAGE_DEF){
      	if( !(PAGE_MAX &gt; 0) )
        	if($i&amp;&amp;!($i%(PAGE_DEF*10))){$dat.=&quot;&lt;br&gt;&quot;;} // linebreak every 10 pages
        if($st==$i){$dat.=&quot;[&lt;b&gt;&quot;.($i/PAGE_DEF).&quot;&lt;/b&gt;] &quot;;} // don't link current page
        else{
          if($i==0){$dat.=&quot;[&lt;a href=\&quot;&quot;.PHP_SELF2.&quot;\&quot;&gt;0&lt;/a&gt;] &quot;;}
          else{$dat.=&quot;[&lt;a href=\&quot;&quot;.($i/PAGE_DEF).PHP_EXT.&quot;\&quot;&gt;&quot;.($i/PAGE_DEF).&quot;&lt;/a&gt;] &quot;;}
        }
      }
      // continue printing up to PAGE_MAX if we're using that mode... this should rarely happen
      for(; (PAGE_MAX &gt; 0) &amp;&amp; $i &lt; PAGE_MAX*PAGE_DEF; $i+=PAGE_DEF) {
      	$dat.=&quot;[&quot;.($i/PAGE_DEF).&quot;] &quot;;
      }
      
      $dat.=&quot;&lt;/td&gt;&quot;;

      if($p &gt;= PAGE_DEF &amp;&amp; $counttree &gt; $next){ // ok to make next button
        $dat.=&quot;&lt;form action=\&quot;&quot;.$next/PAGE_DEF.PHP_EXT.&quot;\&quot; onsubmit='location=this.action;return false' method=get&gt;&lt;td&gt;&quot;;
        $dat.=&quot;&lt;input type=submit value=\&quot;&quot;.S_NEXT.&quot;\&quot; accesskey=\&quot;x\&quot;&gt;&quot;;
        $dat.=&quot;&lt;/td&gt;&lt;/form&gt;&quot;;
      }else{$dat.=&quot;&lt;td&gt;&quot;.S_LASTPG.&quot;&lt;/td&gt;&quot;;}
        $dat.=&quot;&lt;/tr&gt;&lt;/table&gt;&lt;br clear=all&gt;\n&quot;;
    }
    foot($dat);
    //if($resno){echo $dat;break;}
    if($resno) {
    	logtime(&quot;Printing thread $resno page&quot;);
	    $logfilename=RES_DIR.$resno.PHP_EXT;
	    print_page($logfilename, $dat);
		$dat='';
      if(!$rebuild) $deferred = updatelog(0);
      break;
    }
    logtime(&quot;Printing index page&quot;);
    if($page==0){$logfilename=PHP_SELF2;}
    else{$logfilename=$page/PAGE_DEF.PHP_EXT;}
    print_page($logfilename, $dat);
    if(!$resno &amp;&amp; $page==0 &amp;&amp; USE_RSS==1) {
    	include_once '/www/global/rss.php';
    	rss_dump();
    }
    if(UPDATE_THROTTLING &gt;= 1) {
	  	clearstatcache();
  		if(@filemtime(&quot;updatelog.stamp&quot;) == $update_start)
  			unlink(&quot;updatelog.stamp&quot;);
    }
    //chmod($logfilename,0666);
  }
  //mysql_free_result($treeline);
  if(isset($deferred)) return $deferred;
  return false;
}

/* head */
function head(&amp;$dat,$res,$error=0){
	$titlepart = '';
	if(JANITOR_BOARD == 1) {
		$dat .= broomcloset_head($dat);
	}

  if (SHOWTITLEIMG == 1) {
  		//$titleimg = rid('title_banners');
	  $titleimg = rid_in_directory(&quot;/dontblockthis/title/&quot;);
	  $titlepart.= '&lt;img width=300 height=100 src=&quot;'.$titleimg.'&quot;&gt;';
	} else if (SHOWTITLEIMG == 2) {
	  $titlepart.= '&lt;img width=300 height=100 src=&quot;'.TITLEIMG.'&quot; onclick=&quot;this.src=this.src;&quot;&gt;';
	}
  $include1=file_get_contents_cached(NAV_TXT);
  $cookiejs=&quot;function get_cookie(name){with(document.cookie){var index=indexOf(name+\&quot;=\&quot;);if(index==-1) return '';index=indexOf(\&quot;=\&quot;,index)+1;var endstr=indexOf(\&quot;;\&quot;,index);if(endstr==-1) endstr=length;return decodeURIComponent(substring(index,endstr));}};\nfunction get_pass(name){var pass=get_cookie(name);if(pass) return pass;var chars=\&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\&quot;;var pass='';for(var i=0;i&lt;8;i++){var rnd=Math.floor(Math.random()*chars.length);pass+=chars.substring(rnd,rnd+1);}return(pass);}\n&quot;;
  $cookiejs .= 'function toggle(name){var a=document.getElementById(name); a.style.display = ((a.style.display!=&quot;block&quot;)?&quot;block&quot;:&quot;none&quot;);}';
  $scriptjs = '';
  // set styleswitcher script configuration variables
  if(DEFAULT_BURICHAN==1) {
  	$scriptjs .= '&lt;script type=&quot;text/javascript&quot;&gt;var style_group=&quot;ws_style&quot;;&lt;/script&gt;';
  } else {
  	$scriptjs .= '&lt;script type=&quot;text/javascript&quot;&gt;var style_group=&quot;nws_style&quot;;&lt;/script&gt;';
  }
	$scriptjs .='&lt;script type=&quot;text/javascript&quot; src=&quot;'.DATA_SERVER.'script.js&quot;&gt;&lt;/script&gt;';
  $dat.='&lt;html&gt;&lt;head&gt;
&lt;META HTTP-EQUIV=&quot;content-type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;
&lt;meta name=&quot;robots&quot; content=&quot;'.META_ROBOTS.'&quot;/&gt;
&lt;meta name=&quot;description&quot; content=&quot;'.META_DESCRIPTION.'&quot;/&gt;
&lt;meta name=&quot;keywords&quot; content=&quot;'.META_KEYWORDS.'&quot;/&gt;';
	if (RTA==1) {
		$dat .= &quot;\n&lt;meta name=\&quot;RATING\&quot; content=\&quot;RTA-5042-1996-1400-1577-RTA\&quot; /&gt;&quot;;
	}
$styles = array( 
	'Yotsuba' =&gt; 'yotsuba.8.css', 
	'Yotsuba B' =&gt; 'yotsublue.8.css', 
	'Futaba' =&gt; 'futaba.8.css',
	'Burichan' =&gt; 'burichan.8.css',
);
	if (DEFAULT_BURICHAN==1) {
		foreach($styles as $style=&gt;$stylecss) {
			$rel = ( ($style == 'Yotsuba B') ? 'stylesheet' : 'alternate stylesheet' );
			$dat .= &quot;&lt;link rel=\&quot;$rel\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot;.DATA_SERVER.&quot;$stylecss\&quot; title=\&quot;$style\&quot;&gt;&quot;;
		}
	} else {
		if(defined('CSS_FORCE')) { 
			foreach($styles as $style=&gt;$stylecss) {
				$rel = ( ($style == 'Yotsuba') ? 'stylesheet' : 'alternate stylesheet' );
				$dat .= &quot;&lt;link rel=\&quot;$rel\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot;.CSS_FORCE.&quot;\&quot; title=\&quot;$style\&quot;&gt;&quot;;
			}
		}
		else {
			foreach($styles as $style=&gt;$stylecss) {
				$rel = ( ($style == 'Yotsuba') ? 'stylesheet' : 'alternate stylesheet' );
				$dat .= &quot;&lt;link rel=\&quot;$rel\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot;.DATA_SERVER.&quot;$stylecss\&quot; title=\&quot;$style\&quot;&gt;&quot;;
			}
		}
	}

if(USE_RSS==1)
	$dat .= '&lt;link rel=&quot;alternate&quot; title=&quot;RSS feed&quot; href=&quot;/'.BOARD_DIR.'/index.rss&quot; type=&quot;application/rss+xml&quot; /&gt;';
$dat.='&lt;title&gt;'.strip_tags(TITLE).'&lt;/title&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
'.$cookiejs.'
//--&gt;&lt;/script&gt;
'.$scriptjs;

if (FIXED_TEXT_AD == 1 &amp;&amp; file_exists(FIXED_TEXT_PATH)) {
	$dat.=&quot;&lt;style&gt;.postarea { padding-left:400px; }&lt;/style&gt;&quot;;
}

$dat .= '&lt;/head&gt;
&lt;body bgcolor=&quot;#FFFFEE&quot; text=&quot;#800000&quot; link=&quot;#0000EE&quot; vlink=&quot;#0000EE&quot;&gt;'.$include1;

$dat.='&lt;div class=&quot;logo&quot;&gt;
'.$titlepart.'&lt;br&gt;
&lt;font size=5&gt;
&lt;b&gt;&lt;SPAN&gt;'.TITLE.'&lt;/SPAN&gt;&lt;/b&gt;&lt;/font&gt;';
if(defined('SUBTITLE'))
	$dat .= '&lt;br&gt;&lt;font size=1&gt;'.SUBTITLE.'&lt;/font&gt;';
$dat.='&lt;/div&gt;
&lt;hr width=&quot;90%&quot; size=1&gt;
';
if(LEADERBOARD_AD == 1) {
		if(defined('LEADERBOARD_TXT') &amp;&amp; LEADERBOARD_TXT) {
			$dat.='&lt;div style=&quot;text-align: center&quot;&gt;' .
				ad_text_for(LEADERBOARD_TXT) .
			'&lt;/div&gt;&lt;hr&gt;';
		}
		else if(defined('LEADERBOARD_TABLE')) {
			list($ldimg,$ldhref) = rid(LEADERBOARD_TABLE,1);
			$dat.='&lt;div style=&quot;text-align: center&quot;&gt;&lt;a href=&quot;'.$ldhref.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'.$ldimg.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;hr&gt;';
		}
		else
			$dat.='&lt;div style=&quot;text-align: center&quot;&gt;&lt;a href=&quot;'.LEADERBOARD_LINK.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/'.LEADERBOARD_IMG.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;hr&gt;';
}
}

/* Contribution form */
function form(&amp;$dat,$resno,$admin=&quot;&quot;){
  global $log; log_cache();
  $maxbyte = MAX_KB * 1024;
  $no=$resno;
  $closed=0;
  $msg='';
  $hidden='';
  if($resno){
    $closed = $log[$resno]['closed'];

    $msg.=&quot;[&lt;a href=\&quot;../&quot;.PHP_SELF2.&quot;\&quot; accesskey=\&quot;a\&quot;&gt;&quot;.S_RETURN.&quot;&lt;/a&gt;]\n&quot;;
    $msg.=&quot;&lt;table width='100%'&gt;&lt;tr&gt;&lt;th bgcolor=#e04000&gt;\n&quot;;
    $msg.=&quot;&lt;font color=#FFFFFF&gt;&quot;.S_POSTING.&quot;&lt;/font&gt;\n&quot;;
    $msg.=&quot;&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;
  }
  if($admin){
    $hidden = &quot;&lt;input type=hidden name=admin value=\&quot;&quot;.ADMIN_PASS.&quot;\&quot;&gt;&quot;;
    $msg = &quot;&lt;h4&gt;&quot;.S_NOTAGS.&quot;&lt;/h4&gt;&quot;;
  }
if($closed!=1) {
  $dat.=$msg;
  //form_ads($dat);
if(OEKAKI_BOARD == 1) { 
	require_once 'oekaki.php'; 
	if($_GET['mode'] != 'oe_finish') 
		oe_form($dat,$resno);
	else
		oe_preview($dat);		
}
  $dat.='&lt;div align=&quot;center&quot; class=&quot;postarea&quot;&gt;&lt;form name=&quot;post&quot; action=&quot;';
	$dat.=PHP_SELF_ABS.'&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;
'.$hidden.'&lt;input type=hidden name=&quot;MAX_FILE_SIZE&quot; value=&quot;'.$maxbyte.'&quot;&gt;
';
if($no){$dat.='&lt;input type=hidden name=resto value=&quot;'.$no.'&quot;&gt;
';}
	if((FIXED_TEXT_AD == 1) &amp;&amp; $fixedad = ad_text_for(FIXED_TEXT_PATH)) {
	$dat.='&lt;div id=&quot;ad&quot;&gt;'.$fixedad.'&lt;/div&gt;';
	}
if(FORCED_ANON == 1) {
	$dat.='&lt;table cellpadding=1 cellspacing=1&gt;&lt;tr colspan=2&gt;&lt;td&gt;&lt;input type=hidden name=name&gt;&lt;input type=hidden name=sub&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;'
	.'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_EMAIL.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=email size=&quot;28&quot;&gt;&lt;span id=&quot;tdname&quot;&gt;&lt;/span&gt;&lt;span id=&quot;tdemail&quot;&gt;&lt;/span&gt;';
} else {
$dat.='&lt;table cellpadding=1 cellspacing=1&gt;
&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_NAME.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=name size=&quot;28&quot;&gt;&lt;span id=&quot;tdname&quot;&gt;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_EMAIL.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=email size=&quot;28&quot;&gt;&lt;span id=&quot;tdemail&quot;&gt;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_SUBJECT.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=sub size=&quot;35&quot;&gt;';
}
if($admin){
$dat.='&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;Reply ID&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=text name=resto size=&quot;10&quot;&gt; [&lt;label&gt;&lt;input type=checkbox name=age value=1&gt;Age&lt;/label&gt;] ';
}
$dat.='&lt;input type=submit value=&quot;'.S_SUBMIT.'&quot; accesskey=&quot;s&quot;&gt;';
if (SPOILERS==1) {
  $dat.=' [&lt;label&gt;&lt;input type=checkbox name=spoiler value=on&gt;'.S_SPOILERS.'&lt;/label&gt;]';
};
$dat.='&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign=bottom&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_COMMENT.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;textarea class=inputtext name=com cols=&quot;48&quot; rows=&quot;4&quot; wrap=soft&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;
';
if(OEKAKI_BOARD == 1 &amp;&amp; $_GET['mode'] == 'oe_finish') { require_once 'oekaki.php'; oe_finish_form($dat); }
elseif (MAX_IMGRES!=0) {
	$dat.='&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_UPLOADFILE.'&lt;/b&gt;&lt;/td&gt;
	&lt;td&gt;&lt;input type=file name=upfile size=&quot;35&quot;&gt;';
	if (!$resno&amp;&amp;NO_TEXTONLY!=1) {
	$dat.='[&lt;label&gt;&lt;input type=checkbox name=textonly value=on&gt;'.S_NOFILE.'&lt;/label&gt;]';
	}
	$dat.='&lt;/td&gt;&lt;/tr&gt;';
}
$dat.='&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;postblock&quot; align=&quot;left&quot;&gt;&lt;b&gt;'.S_DELPASS.'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input class=inputtext type=password name=&quot;pwd&quot; size=8 maxlength=8 value=&quot;&quot;&gt;&lt;small&gt;'.S_DELEXPL.'&lt;/small&gt;&lt;input type=hidden name=mode value=&quot;regist&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan=2&gt;
&lt;table border=0 cellpadding=0 cellspacing=0 width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td class=&quot;rules&quot;&gt;'.S_RULES;
if(!$resno &amp;&amp; SHOW_UNIQUES == 1) {
  $dat.='&lt;LI&gt;Currently &lt;b&gt;'.$GLOBALS['ipcount'].'&lt;/b&gt; unique user posts.';
}
$dat.='&lt;/td&gt;&lt;td align=&quot;right&quot; valign=&quot;center&quot;&gt;'.DONATE.'&lt;/td&gt;&lt;/tr&gt;';
if(FORCED_ANON==1) { // extra spacer to make up for the 2 missing table rows
	$dat .='&lt;tr&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;';
}
if(SHOW_BLOTTER == 1) {
list($blotdate,$blotcontents) = blotter_contents();
$dat.='&lt;tr&gt;&lt;td class=&quot;rules&quot;&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
function updateBlotterVisible() {
	if(get_cookie(&quot;blotter_hide&quot;) == &quot;show&quot;) {
		document.getElementById(&quot;blotter&quot;).style.display = \'inline\';
	} else {
		document.getElementById(&quot;blotter&quot;).style.display = \'none\';
	}
}

function toggleBlotter() {
	if(get_cookie(&quot;blotter_hide&quot;) == &quot;show&quot;) {
		document.cookie = &quot;blotter_hide=hide; expires=Thu, 4 Feb 2044 04:04:04 UTC; domain=4chan.org; path=/&quot;;
	} else {
		document.cookie = &quot;blotter_hide=show; expires=Thu, 4 Feb 2044 04:04:04 UTC; domain=4chan.org; path=/&quot;;
	}
	updateBlotterVisible();
}
document.write(\'&lt;div style=&quot;position:relative;&quot;&gt;&lt;div style=&quot;top:0px;left:0px;position:absolute;&quot; class=&quot;rules&quot;&gt;'.$blotdate.'&lt;/div&gt;&lt;div style=&quot;top:0px;right:0px;position:absolute;&quot;&gt;&lt;a href=&quot;javascript:void(0)&quot; onclick=&quot;toggleBlotter()&quot;&gt;Show/Hide&lt;/a&gt; &lt;a href=&quot;'.BLOTTER_URL.'?all&quot;&gt;Show All&lt;/a&gt;&lt;/div&gt;&lt;div id=&quot;blotter&quot; style=&quot;display:none&quot; class=&quot;rules&quot;&gt;&lt;br/&gt;\');
	document.write(' . $blotcontents . ');
document.write(\'&lt;/div&gt;&lt;/div&gt;\');
updateBlotterVisible();
--&gt;
&lt;/script&gt;
&lt;/td&gt;&lt;/tr&gt;';
}
$dat.='&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;&lt;/div&gt;&lt;hr&gt;
&lt;script&gt;with(document.post) {name.value=get_cookie(&quot;4chan_name&quot;); email.value=get_cookie(&quot;4chan_email&quot;); pwd.value=get_pass(&quot;4chan_pass&quot;); }&lt;/script&gt;
';
} else { // closed thread
	$dat.=&quot;[&lt;a href=\&quot;../&quot;.PHP_SELF2.&quot;\&quot; accesskey=\&quot;a\&quot;&gt;&quot;.S_RETURN.&quot;&lt;/a&gt;]&lt;hr&gt;\n&quot;;
	form_ads($dat);
	$dat.='&lt;table style=&quot;text-align:center;width:100%;height:300px;&quot;&gt;&lt;tr valign=&quot;middle&quot;&gt;&lt;td align=&quot;center&quot;&gt;&lt;font color=red size=5 style=&quot;&quot;&gt;&lt;b&gt;Thread closed.&lt;br/&gt;You may not reply at this time.&lt;/b&gt;&lt;/font&gt;&lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;';
}
	if (BANROT_AD==1) {
	    /*if(!$banadquery=mysql_global_call(&quot;select url,img from &quot;.BANROTLOG.&quot; order by rand() limit 1&quot;)){echo S_SQLFAIL;}
	    $banadrow=mysql_fetch_row($banadquery);
	    list($ba_url,$ba_img)=$banadrow;*/
	    $dat.='&lt;center&gt;';
		if(defined('TOPAD_TABLE')) {
			list($topad, $toplink) = rid(TOPAD_TABLE, 1);
			$dat .= &quot;&lt;a href=\&quot;$toplink\&quot; target=\&quot;_blank\&quot;&gt;&lt;img style=\&quot;border:1px solid black;\&quot; src=\&quot;$topad\&quot; width=468 height=60 border=0 /&gt;&lt;/a&gt;&quot;;
		}
		else {
			$dat .= rotating_ad_banner();
		}
	    /*
	    $dat.='&lt;a href=&quot;http://webhosting.cologuys.com&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/CG_100x60_2.gif&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';
	    if ($ba_url != &quot;&quot;) {
		    $dat.='&lt;a href=&quot;'.BANROT_PHP.'?url='.$ba_url.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';
	    } else {
		    $dat.='&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;';
	    }*/

	}
	
	if(BANROT2_AD==1) {
	/*	$dat .= @file_get_contents('/www/global/topad.txt');
	    $dat.='&lt;a href=&quot;http://webhosting.cologuys.com&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://content.4chan.org/dontblockthis/CG_100x60_2.gif&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';
	    $dat.=&quot;&lt;/center&gt;&lt;hr&gt;\n&quot;;*/
	}
	elseif (BANROT_B==1) {
		/*if(!$banadquery=mysql_global_call(&quot;select url,img from &quot;.BANROT_B_LOG.&quot; where DATE_SUB(CURDATE(),INTERVAL 30 DAY) &lt;= installed) ORDER BY RAND() limit 1&quot;)){echo S_SQLFAIL;}
		$banadrow=mysql_fetch_row($banadquery);
		list($ba_url,$ba_img)=$banadrow;
		$dat.='&lt;br/&gt;';
		if ($ba_url != &quot;&quot;) {
			$dat.='&lt;a href=&quot;'.$ba_url.'&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;&lt;/a&gt;';
		} else {
			$dat.='&lt;img src=&quot;'.$ba_img.'&quot; border=&quot;0&quot;&gt;';
		}
	  $dat.=&quot;&lt;br&gt;&lt;a href=\&quot;http://www.4chan.org/advertise/\&quot; target=\&quot;_blank\&quot;&gt;&lt;small&gt;Buy a banner for this board!&lt;/small&gt;&lt;/a&gt;&lt;/center&gt;&lt;hr&gt;\n&quot;;*/
	} 
	elseif(NOT4CHAN!=1 &amp;&amp; BANROT_AD==1 || BANROT2_AD==1) {
  	//$dat.=&quot;&lt;br&gt;&lt;a href=\&quot;http://www.4chan.org/advertise/\&quot; target=\&quot;_blank\&quot;&gt;&lt;small&gt;Advertise with 4chan!&lt;/small&gt;&lt;/a&gt;&lt;/center&gt;&lt;hr&gt;\n&quot;;
  	$dat.=&quot;&lt;/center&gt;&lt;hr&gt;\n&quot;;
  }
  
  if (defined('GLOBAL_MSG') &amp;&amp; GLOBAL_MSG!='') {
	  $dat.=GLOBAL_MSG.&quot;\n&lt;hr&gt;\n&quot;;
  }
  
  if(JANITOR_BOARD == 1) {
  	$dat = broomcloset_form($dat);
  }
}

function delete_uploaded_files()
{
	global $upfile_name,$path,$upfile,$dest;
 	if($dest||$upfile) {
	  @unlink($dest);
	  @unlink($upfile);
	  if(OEKAKI_BOARD == 1) { @unlink(&quot;$dest.pch&quot;); }
	}
}

/* Footer */
function foot(&amp;$dat){
 global $update_avg_secs;
 $include2=file_get_contents_cached(NAV2_TXT);
/* $dat.='&lt;div class=&quot;footer&quot;&gt;'.S_FOOT.'&lt;/div&gt;
'.$include2.'
&lt;/body&gt;&lt;/html&gt;';*/
  $dat .=&quot;$include2&quot;;
  if ($update_avg_secs) $dat .= &quot;&lt;!-- $update_avg_secs s --&gt;&quot;;
  $dat .= &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
}
function error($mes,$unused=''){
  delete_uploaded_files();
  head($dat,0,1);
  form_ads($dat);
 
  //echo &quot;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&lt;br&gt;&lt;br&gt;\n&lt;center&gt;&lt;font color=red size=5&gt;&lt;b&gt;$mes&lt;br&gt;&lt;br&gt;&lt;a href=&quot;;
  $dat .= '&lt;table style=&quot;text-align:center;width:100%;height:300px;&quot;&gt;&lt;tr valign=&quot;middle&quot;&gt;&lt;td align=&quot;center&quot;&gt;&lt;font color=red size=5 style=&quot;&quot;&gt;&lt;b&gt;' . $mes . '&lt;br&gt;&lt;br&gt;&lt;a href=';
  if(strpos($_SERVER['REQUEST_URI'],RES_DIR)) $dat .= &quot;../&quot;;
  //echo PHP_SELF2.&quot;&gt;&quot;.S_RELOAD.&quot;&lt;/a&gt;&lt;/b&gt;&lt;/font&gt;&lt;/center&gt;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&quot;;
  $dat .=  PHP_SELF2.&quot;&gt;&quot;.S_RELOAD.&quot;&lt;/a&gt;&lt;/b&gt;&lt;/font&gt;&lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;&lt;br&gt;&lt;br&gt;&lt;hr size=1&gt;&quot;;
  if(BANROT_AD == 1 &amp;&amp; !defined('TOPAD_TABLE')) {
  	    $dat.='&lt;center&gt;';
		$dat .= rotating_ad_banner();
		if(BOTTOM_AD == 1) {
			$dat .= &quot;&lt;hr size=1&gt;&quot;;
		}
  }
 if(BOTTOM_AD == 1) {
	$bottomad = ad_text_for(BOTTOMAD);
	if($bottomad)
		$dat .= &quot;$bottomad&lt;hr&gt;&quot;;
  }
  $dat .= &quot;&lt;/center&gt;&quot;;
  foot($dat);
  die($dat);
}

/* Auto Linker */
function normalize_link_cb($m) {
	$subdomain = $m[1];
	$original = $m[0];
	$board = strtolower($m[2]);
	$m[0] = $m[1] = $m[2] = '';
	for($i=count($m)-1;$i&gt;2;$i--) {
		if($m[$i]) { $no = $m[$i]; break; }
	}
	if($subdomain == 'www' || $subdomain == 'static' || $subdomain == 'content')
		return $original;
	if($board == BOARD_DIR)
		return &quot;&amp;gt;&amp;gt;$no&quot;;
	else
		return &quot;&amp;gt;&amp;gt;&amp;gt;/$board/$no&quot;;
}
function normalize_links($proto) {
	// change http://xxx.4chan.org/board/res/no links into plaintext &gt;&gt;# or &gt;&gt;&gt;/board/#
	if(strpos($proto,&quot;4chan.org&quot;)===FALSE) return $proto;
	
	$proto = preg_replace_callback('@http://([A-za-z]*)[.]4chan[.]org/(\w+)/(?:res/(\d+)[.]html(?:#q?(\d+))?|\w+.php[?]res=(\d+)(?:#(\d+))?|)(?=[\s.&lt;!?,]|$)@i','normalize_link_cb',$proto);
	// rs.4chan.org to &gt;&gt;&gt;rs/query+string
	$proto = preg_replace('@http://rs[.]4chan[.]org/\?s=([a-zA-Z0-9$_.+-]+)@i','&amp;gt;&amp;gt;&amp;gt;/rs/$1',$proto);
	return $proto;
}

function intraboard_link_cb($m) {
	global $intraboard_cb_resno, $log;
	$no = $m[1];
	$resno = $intraboard_cb_resno;
	if(isset($log[$no])) {
		$resto = $log[$no]['resto'];
		$resdir = ($resno ? '' : RES_DIR);
		$ext = PHP_EXT;
		if($resno &amp;&amp; $resno==$resto) // linking to a reply in the same thread
			return &quot;&lt;a href=\&quot;#$no\&quot; class=\&quot;quotelink\&quot; onClick=\&quot;replyhl('$no');\&quot;&gt;&amp;gt;&amp;gt;$no&lt;/a&gt;&quot;;
		elseif($resto==0) // linking to a thread
			return &quot;&lt;a href=\&quot;$resdir$no$ext#$no\&quot; class=\&quot;quotelink\&quot;&gt;&amp;gt;&amp;gt;$no&lt;/a&gt;&quot;;
		else // linking to a reply in another thread
			return &quot;&lt;a href=\&quot;$resdir$resto$ext#$no\&quot; class=\&quot;quotelink\&quot;&gt;&amp;gt;&amp;gt;$no&lt;/a&gt;&quot;;
	}
	return $m[0];
}
function intraboard_links($proto, $resno) {
	global $intraboard_cb_resno;

	$intraboard_cb_resno = $resno;

	$proto = preg_replace_callback('/&amp;gt;&amp;gt;([0-9]+)/', 'intraboard_link_cb', $proto);
	return $proto;
}

function interboard_link_cb($m) {
	// on one hand, we can link to imgboard.php, using any old subdomain, 
	// and let apache &amp; imgboard.php handle it when they click on the link
	// on the other hand, we can use the database to fetch the proper subdomain
	// and even the resto to construct a proper link to the html file (and whether it exists or not)
	
	// for now, we'll assume there's more interboard links posted than interboard links visited.
	$url = DATA_SERVER . $m[1] . '/' . PHP_SELF . ($m[2] ? ('?res=' . $m[2]) : &quot;&quot;);
	return &quot;&lt;a href=\&quot;$url\&quot; class=\&quot;quotelink\&quot;&gt;{$m[0]}&lt;/a&gt;&quot;;	
}
function interboard_rs_link_cb($m) {
	// $m[1] might be a url-encoded query string, or might be manual-typed text
	// so we'll normalize it to raw text first and then re-encode it
	$lsearchquery = urlencode( urldecode($m[1]) );
	return &quot;&lt;a href=\&quot;http://rs.4chan.org/?s=$lsearchquery\&quot; class=\&quot;quotelink\&quot;&gt;{$m[0]}&lt;/a&gt;&quot;;
}

function interboard_dis_link_cb($m) {
	$durl = $m[1]; //i don't think this is useful but just in case
	return &quot;&lt;a href=\&quot;http://dis.4chan.org/read/$durl\&quot; class=\&quot;quotelink\&quot;&gt;{$m[0]}&lt;/a&gt;&quot;;
}

function dis_matching_re() {
	global $dis_matching_re;
	
	if (!$dis_matching_re) {
		$boards = file('/www/global/disboards.txt');
		foreach ($boards as $board) {
			list($bn,) = explode(&quot;&lt;&gt;&quot;, $board);
			$dis_matching_re .= $bn;
			$dis_matching_re .= '|';
		}
		
		$dis_matching_re = substr($dis_matching_re, 0, -1); //lose last |
	}
	
	return $dis_matching_re;
}

function interboard_links($proto) {
	$boards = &quot;an?|cm?|fa|fit|gif|h[cr]?|[bdefgkmnoprstuvxy]|wg?|ic?|y|cgl|c[ko]|mu|po|t[gv]|toy|trv|jp|r9k|sp&quot;;
	$disboards = dis_matching_re();
	$proto = preg_replace_callback('@&amp;gt;&amp;gt;&amp;gt;/('.$boards.')/([0-9]*)@i', 'interboard_link_cb', $proto);
	$proto = preg_replace_callback('@&amp;gt;&amp;gt;&amp;gt;/rs/([^\s&lt;&gt;]+)@', 'interboard_rs_link_cb', $proto);
	$proto = preg_replace_callback('@&amp;gt;&amp;gt;&amp;gt;/(('.$disboards.')/[^\s&lt;&gt;]*)@i', 'interboard_dis_link_cb', $proto);
	return $proto;
}

function auto_link($proto,$resno){
	$proto = normalize_links($proto);
		
	// auto-link remaining 4chan.org URLs if they're not part of HTML
	if(strpos($proto,&quot;4chan.org&quot;)!==FALSE) {
		$proto = preg_replace('/(http:\/\/(?:[A-Za-z]*\.)?)(4chan)(\.org)(\/)([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?/i',&quot;&lt;a href=\&quot;\\0\&quot; target=\&quot;_blank\&quot;&gt;\\0&lt;/a&gt;&quot;,$proto);
		$proto = preg_replace('/([&lt;][^&gt;]*?)&lt;a href=&quot;((http:\/\/(?:[A-Za-z]*\.)?)(4chan)(\.org)(\/)([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?)&quot; target=&quot;_blank&quot;&gt;\\2&lt;\/a&gt;([^&lt;]*?[&gt;])/i', '\\1\\3\\4\\5\\6\\7\\8', $proto);
	}
	
	$proto = intraboard_links($proto,$resno);
	$proto = interboard_links($proto);
 	return $proto;
}

function auto_ban_poster($nametrip, $banlength, $global, $reason, $pubreason='') {
	if(!$nametrip) $nametrip = S_ANONAME;
	if(strpos($nametrip, '&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!') !== FALSE) {
		$nameparts=explode('&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!',$name);
		$nametrip = &quot;{$nameparts[0]} #{$nameparts[1]}&quot;;
	}
	$host = $_SERVER['REMOTE_ADDR'];
	$reverse = mysql_real_escape_string(gethostbyaddr($host));
	$xff = mysql_real_escape_string(getenv(&quot;HTTP_X_FORWARDED_FOR&quot;));
	
	$nametrip = mysql_real_escape_string($nametrip);
	$global = ($global?1:0);
	$board = BOARD_DIR;
	$reason = mysql_real_escape_string($reason);
	$pubreason = mysql_real_escape_string($pubreason);
	if($pubreason) {
		$pubreason .= &quot;&lt;&gt;&quot;;
	}

	//if they're already banned on this board, don't insert again
	//since this is just a spam post
	//i don't think it matters if the active ban is global=0 and this one is global=1
	{
		$existingq = mysql_global_do(&quot;select count(*)&gt;0 from &quot;.SQLLOGBAN.&quot; where host='$host' and active=1 and (board='$board' or global=1)&quot;);
		$existingban = mysql_result($existingq, 0, 0);
		if ($existingban &gt; 0) {
			delete_uploaded_files();
			die();
		}
	}

	if($banlength == 0) { // warning
		// check for recent warnings to punish spammers
		$autowarnq=mysql_global_call(&quot;SELECT COUNT(*) FROM &quot;.SQLLOGBAN.&quot; WHERE host='$host' AND admin='Auto-ban' AND now &gt; DATE_SUB(NOW(),INTERVAL 3 DAY) AND reason like '%$reason'&quot;);
		$autowarncount=mysql_result($autowarnq,0,0);
		if($autowarncount &gt; 3) {
			$banlength = 14;
		}
	}
	
	
	if($banlength == -1) // permanent
		$length = '0000' . '00' .'00'; // YYYY/MM/DD
	else {
		$banlength = (int)$banlength;
		if($banlength &lt; 0) $banlength = 0;
		$length = date(&quot;Ymd&quot;,time()+$banlength*(24*60*60));
	}
	$length .= &quot;00&quot;.&quot;00&quot;.&quot;00&quot;; // H:M:S
	
	if(!$result=mysql_global_do(&quot;INSERT INTO &quot;.SQLLOGBAN.&quot; (board,global,name,host,reason,length,admin,reverse,xff) VALUES('$board','$global','$nametrip','$host','$pubreason&lt;b&gt;Auto-ban&lt;/b&gt;: $reason','$length','Auto-ban','$reverse','$xff')&quot;)){echo S_SQLFAIL;}
	@mysql_free_result($result);
	append_ban($global ? &quot;global&quot; : $global, $host);
}

function check_blacklist($post, $dest) {
	$board = BOARD_DIR;
	$querystr = &quot;SELECT SQL_NO_CACHE * FROM blacklist WHERE active=1 AND (boardrestrict='' or boardrestrict='$board') AND (0 &quot;;
	foreach($post as $field=&gt;$contents) {
		if($contents) {
			$contents = mysql_real_escape_string(html_entity_decode($contents));
			$querystr .= &quot;OR (field='$field' AND contents='$contents') &quot;;
		}
	}
	$querystr .= &quot;) LIMIT 1&quot;;
	$query = mysql_global_call($querystr);
	if(mysql_num_rows($query) == 0) return false;
	$row = mysql_fetch_assoc($query);
	if($row['ban']) {
		$prvreason = &quot;Blacklisted ${row['field']} - &quot; . htmlspecialchars($row['contents']);
		auto_ban_poster($post['trip']?$post['nametrip']:$post['name'], $row['banlength'], 1, $prvreason, $row['banreason']);
	}
	error(S_UPFAIL, $dest);
}


// word-wrap without touching things inside of tags
function wordwrap2($str,$cols,$cut) {
	// if there's no runs of $cols non-space characters, wordwrap is a no-op
        if(strlen($str)&lt;$cols || !preg_match('/[^ &lt;&gt;]{'.$cols.'}/', $str)) {
                return $str;
        }
	$sections = preg_split('/[&lt;&gt;]/', $str);
	$str='';
	for($i=0;$i&lt;count($sections);$i++) {
		if($i%2) { // inside a tag
			$str .= '&lt;' . $sections[$i] . '&gt;';
		}
		else { // outside a tag
			$words = explode(' ',$sections[$i]);
			foreach($words as &amp;$word) {
				$word = wordwrap($word, $cols, $cut, 1);
				// fix utf-8 sequences (XXX: is this slower than mbstring?)
				$lines = explode($cut, $word);
				for($j=1;$j&lt;count($lines);$j++) { // all lines except the first
					while(1) {
						$chr = substr($lines[$j], 0, 1);
						if((ord($chr) &amp; 0xC0) == 0x80) { // if chr is a UTF-8 continuation...
							$lines[$j-1] .= $chr; // put it on the end of the previous line
							$lines[$j] = substr($lines[$j], 1); // take it off the current line
							continue;
						}
							break; // chr was a beginning utf-8 character
					}
				}
				$word = implode($cut, $lines);	
				
			}
			$str .= implode(' ', $words);
		}
	}
	return $str;
}

function cidrtest ($longip, $CIDR) {
	list ($net, $mask) = split (&quot;/&quot;, $CIDR);
	
	$ip_net = ip2long ($net);
	$ip_mask = ~((1 &lt;&lt; (32 - $mask)) - 1);
	
	$ip_ip = $longip;
	
	$ip_ip_net = $ip_ip &amp; $ip_mask;
	
	return ($ip_ip_net == $ip_net);
}

function  proxy_connect($port) {
  $fp = @fsockopen ($_SERVER[&quot;REMOTE_ADDR&quot;], $port,$a,$b,2);
  if(!$fp){return 0;}else{return 1;}
}

function processlist_cleanup($id) {
	logtime('Done');
	//mysql_board_call(&quot;DELETE FROM proclist WHERE id='$id'&quot;);
}

function logtime($desc) {
	static $run = -1;
	if(!defined('PROFILING') &amp;&amp; !defined('PROCESSLIST')) return;
	if($run==-1) {
		$run = getmypid(); // rand(0,16777215);
		if(PROCESSLIST == 1) {
			register_shutdown_function('processlist_cleanup', $run);
			$dump = mysql_real_escape_string(serialize(array('GET'=&gt;$_GET,'POST'=&gt;$_POST,'SERVER'=&gt;$_SERVER)));
			mysql_board_call(&quot;INSERT INTO proclist VALUES ('$run','$dump','')&quot;);
		}
	}
	if(PROCESSLIST == 1) {
		mysql_board_call(&quot;UPDATE proclist SET descr='$desc' WHERE id='$run'&quot;);
	}
	else {
		$board = BOARD_DIR;
		$time = microtime(true);
		mysql_global_call(&quot;INSERT INTO prof_times VALUES ('$board',$run,$time,'$desc')&quot;);
	}
}

function make_american($com) {
	if (stripos($com, &quot;america&quot;)!==FALSE) return $com; //already american
	
	$com = rtrim($com);
	$end = '!';
	
	if ($com == &quot;&quot;) return $com;

	if (preg_match(&quot;/([.!?])$/&quot;, $com, $matches)) {$end = $matches[1]; $com = substr($com, 0, -1);}
	
	$com .= &quot; IN AMERICA&quot;.$end;
	
	return $com;
}

/* Regist */
function regist($name,$email,$sub,$com,$url,$pwd,$upfile,$upfile_name,$resto,$age){
  global $path,$pwdc,$textonly,$admin,$spoiler,$dest;
  if ($pwd==ADMIN_PASS) $admin=$pwd;
  if ($admin!=ADMIN_PASS || !valid() ) $admin='';
  $mes=&quot;&quot;;

  if(!$upfile &amp;&amp; !$resto) { // allow textonly threads for moderators!
	if(valid('textonly'))
	  	$textonly = 1;
  }
  elseif(JANITOR_BOARD == 1) { // only allow mods/janitors to post, and textonly is always ok
  	$textonly = 1;
	if(!valid('janitor_board'))
		die();
  }


  // time
  $time = time();
  $tim = $time.substr(microtime(),2,3);

 /* logtime(&quot;locking tables: &quot;.($resto?'reply':'thread').&quot;, &quot;.($upfile?'image':'text'));
  if(PROCESSLIST == 1 &amp;&amp; BOARD_DIR != 'b' &amp;&amp; 0) {
  	if(!mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE,proclist WRITE&quot;))
  		die(S_SQLCONF.'&lt;!--lk:'.mysql_errno().'--&gt;');
  }
  else if(BOARD_DIR != 'b' &amp;&amp; 0) {
  if(!mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE&quot;))
	die(S_SQLCONF.'&lt;!--lk:'.mysql_errno().'--&gt;');
}
  logtime(&quot;got lock&quot;);*/
  $locked_time = time();
  mysql_board_call(&quot;set session query_cache_type=0&quot;);
  // check closed
  $resto=(int)$resto;
  if ($resto) {
    if(!$cchk=mysql_board_call(&quot;select closed from &quot;.SQLLOG.&quot; where no=&quot;.$resto)){echo S_SQLFAIL;}
    list($closed)=mysql_fetch_row($cchk);
		if ($closed==1&amp;&amp;!$admin) error(&quot;You can't reply to this thread anymore.&quot;,$upfile);
    mysql_free_result($cchk);
  }

	if(OEKAKI_BOARD == 1 &amp;&amp; $_POST['oe_chk']) {
		require_once 'oekaki.php';
		oe_regist_check();
		$upfile = realpath('tmp/' . $_POST['oe_ip'] . '.png');
		$upfile_name = 'Oekaki';
		$pchfile = realpath('tmp/' . $_POST['oe_ip'] . '.pch');
		if(!file_exists($pchfile)) $pchfile = '';
	}
	
	$has_image = $upfile&amp;&amp;file_exists($upfile);
	
  if($has_image){
   // check image limit
  	if ($resto) {
	    if(!$result=mysql_board_call(&quot;select COUNT(*) from &quot;.SQLLOG.&quot; where resto=$resto and fsize!=0&quot;)){echo S_SQLFAIL;}
	    $countimgres=mysql_result($result,0,0);
      if ($countimgres&gt;MAX_IMGRES) error(&quot;Max limit of &quot;.MAX_IMGRES.&quot; image replies has been reached.&quot;,$upfile);
	    mysql_free_result($result);
		}

  //upload processing
  	$dest = tempnam(substr($path,0,-1), &quot;img&quot;);
  	//$dest = $path.$tim.'.tmp';
  	if(OEKAKI_BOARD == 1 &amp;&amp; $_POST['oe_chk']) {
  		rename($upfile, $dest);
  		chmod($dest, 0644);
  		if($pchfile)
  			rename($pchfile, &quot;$dest.pch&quot;);
  	}
  	else
	  	move_uploaded_file($upfile, $dest);  
	
 	clearstatcache(); // otherwise $dest looks like 0 bytes!
 	logtime(&quot;Moved uploaded file&quot;);
 	
    $upfile_name = CleanStr($upfile_name);
	$fsize=filesize($dest);
    if(!is_file($dest)) error(S_UPFAIL,$dest);
    if(!$fsize || $fsize&gt;MAX_KB * 1024) error(S_TOOBIG,$dest);

    // PDF processing
    if(ENABLE_PDF==1 &amp;&amp; strcasecmp('.pdf',substr($upfile_name,-4))==0) {
    	$ext='.pdf';
    	$W=$H=1;    	
    	$md5 = md5_of_file($dest);
    	// run through ghostscript to check for validity
    	if(pclose(popen(&quot;/usr/local/bin/gs -q -dSAFER -dNOPAUSE -dBATCH -sDEVICE=nullpage $dest&quot;,'w'))) { error(S_UPFAIL,$dest); }
    } else {
    $size = getimagesize($dest);
    if(!is_array($size)) error(S_NOREC,$dest);
    $md5 = md5_of_file($dest);

    //chmod($dest,0666);
    $W = $size[0];
    $H = $size[1];
    switch ($size[2]) {
      case 1 : $ext=&quot;.gif&quot;;break;
      case 2 : $ext=&quot;.jpg&quot;;break;
      case 3 : $ext=&quot;.png&quot;;break;
      case 4 : $ext=&quot;.swf&quot;;error(S_UPFAIL,$dest);break;
      case 5 : $ext=&quot;.psd&quot;;error(S_UPFAIL,$dest);break;
      case 6 : $ext=&quot;.bmp&quot;;error(S_UPFAIL,$dest);break;
      case 7 : $ext=&quot;.tiff&quot;;error(S_UPFAIL,$dest);break;
      case 8 : $ext=&quot;.tiff&quot;;error(S_UPFAIL,$dest);break;
      case 9 : $ext=&quot;.jpc&quot;;error(S_UPFAIL,$dest);break;
      case 10 : $ext=&quot;.jp2&quot;;error(S_UPFAIL,$dest);break;
      case 11 : $ext=&quot;.jpx&quot;;error(S_UPFAIL,$dest);break;
      case 13 : $ext=&quot;.swf&quot;;error(S_UPFAIL,$dest);break;
      default : $ext=&quot;.xxx&quot;;error(S_UPFAIL,$dest);break;
    }
    if(GIF_ONLY == 1 &amp;&amp; $size[2] != 1) error(S_UPFAIL,$dest);
	} // end PDF processing -else
		$insfile=substr($upfile_name, 0, -strlen($ext));
		
	spam_filter_post_image($name, $dest, $md5, $upfile_name, $ext);

    // Picture reduction
    if (!$resto) {
	    $maxw = MAX_W;
	    $maxh = MAX_H;
    } else {
	    $maxw = MAXR_W;
	    $maxh = MAXR_H;
		}
	if (defined('MIN_W') &amp;&amp; MIN_W &gt; $W) error(S_UPFAIL,$dest);
	if (defined('MIN_H') &amp;&amp; MIN_H &gt; $H) error(S_UPFAIL,$dest);
	if(defined('MAX_DIMENSION'))
		$maxdimension = MAX_DIMENSION;
	else
		$maxdimension = 5000;
    if ($W &gt; $maxdimension || $H &gt; $maxdimension) {
	    error(S_TOOBIGRES,$dest);
    } elseif($W &gt; $maxw || $H &gt; $maxh){
      $W2 = $maxw / $W;
      $H2 = $maxh / $H;
      ($W2 &lt; $H2) ? $key = $W2 : $key = $H2;
      $TN_W = ceil($W * $key);
      $TN_H = ceil($H * $key);
    }
    $mes = $upfile_name . ' ' . S_UPGOOD;
  }

if(OEKAKI_BOARD == 1 &amp;&amp; $_POST['oe_chk']) {
}
else {
  if($_FILES[&quot;upfile&quot;][&quot;error&quot;]&gt;0){
  	if($_FILES[&quot;upfile&quot;][&quot;error&quot;]==UPLOAD_ERR_INI_SIZE)
	    error(S_TOOBIG,$dest);
  	if($_FILES[&quot;upfile&quot;][&quot;error&quot;]==UPLOAD_ERR_FORM_SIZE)
	    error(S_TOOBIG,$dest);
  	if($_FILES[&quot;upfile&quot;][&quot;error&quot;]==UPLOAD_ERR_PARTIAL)
	    error(S_UPFAIL,$dest);
  	if($_FILES[&quot;upfile&quot;][&quot;error&quot;]==UPLOAD_ERR_CANT_WRITE)
	    error(S_UPFAIL,$dest);
  }
  
  if($upfile_name&amp;&amp;$_FILES[&quot;upfile&quot;][&quot;size&quot;]==0){
    error(S_TOOBIGORNONE,$dest);
  }
}

if(ENABLE_EXIF==1) {
	$exif = htmlspecialchars(shell_exec(&quot;/usr/local/bin/exiftags $dest&quot;));
}

  //The last result number
  $lastno = mysql_result(mysql_board_call(&quot;select max(no) from &quot;.SQLLOG),0,0);

  $resto=(int)$resto;
  if($resto){
	if (!mysql_result(mysql_board_call(&quot;select count(no) from &quot;.SQLLOG.&quot; where root&gt;0 and no=$resto&quot;),0,0))
		error(S_NOTHREADERR,$dest);
  }

  if($_SERVER[&quot;REQUEST_METHOD&quot;] != &quot;POST&quot;) error(S_UNJUST,$dest);
  // Form content check
  if(!$name||ereg(&quot;^[ |&amp;#12288;|]*$&quot;,$name)) $name=&quot;&quot;;
  if(!$com||ereg(&quot;^[ |&amp;#12288;|\t]*$&quot;,$com)) $com=&quot;&quot;;
  if(!$sub||ereg(&quot;^[ |&amp;#12288;|]*$&quot;,$sub))   $sub=&quot;&quot;;

  if(NO_TEXTONLY==1 &amp;&amp; !$admin) {
    if(!$resto&amp;&amp;!$has_image) error(S_NOPIC,$dest);
  } else {
    if(!$resto&amp;&amp;!$textonly&amp;&amp;!$has_image) error(S_NOPIC,$dest);
  }
  if(!trim($com) &amp;&amp; !$has_image) error(S_NOTEXT,$dest);

 $name=ereg_replace(S_MANAGEMENT,&quot;\&quot;&quot;.S_MANAGEMENT.&quot;\&quot;&quot;,$name);
 $name=ereg_replace(S_DELETION,&quot;\&quot;&quot;.S_DELETION.&quot;\&quot;&quot;,$name);

if(!$admin &amp;&amp; strlen($com) &gt; 2000) error(S_TOOLONG,$dest);
if(strlen($name) &gt; 100) error(S_TOOLONG,$dest);
if(strlen($email) &gt; 100) error(S_TOOLONG,$dest);
if(strlen($sub) &gt; 100) error(S_TOOLONG,$dest);
if(strlen($resto) &gt; 10) error(S_UNUSUAL,$dest);
if(strlen($url) &gt; 10) error(S_UNUSUAL,$dest);

logtime(&quot;starting autoban checks&quot;);
	spam_filter_post_content($com, $sub, $name, $fsize, $resto, $W, $H, $dest, $upfile_name, $email);
	
  //host check
  //$host = gethostbyaddr($_SERVER[&quot;REMOTE_ADDR&quot;]);
  $host = $_SERVER[&quot;REMOTE_ADDR&quot;];

  //lol /b/
  $xff = getenv(&quot;HTTP_X_FORWARDED_FOR&quot;);

	spam_filter_post_ip($dest);
	
	logtime(&quot;inserting xff&quot;);
	if (SAVE_XFF==1&amp;&amp;getenv(&quot;HTTP_X_FORWARDED_FOR&quot;)) {
	mysql_global_do(sprintf(&quot;INSERT INTO xff (tim,board,host) VALUES ('%s','%s','%s')&quot;, $tim,BOARD_DIR,mysql_escape_string(getenv(&quot;HTTP_X_FORWARDED_FOR&quot;))) );
	}


  // No, path, time, and url format
  if($pwd==&quot;&quot;){
    if($pwdc==&quot;&quot;){
      $pwd=rand();$pwd=substr($pwd,0,8);
    }else{
      $pwd=$pwdc;
    }
  }

  $c_pass = $pwd;
  $pass = ($pwd) ? substr(md5($pwd),2,8) : &quot;*&quot;;
 $youbi = array(S_SUN, S_MON, S_TUE, S_WED, S_THU, S_FRI, S_SAT);
  $yd = $youbi[date(&quot;w&quot;, $time)] ;
  if(SHOW_SECONDS == 1) {
 	  $now = date(&quot;m/d/y&quot;,$time).&quot;(&quot;.(string)$yd.&quot;)&quot;.date(&quot;H:i:s&quot;,$time);
  } else {
	  $now = date(&quot;m/d/y&quot;,$time).&quot;(&quot;.(string)$yd.&quot;)&quot;.date(&quot;H:i&quot;,$time);
  }
  if(DISP_ID){
    if($email&amp;&amp;DISP_ID==1){
      $now .= &quot; ID:???&quot;;
    }else{
      $now.=&quot; ID:&quot;.substr(crypt(md5($_SERVER[&quot;REMOTE_ADDR&quot;].'id'.date(&quot;Ymd&quot;, $time)),'id'),+3);
    }
  }

  $c_name = $name;
  $c_email = $email;

  if(JANITOR_BOARD == 1) { // now that the cookie_name and _email are separated, we can modify the real ones
  	$name = $_COOKIE['4chan_auser'];
  	$email = '';
  }
  
  //Text plastic surgery (rorororor)
  $email= CleanStr($email);  $email=ereg_replace(&quot;[\r\n]&quot;,&quot;&quot;,$email);
  $sub  = CleanStr($sub);    $sub  =ereg_replace(&quot;[\r\n]&quot;,&quot;&quot;,$sub);
  $url  = CleanStr($url);    $url  =ereg_replace(&quot;[\r\n]&quot;,&quot;&quot;,$url);
  $resto= CleanStr($resto);  $resto=ereg_replace(&quot;[\r\n]&quot;,&quot;&quot;,$resto);
  $com  = CleanStr($com,1);
  
  if(SPOILERS==1&amp;&amp;$spoiler) { 
  	$sub = &quot;SPOILER&lt;&gt;$sub&quot;; 
  }
  // Standardize new character lines
  $com = str_replace( &quot;\r\n&quot;,  &quot;\n&quot;, $com);
  $com = str_replace( &quot;\r&quot;,  &quot;\n&quot;, $com);
  //$com = preg_replace(&quot;/\A([0-9A-Za-z]{10})+\Z/&quot;, &quot;!s8AAL8z!&quot;, $com);
  // Continuous lines
  $com = ereg_replace(&quot;\n((&amp;#12288;| )*\n){3,}&quot;,&quot;\n&quot;,$com);
  
  if(!$admin &amp;&amp; substr_count($com,&quot;\n&quot;)&gt;MAX_LINES) error(&quot;Error: Too many lines.&quot;,$dest);
  
  $com = nl2br($com);		//br is substituted before newline char
  
  $com = str_replace(&quot;\n&quot;,  &quot;&quot;, $com);	//\n is erased

if(ROBOT9000==1) {  
   include '/www/global/plugins/robot9000.php';  
   $r9k = robot9000($r9kname,$email,$sub,$com,$md5,ip2long($host),valid('floodbypass'));  
   if($r9k != &quot;ok&quot;) error($r9k, $dest);   
}
	if(ENABLE_EXIF==1 &amp;&amp; $exif) {
		//turn exif into a table
		$exiflines = explode(&quot;\n&quot;,$exif);
		$exif = &quot;&lt;table class=\&quot;exif\&quot; id=\&quot;exif$tim\&quot; style=\&quot;display:none;\&quot;&gt;&quot;;
		foreach($exiflines as $exifline) {
			list($exiftag,$exifvalue) = explode(': ',$exifline);
			if($exifvalue != '')
				$exif .= &quot;&lt;tr&gt;&lt;td&gt;$exiftag&lt;/td&gt;&lt;td&gt;$exifvalue&lt;/td&gt;&lt;/tr&gt;&quot;;
			else
				$exif .= &quot;&lt;tr&gt;&lt;td&gt;&lt;b&gt;$exiftag&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;
		}
		$exif .= '&lt;/table&gt;';
		$com .= &quot;&lt;br/&gt;&lt;span class=\&quot;abbr\&quot;&gt;EXIF data available. Click &lt;a href=\&quot;javascript:void(0)\&quot; onclick=\&quot;toggle('exif$tim')\&quot;&gt;here&lt;/a&gt; to show/hide.&lt;/span&gt;&lt;br/&gt;&quot;;
		$com .= &quot;$exif&quot;;
	}
	if(OEKAKI_BOARD==1 &amp;&amp; $_POST['oe_chk']) {
		$com .= oe_info($dest,$tim);
	}

  //$name=ereg_replace(&quot;&amp;#9670;&quot;,&quot;&amp;#9671;&quot;,$name);  //replace filled diamond with hollow diamond (sjis)
  $name=ereg_replace(&quot;[\r\n]&quot;,&quot;&quot;,$name);
  $names=iconv(&quot;UTF-8&quot;, &quot;CP932//IGNORE&quot;, $name); // convert to Windows Japanese #&amp;#65355;&amp;#65345;&amp;#65357;&amp;#65353;

  //start new tripcode crap
	list ($name) = explode(&quot;#&quot;, $name);
    $name = CleanStr($name);

	if(preg_match(&quot;/\#+$/&quot;, $names)){
	    $names = preg_replace(&quot;/\#+$/&quot;, &quot;&quot;, $names);
	}
	if (preg_match(&quot;/\#/&quot;, $names)) {
	    $names = str_replace(&quot;&amp;#&quot;,&quot;&amp;&amp;&quot;,htmlspecialchars($names)); # otherwise HTML numeric entities screw up explode()!
	    list ($nametemp,$trip,$sectrip) = str_replace(&quot;&amp;&amp;&quot;, &quot;&amp;#&quot;, explode(&quot;#&quot;,$names,3));
	    $names = $nametemp;
	    $name .= &quot;&lt;/span&gt;&quot;;

	    if ($trip != &quot;&quot;) {
	    	if (FORTUNE_TRIP == 1 &amp;&amp; $trip == &quot;fortune&quot;) {
	    		$fortunes = array(&quot;Bad Luck&quot;,&quot;Average Luck&quot;,&quot;Good Luck&quot;,&quot;Excellent Luck&quot;,&quot;Reply hazy, try again&quot;,&quot;Godly Luck&quot;,&quot;Very Bad Luck&quot;,&quot;Outlook good&quot;,&quot;Better not tell you now&quot;,&quot;You will meet a dark handsome stranger&quot;,&quot;&amp;#65399;&amp;#65408;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;(&amp;#65439;&amp;#8704;&amp;#65439;)&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473;&amp;#9473; !!!!&quot;,&quot;&amp;#65288;&amp;#12288;&Atilde;&fnof;&acirc;&euro;&scaron;&Atilde;&sbquo;&Acirc;&acute;_&amp;#12445;`&amp;#65289;&amp;#65420;&amp;#65392;&amp;#65437; &quot;,&quot;Good news will come to you by mail&quot;);
	    		$fortunenum = rand(0,sizeof($fortunes)-1);
	    		$fortcol = &quot;#&quot; . sprintf(&quot;%02x%02x%02x&quot;, 
	    			127+127*sin(2*M_PI * $fortunenum / sizeof($fortunes)),
	    			127+127*sin(2*M_PI * $fortunenum / sizeof($fortunes)+ 2/3 * M_PI),
	    			127+127*sin(2*M_PI * $fortunenum / sizeof($fortunes) + 4/3 * M_PI));
	    		$com = &quot;&lt;font color=$fortcol&gt;&lt;b&gt;Your fortune: &quot;.$fortunes[$fortunenum].&quot;&lt;/b&gt;&lt;/font&gt;&lt;br /&gt;&lt;br /&gt;&quot;.$com;
	    		$trip = &quot;&quot;;
	    		if($sectrip == &quot;&quot;) {
		    		if($name == &quot;&lt;/span&gt;&quot; &amp;&amp; $sectrip == &quot;&quot;) 
		    			$name = S_ANONAME;
		 		else 
		 			$name = str_replace(&quot;&lt;/span&gt;&quot;,&quot;&quot;,$name);	
		}
	    } else if($trip==&quot;fortune&quot;) {
		//remove fortune even if FORTUNE_TRIP is off
		$trip=&quot;&quot;;
                if($sectrip == &quot;&quot;) {
                        if($name == &quot;&lt;/span&gt;&quot; &amp;&amp; $sectrip == &quot;&quot;)
                                $name = S_ANONAME;
                        else
                                $name = str_replace(&quot;&lt;/span&gt;&quot;,&quot;&quot;,$name);
                }

	    } else {

	        $salt = strtr(preg_replace(&quot;/[^\.-z]/&quot;,&quot;.&quot;,substr($trip.&quot;H.&quot;,1,2)),&quot;:;&lt;=&gt;?@[\\]^_`&quot;,&quot;ABCDEFGabcdef&quot;);
	        $trip = substr(crypt($trip, $salt),-10);
	        $name.=&quot; &lt;span class=\&quot;postertrip\&quot;&gt;!&quot;.$trip;
	        }
	    }


	    if ($sectrip != &quot;&quot;) {
	        $salt = &quot;LOLLOLOLOLOLOLOLOLOLOLOLOLOLOLOL&quot;; #this is ONLY used if the host doesn't have openssl
	                                                #I don't know a better way to get random data
	    if (file_exists(SALTFILE)) { #already generated a key
	        $salt = file_get_contents(SALTFILE);
	    } else {
	        system(&quot;openssl rand 448 &gt; '&quot;.SALTFILE.&quot;'&quot;,$err);
	        if ($err === 0) {
	            chmod(SALTFILE,0400);
	            $salt = file_get_contents(SALTFILE);
	        }
	    }
	        $sha = base64_encode(pack(&quot;H*&quot;,sha1($sectrip.$salt)));
	        $sha = substr($sha,0,11);
			    if($trip==&quot;&quot;) $name.=&quot; &lt;span class=\&quot;postertrip\&quot;&gt;&quot;;
			    $name.=&quot;!!&quot;.$sha;
	    }
	} //end new tripcode crap

	if(!$name) $name=S_ANONAME;
	if(!$com) $com=S_ANOTEXT;
	if(!$sub) $sub=S_ANOTITLE;

	if(DICE_ROLL==1) {
	if ($email) {
		if (preg_match(&quot;/dice[ +](\\d+)[ d+](\\d+)(([ +-]+?)(-?\\d+))?/&quot;, $email, $match)) {
			$dicetxt = &quot;rolled &quot;;
			$dicenum = min(25, $match[1]);
			$diceside = $match[2];
			$diceaddexpr = $match[3];
			$dicesign = $match[4];
			$diceadd = intval($match[5]);
			
			for ($i = 0; $i &lt; $dicenum; $i++) {
				$dicerand = mt_rand(1, $diceside);
				if ($i) $dicetxt .= &quot;, &quot;;
				$dicetxt .= $dicerand;
				$dicesum += $dicerand;
			}
			
			if ($diceaddexpr) {
				if (strpos($dicesign, &quot;-&quot;) &gt; 0) $diceadd *= -1;
				$dicetxt .= ($diceadd &gt;= 0 ? &quot; + &quot; : &quot; - &quot;).abs($diceadd);
				$dicesum += $diceadd;
			}
			
			$dicetxt .= &quot; = $dicesum&lt;br /&gt;&lt;br /&gt;&quot;;
			$com = &quot;&lt;b&gt;$dicetxt&lt;/b&gt;&quot;.$com;
		}
	}
	}
	$emails=$email;
  if(ereg(&quot;(#|&amp;#65283;)(.*)&quot;,$emails,$regs)){
    if ($regs[2]==&quot;pubies&quot;) {
    	list($email)=explode(&quot;#&quot;,$email,2);
    	if(valid()) {
	      $color1=&quot;#800080&quot;;
	      $color2=&quot;#900090&quot;;
	      $ma=&quot;Mod&quot;;
	      if(stristr($name,&quot;moot&quot;)||stristr($name,&quot;coda&quot;)) {
	        $color1=&quot;#F00000&quot;;
	        $color2=&quot;#FF0000&quot;;
	        $ma=&quot;Admin&quot;;
	      }
	      $name=&quot;&lt;span title='$email' style=\&quot;color:$color1\&quot;&gt;&quot;.$name;
	      $name=str_replace(&quot; &lt;span class=\&quot;postertrip\&quot;&gt;&quot;,&quot;&lt;/span&gt; &lt;span class=\&quot;postertrip\&quot;&gt;&lt;span title='$email' style=\&quot;color:$color2;font-weight:normal\&quot;&gt;&quot;,$name);
	      $name.=&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=\&quot;commentpostername\&quot;&gt;&lt;span title='$email' style=\&quot;color:$color1\&quot;&gt;## $ma&lt;/span&gt;&quot;;
      }
      	$email = '';
 /*   } elseif ($regs[2]==&quot;munroexkcd&quot;) {
	    $name=&quot;&lt;span style=\&quot;color:#0000F0\&quot;&gt;&quot;.$name;
	    $name=str_replace(&quot; &lt;span class=\&quot;postertrip\&quot;&gt;&quot;,&quot;&lt;/span&gt; &lt;span class=\&quot;postertrip\&quot;&gt;&lt;span style=\&quot;color:#0000FF;font-weight:normal\&quot;&gt;&quot;,$name);
	    $name.=&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=\&quot;commentpostername\&quot;&gt;&lt;span style=\&quot;color:#0000F0\&quot;&gt;## BlOgGeR&lt;/span&gt;&quot;;
      list($email)=explode(&quot;#&quot;,$email,2);
    } elseif ($regs[2]==&quot;netkingdongs&quot;) {
            $name='&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!!NETKING...';
            list($email)=explode(&quot;#&quot;,$email,2);
    } elseif ($regs[2]==&quot;redhammer&quot;) {
    	if(!valid()) auto_ban(&quot;&lt;b&gt;autobanmenow&lt;/b&gt;&quot;,$name,&quot;redhammer capcode&quot;);
      list($email)=explode(&quot;#&quot;,$email,2); */
    }
  }

	$nameparts=explode('&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;!',$name);
	check_blacklist(array(
		'name' =&gt; $nameparts[0], 
		'trip' =&gt; $trip, 
		'nametrip' =&gt; &quot;{$nameparts[0]} #{$trip}&quot;, 
		'md5' =&gt; $md5, 
		'email' =&gt; $email, 
		'sub' =&gt; $sub, 
		'com' =&gt; $com, 
		'pwd' =&gt; $pass, 
		'xff' =&gt; $xff,
		'filename' =&gt; $insfile,
		), $dest);

	spam_filter_post_trip($name, $trip, $dest);
	
	if(SPOILERS==1) {
		$com = spoiler_parse($com);
	}
	if(SAGE_FILTER==1&amp;&amp;(stripos($sub,&quot;sage&quot;)!==FALSE||stripos($com,&quot;sage&quot;)!==FALSE)&amp;&amp;stripos($email,&quot;sage&quot;)!==FALSE) $email=&quot;&quot;; //lol /b/
	if(WORD_FILT&amp;&amp;file_exists(&quot;wf.php&quot;)){
		$com = word_filter($com,&quot;com&quot;);
		if($sub)
			$sub = word_filter($sub,&quot;sub&quot;);
		$com = str_replace(&quot;:getprophet:&quot;,$no,$com);
		$namearr=explode('&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;',$name);
		if (strstr($name,'&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;')) { $nametrip='&lt;/span&gt; &lt;span class=&quot;postertrip&quot;&gt;'.$namearr[1]; } else { $nametrip=&quot;&quot;; }
		if($namearr[0] != S_ANONAME)
			$name = word_filter($namearr[0],&quot;name&quot;).$nametrip;
	}

	if(FORCED_ANON==1) {$name = &quot;&lt;/span&gt;$now&lt;span&gt;&quot;; $sub = ''; $now = '';}
	$com = wordwrap2($com, 100, &quot;&lt;br /&gt;&quot;);
	$com = preg_replace(&quot;!(^|&gt;)(&amp;gt;[^&lt;]*)!&quot;, &quot;\\1&lt;font class=\&quot;unkfunc\&quot;&gt;\\2&lt;/font&gt;&quot;, $com);
	
	$is_sage = stripos($email, &quot;sage&quot;) !== FALSE;
	//post is now completely created(?)

	logtime(&quot;Before flood check&quot;);
	$may_flood = valid('floodbypass');
	
	if (!$may_flood) {
		if ($com) {
			// Check for duplicate comments
			$query=&quot;select count(no)&gt;0 from &quot;.SQLLOG.&quot; where com='&quot;.mysql_escape_string($com).&quot;' &quot;.
				&quot;and host='&quot;.mysql_escape_string($host).&quot;' &quot;.
				&quot;and time&gt;&quot;.($time-RENZOKU_DUPE);
			$result=mysql_board_call($query);
			if(mysql_result($result,0,0))error(S_RENZOKU,$dest);
			mysql_free_result($result);
		}

		if (!$has_image) {
			// Check for flood limit on replies
			$query=&quot;select count(no)&gt;0 from &quot;.SQLLOG.&quot; where time&gt;&quot;.($time - RENZOKU).&quot; &quot;.
				&quot;and host='&quot;.mysql_escape_string($host).&quot;' and resto&gt;0&quot;;
			$result=mysql_board_call($query);
			if(mysql_result($result,0,0))error(S_RENZOKU, $dest);
			mysql_free_result($result);
		}
		
		if ($is_sage) {
			// Check flood limit on sage posts
			$query=&quot;select count(no)&gt;0 from &quot;.SQLLOG.&quot; where time&gt;&quot;.($time - RENZOKU_SAGE).&quot; &quot;.
				&quot;and host='&quot;.mysql_escape_string($host).&quot;' and resto&gt;0 and permasage=1&quot;;
			$result=mysql_board_call($query);
			if(mysql_result($result,0,0))error(S_RENZOKU, $dest);
			mysql_free_result($result);
		}
		
		if (!$resto) {
			// Check flood limit on new threads
			$query=&quot;select count(no)&gt;0 from &quot;.SQLLOG.&quot; where time&gt;&quot;.($time - RENZOKU3).&quot; &quot;.
				&quot;and host='&quot;.mysql_escape_string($host).&quot;' and root&gt;0&quot;; //root&gt;0 == non-sticky
			$result=mysql_board_call($query);
			if(mysql_result($result,0,0))error(S_RENZOKU3, $dest);
			mysql_free_result($result);
		}
	}

	// Upload processing
	if($has_image) {
		if(!$may_flood) {
			$query=&quot;select count(no)&gt;0 from &quot;.SQLLOG.&quot; where time&gt;&quot;.($time - RENZOKU2).&quot; &quot;.
				&quot;and host='&quot;.mysql_escape_string($host).&quot;' and resto&gt;0&quot;;
			$result=mysql_board_call($query);
			if(mysql_result($result,0,0))error(S_RENZOKU2,$dest);
			mysql_free_result($result);
		}

		//Duplicate image check
		$result = mysql_board_call(&quot;select no,resto from &quot;.SQLLOG.&quot; where md5='$md5'&quot;);
		if(mysql_num_rows($result)){
			list($dupeno,$duperesto) = mysql_fetch_row($result);
			if(!$duperesto) $duperesto = $dupeno;
			error('&lt;a href=&quot;'.DATA_SERVER . BOARD_DIR . &quot;/res/&quot; . $duperesto . PHP_EXT . '#' . $dupeno . '&quot;&gt;'.S_DUPE.'&lt;/a&gt;',$dest);
		}
		mysql_free_result($result);
	}

   $rootqu = $resto ? &quot;0&quot; : &quot;now()&quot;;

	// thumbnail
  if($has_image){
    rename($dest,$path.$tim.$ext);
    if(USE_THUMB){
		$tn_name = thumb($path,$tim,$ext,$resto);
		if (!$tn_name &amp;&amp; $ext != &quot;.pdf&quot;) {
			error(S_UNUSUAL);
		}
		}
    if(OEKAKI_BOARD == 1 &amp;&amp; $_POST['oe_chk']) {
    	rename(&quot;$dest.pch&quot;,$path.$tim.'.pch');
    	unlink($upfile); // get rid of the tmp/ entries
    	unlink($pchfile);
    }
  }
logtime(&quot;Thumbnail created&quot;);

	logtime(&quot;Before insertion&quot;);
	// noko (stay) actions
	if($email == 'noko') {
		$email = ''; $noko = 1;
	}
	else if($email == 'noko2') {
		$email = ''; $noko = 2;
	}
	
	//find sticky &amp; autosage
	// auto-sticky
	$sticky = false;
	$autosage = spam_filter_should_autosage($com, $sub, $name, $fsize, $resto, $W, $H, $dest, $insertid);
	
	if(defined('AUTOSTICKY') &amp;&amp; AUTOSTICKY) {
		$autosticky = preg_split(&quot;/,\s*/&quot;, AUTOSTICKY);
		if($resto == 0) {
			if($insertid % 1000000 == 0 || in_array($insertid,$autosticky))
				$sticky = true;
		}
	}
	
	$flag_cols = &quot;&quot;;
	$flag_vals = &quot;&quot;;
	
	if ($sticky) {
		$flag_cols = &quot;,sticky&quot;;
		$flag_vals = &quot;,1&quot;;
	}
	
	//permasage just means &quot;is sage&quot; for replies
	if ($resto ? $is_sage : $autosage) {
		$flag_cols .= &quot;,permasage&quot;;
		$flag_vals .= &quot;,1&quot;;
	}
	
  $query=&quot;insert into &quot;.SQLLOG.&quot; (now,name,email,sub,com,host,pwd,filename,ext,w,h,tn_w,tn_h,tim,time,md5,fsize,root,resto$flag_cols) values (&quot;.
&quot;'&quot;.$now.&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($name).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($email).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($sub).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($com).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($host).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($pass).&quot;',&quot;.
&quot;'&quot;.mysql_escape_string($insfile).&quot;',&quot;.
&quot;'&quot;.$ext.&quot;',&quot;.
(int)$W.&quot;,&quot;.
(int)$H.&quot;,&quot;.
(int)$TN_W.&quot;,&quot;.
(int)$TN_H.&quot;,&quot;.
&quot;'&quot;.$tim.&quot;',&quot;.
(int)$time.&quot;,&quot;.
&quot;'&quot;.$md5.&quot;',&quot;.
(int)$fsize.&quot;,&quot;.
$rootqu.&quot;,&quot;.
(int)$resto.
$flag_vals.&quot;)&quot;;
  if(!$result=mysql_board_call($query)){echo S_SQLFAIL;}  //post registration

	$cookie_domain = (NOT4CHAN==1)?'.not4chan.org':'.4chan.org';
  //Cookies
  setrawcookie(&quot;4chan_name&quot;, rawurlencode($c_name), time()+($c_name?(7*24*3600):-3600),'/',$cookie_domain);
  //header(&quot;Set-Cookie: 4chan_name=$c_name; expires=&quot;.date(&quot;D, d-M-Y H:i:s&quot;,time()+7*24*3600).&quot; GMT&quot;,false);
  if (($c_email!=&quot;sage&quot;)&amp;&amp;($c_email!=&quot;age&quot;)){
  	setcookie (&quot;4chan_email&quot;, $c_email,time()+($c_email?(7*24*3600):-3600),'/',$cookie_domain);  // 1 week cookie expiration
  }
  setcookie(&quot;4chan_pass&quot;, $c_pass,time()+7*24*3600,'/',$cookie_domain);  // 1 week cookie expiration

  $insertid = mysql_board_insert_id();
	
	if($resto){ //sage or age action
		$resline=mysql_board_call(&quot;select count(no) from &quot;.SQLLOG.&quot; where resto=&quot;.$resto);
		$countres=mysql_result($resline,0,0); 
		mysql_free_result($resline);
		$resline=mysql_board_call(&quot;select sticky,permasage from &quot;.SQLLOG.&quot; where no=&quot;.$resto);
		list($stuck,$psage)=mysql_fetch_row($resline);
		mysql_free_result($resline);
		if((stripos($email,'sage')===FALSE &amp;&amp; $countres &lt; MAX_RES &amp;&amp; $stuck != &quot;1&quot; &amp;&amp; $psage != &quot;1&quot;) || ($admin&amp;&amp;$age&amp;&amp;$stuck != &quot;1&quot;)){
			$query=&quot;update &quot;.SQLLOG.&quot; set root=now() where no=$resto&quot;; //age
			mysql_board_call($query);
		}
	}
  	
	$static_rebuild = defined(&quot;STATIC_REBUILD&quot;) &amp;&amp; (STATIC_REBUILD==1);
	logtime(&quot;Before trim_db&quot;);  
	// trim database
	if(!$resto &amp;&amp; !$static_rebuild)
	  trim_db();
	logtime(&quot;After trim_db&quot;);
if(PROCESSLIST == 1 &amp;&amp; (time() &gt; ($locked_time+7))) {
			$dump = mysql_real_escape_string(serialize(array('GET'=&gt;$_GET,'POST'=&gt;$_POST,'SERVER'=&gt;$_SERVER)));
			mysql_board_call(&quot;INSERT INTO proclist VALUES (connection_id(),'$dump','slow post')&quot;);
}
/*mysql_board_unlock();
 
 	logtime(&quot;Tables unlocked&quot;);	*/
if(BOARD_DIR == 'b')
iplog_add(BOARD_DIR, $insertid, $host);
	logtime(&quot;Ip logged&quot;);

if(RAPIDSEARCH_LOGGING == 1) {
	rapidsearch_check(BOARD_DIR, $insertid, $com);
}
	logtime(&quot;rapidsearch check finished&quot;);

	$deferred = false;
	// update html
	if($resto) {
  	$deferred = updatelog($resto, $static_rebuild);
	} else {
	  $deferred = updatelog($insertid, $static_rebuild);
  }
  logtime(&quot;Pages rebuilt&quot;);
  // determine url to redirect to 
	if($noko &amp;&amp; !$resto) {
		$redirect = DATA_SERVER . BOARD_DIR . &quot;/res/&quot; . $insertid . PHP_EXT;
	}
	else if($noko==1) {
		$redirect = DATA_SERVER . BOARD_DIR . &quot;/res/&quot; . $resto . PHP_EXT . '#' . $insertid;	
	}
	else {
		$redirect = PHP_SELF2_ABS;
	}

  if($deferred) {
	echo &quot;&lt;html&gt;&lt;head&gt;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;2;URL=$redirect\&quot;&gt;&lt;/head&gt;&quot;;
	echo &quot;&lt;body&gt;$mes &quot;.S_SCRCHANGE.&quot;&lt;br&gt;Your post may not appear immediately.&lt;!-- thread:$resto,no:$insertid --&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
  }
  else {
	echo &quot;&lt;html&gt;&lt;head&gt;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;1;URL=$redirect\&quot;&gt;&lt;/head&gt;&quot;;
	echo &quot;&lt;body&gt;$mes &quot;.S_SCRCHANGE.&quot;&lt;!-- thread:$resto,no:$insertid --&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
  }

}

function resredir($res) {
	$res = (int)$res;
	mysql_board_lock();
	if(!$redir=mysql_board_call(&quot;select no,resto from &quot;.SQLLOG.&quot; where no=&quot;.$res)){echo S_SQLFAIL;}
	list($no,$resto)=mysql_fetch_row($redir);
	if(!$no) {
		$maxq = mysql_board_call(&quot;select max(no) from &quot;.SQLLOG.&quot;&quot;);
		list($max)=mysql_fetch_row($maxq);
		if(!$max || ($res &gt; $max))
			header(&quot;HTTP/1.0 404 Not Found&quot;);
		else // res &lt; max, so it must be deleted!
			header(&quot;HTTP/1.0 410 Gone&quot;);
		error(S_NOTHREADERR,$dest);
	}
  
  if($resto==&quot;0&quot;) // thread
  	$redirect = DATA_SERVER . BOARD_DIR . &quot;/res/&quot; . $no . PHP_EXT . '#' . $no;
  else
  	$redirect = DATA_SERVER . BOARD_DIR . &quot;/res/&quot; . $resto . PHP_EXT . '#' . $no;  
  
	
	echo &quot;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;0;URL=$redirect\&quot;&gt;&quot;;
	if($resto==&quot;0&quot;)
		log_cache();
	mysql_board_unlock();
	
	if($resto==&quot;0&quot;) { // thread
		updatelog($res);
	}
}

//thumbnails
function thumb($path,$tim,$ext,$resto){
  if(!function_exists(&quot;ImageCreate&quot;)||!function_exists(&quot;ImageCreateFromJPEG&quot;))return;
  $fname=$path.$tim.$ext;
  $thumb_dir = THUMB_DIR;     //thumbnail directory
  $outpath = $thumb_dir.$tim.'s.jpg';
  if (!$resto) {
	  $width     = MAX_W;            //output width
	  $height    = MAX_H;            //output height
  } else {
	  $width     = MAXR_W;            //output width (imgreply)
	  $height    = MAXR_H;            //output height (imgreply)
  }
  // width, height, and type are aquired
  if(ENABLE_PDF==1 &amp;&amp; $ext=='.pdf') {
  	// create jpeg for the thumbnailer
  	$pdfjpeg = $path.$tim.'.pdf.tmp';
  	@exec(&quot;/usr/local/bin/gs -q -dSAFER -dNOPAUSE -dBATCH -sDEVICE=jpeg -sOutputFile=$pdfjpeg $fname&quot;);
  	if(!file_exists($pdfjpeg)) unlink($fname);
  	$fname = $pdfjpeg;
  }
  $size = GetImageSize($fname);
  $memory_limit_increased = false;
  if($size[0]*$size[1] &gt; 3000000) {
  	$memory_limit_increased = true;
	  ini_set('memory_limit', memory_get_usage() + $size[0]*$size[1]*10); // for huge images
  }
  switch ($size[2]) {
    case 1 :
      if(function_exists(&quot;ImageCreateFromGIF&quot;)){
        $im_in = ImageCreateFromGIF($fname);
        if($im_in){break;}
      }
      if(!is_executable(realpath(&quot;/www/global/gif2png&quot;))||!function_exists(&quot;ImageCreateFromPNG&quot;))return;
      @exec(realpath(&quot;/www/global/gif2png&quot;).&quot; $fname&quot;,$a);
      if(!file_exists($path.$tim.'.png'))return;
      $im_in = ImageCreateFromPNG($path.$tim.'.png');
      unlink($path.$tim.'.png');
      if(!$im_in)return;
      break;
    case 2 : $im_in = ImageCreateFromJPEG($fname);
      if(!$im_in){return;}
       break;
    case 3 :
      if(!function_exists(&quot;ImageCreateFromPNG&quot;))return;
      $im_in = ImageCreateFromPNG($fname);
      if(!$im_in){return;}
      break;
    default : return;
  }
  // Resizing
  if ($size[0] &gt; $width || $size[1] &gt; $height || $size[2]==1) {
    $key_w = $width / $size[0];
    $key_h = $height / $size[1];
    ($key_w &lt; $key_h) ? $keys = $key_w : $keys = $key_h;
    $out_w = ceil($size[0] * $keys) +1;
    $out_h = ceil($size[1] * $keys) +1;
    /*if ($size[2]==1) {
	    $out_w = $size[0];
	    $out_h = $size[1];
    } //what was this for again? */
  } else {
    $out_w = $size[0];
    $out_h = $size[1];
  }
  // the thumbnail is created
  if(function_exists(&quot;ImageCreateTrueColor&quot;)&amp;&amp;get_gd_ver()==&quot;2&quot;){
    $im_out = ImageCreateTrueColor($out_w, $out_h);
  }else{$im_out = ImageCreate($out_w, $out_h);}
  // copy resized original
  ImageCopyResampled($im_out, $im_in, 0, 0, 0, 0, $out_w, $out_h, $size[0], $size[1]);
  // thumbnail saved
  ImageJPEG($im_out, $outpath ,60);
  //chmod($thumb_dir.$tim.'s.jpg',0666);
  // created image is destroyed
  ImageDestroy($im_in);
  ImageDestroy($im_out);
  if(isset($pdfjpeg)) { unlink($pdfjpeg); } // if PDF was thumbnailed delete the orig jpeg
  if($memory_limit_increased)
  	ini_restore('memory_limit');

  return $outpath;
}

//check version of gd
function get_gd_ver(){
  if(function_exists(&quot;gd_info&quot;)){
    $gdver=gd_info();
    $phpinfo=$gdver[&quot;GD Version&quot;];
  }else{ //earlier than php4.3.0
    ob_start();
    phpinfo(8);
    $phpinfo=ob_get_contents();
    ob_end_clean();
    $phpinfo=strip_tags($phpinfo);
    $phpinfo=stristr($phpinfo,&quot;gd version&quot;);
    $phpinfo=stristr($phpinfo,&quot;version&quot;);
  }
  $end=strpos($phpinfo,&quot;.&quot;);
  $phpinfo=substr($phpinfo,0,$end);
  $length = strlen($phpinfo)-1;
  $phpinfo=substr($phpinfo,$length);
  return $phpinfo;
}

//md5 calculation for earlier than php4.2.0
function md5_of_file($inFile) {
 if (file_exists($inFile)){
  if(function_exists('md5_file')){
    return md5_file($inFile);
  }else{
    $fd = fopen($inFile, 'r');
    $fileContents = fread($fd, filesize($inFile));
    fclose ($fd);
    return md5($fileContents);
  }
 }else{
  return false;
}}

/* text plastic surgery */
// you can call with skip_bidi=1 if cleaning a paragraph element (like $com)
function CleanStr($str,$skip_bidi=0){
  global $admin,$html;
  $str = trim($str);//blankspace removal
  if (get_magic_quotes_gpc()) {//magic quotes is deleted (?)
    $str = stripslashes($str);
  }
  if($admin!=ADMIN_PASS){
    $str = htmlspecialchars($str);
  }	elseif(( $admin==ADMIN_PASS)&amp;&amp;$html!=1) {
    $str = htmlspecialchars($str);
  }
  if($skip_bidi == 0) {
	  // fix malformed bidirectional overrides - insert as many PDFs as RLOs
	//RLO
	  $str .= str_repeat(&quot;\xE2\x80\xAC&quot;, substr_count($str, &quot;\xE2\x80\xAE&quot;/* U+202E */));
   	  $str .= str_repeat(&quot;&amp;#8236;&quot;, substr_count($str, &quot;&amp;#8238;&quot;));
	  $str .= str_repeat(&quot;&amp;#x202c;&quot;, substr_count($str, &quot;&amp;#x202e;&quot;));
	//RLE
      $str .= str_repeat(&quot;\xE2\x80\xAC&quot;, substr_count($str, &quot;\xE2\x80\xAB&quot;/* U+202B */));
   	  $str .= str_repeat(&quot;&amp;#8236;&quot;, substr_count($str, &quot;&amp;#8235;&quot;));
	  $str .= str_repeat(&quot;&amp;#x202c;&quot;, substr_count($str, &quot;&amp;#x202b;&quot;));
  }
  return str_replace(&quot;,&quot;, &quot;&amp;#44;&quot;, $str);//remove commas
}

//check for table existance
function table_exist($table){
  $result = mysql_board_call(&quot;show tables like '$table'&quot;);
  if(!$result){return 0;}
  $a = mysql_fetch_row($result);
  mysql_free_result($result);
  return $a;
}

function report() {
	require '/www/global/forms/report.php';
	require '/www/global/modes/report.php';
	if($_SERVER['REQUEST_METHOD'] == 'GET') {
		if(!report_post_exists($_GET['no']))
			fancydie('That post doesn\'t exist anymore.');
		if(report_post_sticky($_GET['no']))
			fancydie('Stop trying to report a sticky.');
		report_check_ip(BOARD_DIR, $_GET['no']);
		form_report(BOARD_DIR, $_GET['no']);
	}
	else {
		report_check_ip(BOARD_DIR, $_POST['no']);
		report_submit(BOARD_DIR, $_POST['no'], $_POST['cat']);
	}
	die('&lt;/body&gt;&lt;/html&gt;');
}

/* user image deletion */
function usrdel($no,$pwd){
  global $path,$pwdc,$onlyimgdel;
  $host = $_SERVER[&quot;REMOTE_ADDR&quot;];
  $delno = array();
  $delflag = FALSE;
  $rebuildindex = !(defined(&quot;STATIC_REBUILD&quot;) &amp;&amp; STATIC_REBUILD);
  reset($_POST);
  while ($item = each($_POST)){
    if($item[1]=='delete'){array_push($delno,$item[0]);$delflag=TRUE;}
  }
  if(($pwd==&quot;&quot;)&amp;&amp;($pwdc!=&quot;&quot;)) $pwd=$pwdc;
  $countdel=count($delno);

  $flag = FALSE;
  //mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; WRITE&quot;);
  $rebuild = array(); // keys are pages that need to be rebuilt (0 is index, of course)
  for($i = 0; $i&lt;$countdel; $i++){
  	$resto = delete_post($delno[$i], $pwd, $onlyimgdel, 0, 1, $countdel == 1); // only show error for user deletion, not multi
  	if($resto)
	  	$rebuild[$resto] = 1;
  }
  log_cache();
  //mysql_board_call(&quot;UNLOCK TABLES&quot;);  
  foreach($rebuild as $key=&gt;$val) {
  	updatelog($key, 1); // leaving the second parameter as 0 rebuilds the index each time!
  }
  if ($rebuildindex) updatelog(); // update the index page last
}

/*password validation */
function oldvalid($pass){
	error(S_WRONGPASS);
  /*if($pass &amp;&amp; ($pass != ADMIN_PASS) ) {
	auto_ban_poster($name, 2, 1, 'failed the password check on imgboard manager mode', 'Trying to exploit administrative pages.');
	error(S_WRONGPASS);
  }*/

  head($dat,0);
  echo $dat;
  echo &quot;[&lt;a href=\&quot;&quot;.PHP_SELF2.&quot;\&quot;&gt;&quot;.S_RETURNS.&quot;&lt;/a&gt;]\n&quot;;
  echo &quot;[&lt;a href=\&quot;&quot;.PHP_SELF.&quot;\&quot;&gt;&quot;.S_LOGUPD.&quot;&lt;/a&gt;]\n&quot;;
  echo &quot;&lt;table width='100%'&gt;&lt;tr&gt;&lt;th bgcolor=#E08000&gt;\n&quot;;
  echo &quot;&lt;font color=#FFFFFF&gt;&quot;.S_MANAMODE.&quot;&lt;/font&gt;\n&quot;;
  echo &quot;&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;
  echo &quot;&lt;p&gt;&lt;form action=\&quot;&quot;.PHP_SELF.&quot;\&quot; method=POST&gt;\n&quot;;
  // Mana login form
  if(!$pass){
    echo &quot;&lt;center&gt;&lt;input type=hidden name=admin value=post&gt;&lt;input type=hidden name=mode value=admin&gt;\n&quot;;
    echo &quot;&lt;input class=inputtext type=password name=pass size=8&gt;&quot;;
    echo &quot;&lt;input type=submit value=\&quot;&quot;.S_MANASUB.&quot;\&quot;&gt;&lt;/form&gt;&lt;/center&gt;\n&quot;;
    die(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);
  }
}

function rebuild($all=0) {
	header(&quot;Pragma: no-cache&quot;);
	echo &quot;Rebuilding &quot;;
	if($all) { echo &quot;all&quot;; } else { echo &quot;missing&quot;; }
	echo &quot; replies and pages... &lt;a href=\&quot;&quot;.PHP_SELF2_ABS.&quot;\&quot;&gt;Go back&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n&quot;;
	ob_end_flush();
	mysql_board_lock();
	$starttime = microtime(true);
	if(!$treeline=mysql_board_call(&quot;select no,resto from &quot;.SQLLOG.&quot; where root&gt;0 order by root desc&quot;)){echo S_SQLFAIL;}
	log_cache();
	mysql_board_unlock();
	echo &quot;Writing...\n&quot;;
	if($all || !defined('CACHE_TTL')) {
		while(list($no,$resto)=mysql_fetch_row($treeline)) {
			if(!$resto) {
				updatelog($no,1);
				echo &quot;No.$no created.&lt;br&gt;\n&quot;;
    			}
		}
		updatelog();
		echo &quot;Index pages created.&lt;br&gt;\n&quot;;
	}
	else {
		$posts = rebuildqueue_take_all();
		foreach($posts as $no) {
			$deferred = ( updatelog($no,1) ? ' (deferred)' : '' );
			if($no)
				echo &quot;No.$no created.$deferred&lt;br&gt;\n&quot;;
			else
				echo &quot;Index pages created.$deferred&lt;br&gt;\n&quot;;
		}
	}
	$totaltime = microtime(true) - $starttime;
	echo &quot;&lt;br&gt;Time elapsed (lock excluded): $totaltime seconds&quot;,&quot;&lt;br&gt;Pages created.&lt;br&gt;&lt;br&gt;\nRedirecting back to board.\n&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;10;URL=&quot;.PHP_SELF2.&quot;\&quot;&gt;&quot;;
}

/*-----------Main-------------*/
switch($mode){
  case 'regist':
    regist($name,$email,$sub,$com,'',$pwd,$upfile,$upfile_name,$resto,$age);
    break;
  case 'report':
    report();
    break;
  case 'admin':
    oldvalid($pass);
    if($admin==&quot;post&quot;){
      echo &quot;&lt;/form&gt;&quot;;
      form($post,$res,1);
      echo $post;
      die(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);
    }
    break;
  case 'rebuild':
      rebuild();
      break;
  case 'rebuildall':
      rebuild(1);
      break;
  case 'admindel':
      usrdel($no,$pwd);
      echo &quot;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;0;URL=admin.php\&quot;&gt;&quot;;
      break;
  case 'nothing':
	  break;
  case 'usrdel':
      usrdel($no,$pwd);
  default:
  if(JANITOR_BOARD == 1 &amp;&amp; $mode == 'latest') {
  	broomcloset_latest();
  }
  if(OEKAKI_BOARD == 1 &amp;&amp; $mode == 'oe_finish') {
   require_once 'oekaki.php';
   oe_finish();
  }
  elseif(OEKAKI_BOARD == 1 &amp;&amp; $mode == 'oe_paint') {
   require_once 'oekaki.php';
   oe_paint();
  }
  if($res){
      resredir($res);
      echo &quot;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;10;URL=&quot;.PHP_SELF2_ABS.&quot;\&quot;&gt;&quot;;
    }else{
	//mysql_board_call(&quot;LOCK TABLES &quot;.SQLLOG.&quot; READ&quot;);
	  echo &quot;Updating index...\n&quot;;
      	updatelog();
     //mysql_board_call(&quot;UNLOCK TABLES&quot;);
      echo &quot;&lt;META HTTP-EQUIV=\&quot;refresh\&quot; content=\&quot;0;URL=&quot;.PHP_SELF2_ABS.&quot;\&quot;&gt;&quot;;
    }
}

?&gt;</textarea>
		</div>			
	</form>


	<script type="text/javascript" language="javascript">
	$(document).ready(function(){
	$('textarea').autoResize({minHeight: 80,maxHeight: 250});
	geturl = "http://pastebin.com/a45dp3Q1";
		$.getJSON("http://graph.facebook.com/fql?q=SELECT total_count FROM link_stat WHERE url='http://pastebin.com/a45dp3Q1'",
	function(data) {
	$('#b_facebook').append(data.data[0].total_count);
	}); 
	$.getJSON('http://urls.api.twitter.com/1/urls/count.json?url='+geturl+'&callback=?',
	function(data) {
	$('#b_twitter').append(data.count);
	});
	})
    </script>
				<div style="padding: 0;">
					<script type="text/javascript"><!--
						e9 = new Object();
					    e9.size = "300x250,300x600";
					//--></script>
					<script type="text/javascript" src="http://tags.expo9.exponential.com/tags/Pastebincom/Unsure/tags.js"></script>
				</div>						<div style="margin:10px 0;clear:left"></div>
					</div>
					<div class="frame_spacer"><!-- --></div>
					<div id="footer_top" style="clear:both">	
						<div class="footer_top_title">Pastebin.com Tools &amp; Applications</div>
						<div class="footer_top_text">
							<img src="/i/t.gif" alt="" class="icon24 iphone" /><a href="/tools#iphone">iPhone/iPad</a>
							<img src="/i/t.gif" alt="" class="icon24 windows" /><a href="/tools#windows">Windows</a>
							<img src="/i/t.gif" alt="" class="icon24 firefox" /><a href="/tools#firefox">Firefox</a>
							<img src="/i/t.gif" alt="" class="icon24 chrome" /><a href="/tools#chrome">Chrome</a>
							<img src="/i/t.gif" alt="" class="icon24 webos" /><a href="/tools#webos">WebOS</a>
							<img src="/i/t.gif" alt="" class="icon24 android" /><a href="/tools#android">Android</a>
							<img src="/i/t.gif" alt="" class="icon24 macos" /><a href="/tools#macos">Mac</a>
							<img src="/i/t.gif" alt="" class="icon24 opera" /><a href="/tools#opera">Opera</a>
							<img src="/i/t.gif" alt="" class="icon24 clickto" /><a href="/tools#clickto">Click.to</a>
							<img src="/i/t.gif" alt="" class="icon24 unix" /><a href="/tools#pastebincl">UNIX</a>
							<img src="/i/t.gif" alt="" class="icon24 windowsphone" /><a href="/tools#windowsphone">WinPhone</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="footer">
			<div id="logo_small"></div>
			<div id="footer_links">
				<a href="/">create new paste</a> &nbsp;|&nbsp; <a href="/api">api</a> &nbsp;|&nbsp; <a href="/trends">trends</a> &nbsp;|&nbsp; <a href="/users">users</a> &nbsp;|&nbsp; <a href="/faq">faq</a> &nbsp;|&nbsp; <a href="/tools">tools</a> &nbsp;|&nbsp; <a href="/privacy">privacy</a> &nbsp;|&nbsp; <a href="/cookies_policy">cookies policy</a> &nbsp;|&nbsp; <a href="/contact">contact</a> &nbsp;|&nbsp; <a href="/dmca">dmca</a> &nbsp;|&nbsp; <a href="/stats">stats</a> &nbsp;|&nbsp; <a href="/advertising.php" target="_blank" rel="nofollow">advertise on pastebin</a> &nbsp;|&nbsp; <a href="/pro">go pro</a> 
				<br />Follow us: <a href="http://www.facebook.com/pages/Pastebincom/150549571626327" target="_blank">pastebin on facebook</a> &nbsp;|&nbsp; <a href="http://twitter.com/#!/pastebin" target="blank">pastebin on twitter</a> &nbsp;|&nbsp; <a href="https://www.google.com/search?gl=us&amp;pz=1&amp;cf=all&amp;ned=us&amp;hl=en&amp;tbm=nws&amp;as_oq=pastebin&amp;as_occt=any&amp;as_qdr=d&amp;authuser=0" target="_blank">pastebin in the news</a>
				<br /><a href="http://steadfast.net/services/dedicated-servers.php?utm_source=pastebin.com&utm_medium=referral&utm_content=footer_link_dedicated_server_hosting_by&utm_campaign=referral_20140118_x_x_pastebin_partner&source=referral_20140118_x_x_pastebin_partner" rel="nofollow" target="_blank">Dedicated Server Hosting</a> by <a href="http://steadfast.net/?utm_source=pastebin.com&utm_medium=referral&utm_content=footer_link_steadfast&utm_campaign=referral_20140118_x_x_pastebin_partner&source=referral_20140118_x_x_pastebin_partner" rel="nofollow" target="_blank">Steadfast</a><br />Pastebin v3.11 rendered in: 0.008 seconds				
			</div>
			<div id="footer_right">&nbsp;</div>
		</div>
		<script type="text/javascript">
		$('.narrow_it').click(function(){
		    $('#super_frame').animate({width:'100%'}, 500);
		    $('#footer').animate({width:'100%'}, 500);
			$(".narrow_it").hide();
			$(".wide_it").show();
			$.get('/layout.php', function(data) {
			});
		});
		$('.wide_it').click(function(){
		    $('#super_frame').animate({width:'1200px'}, 500);
		    $('#footer').animate({width:'1200px'}, 500);
			$(".wide_it").hide();
			$(".narrow_it").show();
			$.get('/layout.php', function(data) {
			});
		});
		</script>


					<script type="text/javascript"><!--
					  e9 = new Object();
					  e9.snackbar = true;
					//--></script>
					<script type="text/javascript" src="http://tags.expo9.exponential.com/tags/Pastebincom/Unsure/tags.js"></script>


<script type="text/javascript">
    (function() {
        function async_load(script_url){
            var protocol = ('https:' == document.location.protocol ? 'https://' : 'http://');
            var s = document.createElement('script'); s.src = protocol + script_url;
            var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);
        }
        bm_website_code = '2D20BDFEA765412B';
        jQuery(document).ready(function(){async_load('asset.pagefair.com/measure.min.js')});
        jQuery(document).ready(function(){async_load('asset.pagefair.net/ads.min.js')});
    })();
</script>
                        
                        
	</body>
</html>